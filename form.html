{% set performanceChunks = json_encode([]) %}
{% if mode == 'timeline' and timelineNeedsGeneration is defined and timelineNeedsGeneration == true %}
    {% include 'portfolios/timelineprogress.html' %}
{% else %}
    {% if mode == 'edit' %}
        {% set disableUser = false %}
        {% if portfolio['id'] is defined %}
            {% set portfolioId = portfolio['id'] %}
            {% set portfolioName = portfolio['name'] %}
            {% set portfolioUser = portfolio['user_id'] %}
            {% set portfolioDescription = portfolio['description'] %}
            {% set disableUser = true %}
        {% else %}
            {% set portfolio = [] %}
            {% set portfolioId = '' %}
            {% set portfolioName = '' %}
            {% set portfolioUser = '' %}
            {% set portfolioDescription = '' %}
        {% endif %}
        {% include 'portfolios/edit.html' %}
    {% else %}
        {% set portfolioColor = 'primary' %}
        {% if portfolio['status'] == 'positive' %}
            {% set portfolioColor = 'success' %}
        {% elseif portfolio['status'] == 'negative' %}
            {% set portfolioColor = 'danger' %}
        {% endif %}
        {% set portfolioId = portfolio['id'] %}
        {% set portfolioInvestedAmount = currencySymbol ~ portfolio['invested_amount'] %}
        {% set portfolioSoldAmount = currencySymbol ~ portfolio['sold_amount'] %}
        {% set portfolioReturnAmount = '<span class="text-' ~ portfolioColor ~ '">' ~ currencySymbol ~ portfolio['return_amount'] ~ '</span>' %}
        {% set portfolioTotalValue = currencySymbol ~ portfolio['total_value'] %}
        {% set portfolioProfitLoss = '<span class="text-' ~ portfolioColor ~ '">' ~ currencySymbol ~ portfolio['profit_loss'] ~ '</span>' %}
        {% set portfolioXirr = '<span class="text-' ~ portfolioColor ~ '">' ~ portfolio['xirr'] ~ '%</span>' %}
        <form data-validateon="section" id="{{componentId}}-{{sectionId}}-form">
            <fieldset id="{{componentId}}-{{sectionId}}-fieldset">
                <div class="row">
                    <div class="col">
                        {{adminltetags.useTag('fields',
                            [
                                'component'                      : component,
                                'componentName'                  : componentName,
                                'componentId'                    : componentId,
                                'sectionId'                      : sectionId,
                                'fieldId'                        : 'id',
                                'fieldLabel'                     : 'ID',
                                'fieldType'                      : 'input',
                                'fieldHelp'                      : true,
                                'fieldHelpTooltipContent'        : 'ID',
                                'fieldRequired'                  : true,
                                'fieldBazScan'                   : true,
                                'fieldBazPostOnCreate'           : false,
                                'fieldBazPostOnUpdate'           : true,
                                'fieldHidden'                    : true,
                                'fieldDisabled'                  : true,
                                'fieldValue'                     : portfolioId
                            ]
                        )}}
                    </div>
                </div>
                <div class="row vdivide">
                    <div class="col">
                        {% if mode == 'timeline' %}
                            {% include 'portfolios/timeline.html' %}
                        {% else %}
                            <div class="row">
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'portfolio_name',
                                            'fieldLabel'                     : 'Portfolio Name',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : false,
                                            'fieldHelpTooltipContent'        : 'Portfolio Name',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolio['name']
                                        ]
                                    )}}
                                </div>
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'portfolio_user',
                                            'fieldLabel'                     : 'Portfolio User',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : false,
                                            'fieldHelpTooltipContent'        : 'Portfolio User',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : users[portfolio['user_id']]['name']
                                        ]
                                    )}}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'portfolio_description',
                                            'fieldLabel'                     : 'Portfolio Description',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : false,
                                            'fieldHelpTooltipContent'        : 'Portfolio Description',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolio['description']
                                        ]
                                    )}}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    {% if mode == 'strategies' %}
                        {% include 'portfolios/strategies.html' %}
                    {% else %}
                        <div class="col">
                            <div class="row">
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'invested_amount',
                                            'fieldLabel'                     : 'Invested Amount',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'Invested Amount',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioInvestedAmount
                                        ]
                                    )}}
                                </div>
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'profit_loss',
                                            'fieldLabel'                     : 'Profit/Loss',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'Profit/Loss.',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioProfitLoss
                                        ]
                                    )}}
                                </div>
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'xirr',
                                            'fieldLabel'                     : 'Xirr',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'XIRR of portfolio',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioXirr
                                        ]
                                    )}}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'return_amount',
                                            'fieldLabel'                     : 'Return Amount',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'Return Amount.',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioReturnAmount
                                        ]
                                    )}}
                                </div>
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'sold_amount',
                                            'fieldLabel'                     : 'Sold Amount',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'Sold Amount',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioSoldAmount
                                        ]
                                    )}}
                                </div>
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'total_value',
                                            'fieldLabel'                     : 'Total value',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'Total value',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioTotalValue
                                        ]
                                    )}}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </fieldset>
        </form>
        {% if mode == 'timeline' %}
            {% set url = links.url('mf/portfolios/q/mode/timeline/id/' ~ portfolio['id']) %}
        {% elseif mode == 'transact' or mode == 'strategies' %}
            {% set url = links.url('mf/portfolios/q/mode/transact/id/' ~ portfolio['id']) %}
        {% endif %}
        {{adminltetags.useTag('buttons',
            [
                'component'                      : component,
                'componentName'                  : componentName,
                'componentId'                    : componentId,
                'sectionId'                      : sectionId,
                'buttonType'                    : 'button',
                'buttons'                       :
                    [
                        'portfolios-link'    : [
                            'title'                   : 'link',
                            'size'                    : 'xs',
                            'disabled'                : true,
                            'hidden'                  : true,
                            'url'                     : url
                        ]
                    ]
            ]
        )}}
        {% set investments = [] %}
        {% set transactions = [] %}
        {% set allocation = [] %}
        {% if mode != 'strategies' %}
            {% if portfolio['investments'] is defined and portfolio['investments']|length > 0 %}
                {% set investments = portfolio['investments'] %}
            {% endif %}
            {% if portfolio['transactions'] is defined and portfolio['transactions']|length > 0 %}
                {% set transactions = portfolio['transactions'] %}
            {% endif %}
            {% if portfolio['allocation'] is defined and portfolio['allocation']|length > 0 %}
                {% set allocation = portfolio['allocation'] %}
            {% endif %}
            <hr>
        {% endif %}
        {% if mode != 'strategies' %}
            <div class="row">
                {% set transactionButtons = [] %}
                {% set sell = false %}
                {% set recalculate = false %}
                {% set importNav = false %}
                {% if mode == 'transact' %}
                    {% if portfolio['investments']|length > 0 %}
                        {% set recalculate = true %}
                        {% for investment in portfolio['investments'] %}
                            {% if investment['status'] == 'open' %}
                                {% set sell = true %}
                                {% set importNav = true %}
                                {% break %}
                            {% endif %}
                        {% endfor %}
                        {% set transactionButtons = array_merge(transactionButtons,
                                [
                                    'timeline' : [
                                        'title'                   : 'Timeline',
                                        'size'                    : 'xs',
                                        'type'                    : 'info',
                                        'buttonAdditionalClass'   : 'contentAjaxLink',
                                        'icon'                    : 'timeline',
                                        'url'                     : links.url('mf/portfolios/q/mode/timeline/id/' ~ portfolio['id'])
                                    ]
                                ]
                            )
                        %}
                    {% endif %}
                {% elseif mode == 'timeline' %}
                    {% if portfolio['investments']|length > 0 %}
                        {% set recalculate = true %}
                    {% endif %}
                    {% set transactionButtons = array_merge(transactionButtons,
                            [
                                'transact' : [
                                    'title'                   : 'Transact',
                                    'size'                    : 'xs',
                                    'type'                    : 'primary',
                                    'buttonAdditionalClass'   : 'contentAjaxLink',
                                    'icon'                    : 'exchange-alt',
                                    'url'                     : links.url('mf/portfolios/q/id/' ~ portfolio['id'])
                                ]
                            ]
                        )
                    %}
                {% endif %}
                {% if importNav == true %}
                    {% set transactionButtons = array_merge(transactionButtons,
                            [
                                'importInvestmentNavs' : [
                                    'title'                   : 'Import Navs',
                                    'size'                    : 'xs',
                                    'position'                : 'right',
                                    'icon'                    : 'cog fa-spin',
                                    'iconHidden'              : true
                                ]
                            ]
                        )
                    %}
                {% endif %}
                {% if recalculate == true %}
                    {% set transactionButtons = array_merge(transactionButtons,
                            [
                                'recalculate' : [
                                    'title'                   : 'Recalculate',
                                    'size'                    : 'xs',
                                    'type'                    : 'info',
                                    'position'                : 'right',
                                    'icon'                    : 'cog fa-spin',
                                    'iconHidden'              : true
                                ]
                            ]
                        )
                    %}
                {% endif %}
                {% if sell == true %}
                    {% set transactionButtons = array_merge(transactionButtons,
                            [
                                'sell' : [
                                    'title'                   : 'Sell',
                                    'size'                    : 'xs',
                                    'type'                    : 'warning',
                                    'position'                : 'right'
                                ]
                            ]
                        )
                    %}
                {% endif %}
                {% if mode == 'transact' %}
                    {% set transactionButtons = array_merge(transactionButtons,
                            [
                                'buy' : [
                                    'title'                   : 'Buy',
                                    'size'                    : 'xs',
                                    'type'                    : 'success',
                                    'position'                : 'right'
                                ]
                            ]
                        )
                    %}
                {% endif %}
                <div class="col mb-2">
                    {{adminltetags.useTag('buttons',
                        [
                        'component'                     : component,
                        'componentName'                 : componentName,
                        'componentId'                   : componentId,
                        'parentComponentId'             : parent,
                        'sectionId'                     : sectionId,
                        'buttonType'                    : 'button',
                        'buttons'                       : transactionButtons
                        ]
                    )}}
                </div>
            </div>
            <hr>
        {% endif %}
        {% if mode == 'timeline' %}
            {% include 'portfolios/timelinechart.html' %}
        {% endif %}
        {% if mode != 'strategies' %}
            {% if portfolio['transactions'] is defined and portfolio['transactions']|length > 0 %}
                <div class="row">
                    <div class="col">
                        {{adminltetags.useTag('tabs',
                            [
                                'component'                     : component,
                                'componentName'                 : componentName,
                                'componentId'                   : componentId,
                                'sectionId'                     : 'main',
                                'tabsId'                        : 'tabs',
                                'tabsStyle'                     : 'card-outline-tabs',
                                'tabsData'                      :
                                    [
                                        'investments'   :
                                        [
                                            'tabTitle'          : 'Investments',
                                            'tabInclude'        : 'portfolios/form/investments'
                                        ],
                                        'transactions'   :
                                        [
                                            'tabTitle'          : 'Transactions',
                                            'tabInclude'        : 'portfolios/form/transactions'
                                        ],
                                        'allocation'   :
                                        [
                                            'tabTitle'          : 'Allocation',
                                            'tabInclude'        : 'portfolios/form/allocation'
                                        ]
                                    ]
                            ]
                        )}}
                    </div>
                </div>
            {% endif %}
            {% if mode == 'transact' %}
                <div>
                    {{adminltetags.useTag('modal',
                        [
                            'component'                 : component,
                            'componentName'             : componentName,
                            'componentId'               : componentId,
                            'sectionId'                 : sectionId,
                            'modalId'                   : 'buy-modal',
                            'modalBodyInclude'          : 'portfolios/transaction/buy',
                            'modalSize'                 : 'xl',
                            'modalType'                 : 'success',
                            'modalHeader'               : true,
                            'modalFooter'               : true,
                            'modalHeaderCloseButton'    : true,
                            'modalEscClose'             : true,
                            'modalTitle'                : currencySymbol ~ ' BUY INVESTMENT',
                            'modalFooterButtons'        :
                                [
                                'component'                     : component,
                                'componentName'                 : componentName,
                                'componentId'                   : componentId,
                                'parentComponentId'             : parent,
                                'sectionId'                     : sectionId,
                                'buttonType'                    : 'button',
                                'buttons'                       :
                                        [
                                            'buy-modal-button-save' : [
                                                'title'                   : 'buy',
                                                'type'                    : 'success',
                                                'position'                : 'right',
                                                'icon'                    : 'cog fa-spin',
                                                'iconHidden'              : true
                                            ]
                                        ]
                                ]
                        ]
                    )}}
                </div>
                <div>
                    {{adminltetags.useTag('modal',
                        [
                            'component'                 : component,
                            'componentName'             : componentName,
                            'componentId'               : componentId,
                            'sectionId'                 : sectionId,
                            'modalId'                   : 'sell-modal',
                            'modalBodyInclude'          : 'portfolios/transaction/sell',
                            'modalSize'                 : 'xl',
                            'modalType'                 : 'warning',
                            'modalHeader'               : true,
                            'modalFooter'               : true,
                            'modalHeaderCloseButton'    : true,
                            'modalEscClose'             : true,
                            'modalTitle'                : currencySymbol ~ ' SELL INVESTMENT',
                            'modalFooterButtons'        :
                                [
                                'component'                     : component,
                                'componentName'                 : componentName,
                                'componentId'                   : componentId,
                                'parentComponentId'             : parent,
                                'sectionId'                     : sectionId,
                                'buttonType'                    : 'button',
                                'buttons'                       :
                                        [
                                            'sell-modal-button-save' : [
                                                'title'                   : 'sell',
                                                'type'                    : 'warning',
                                                'position'                : 'right',
                                                'icon'                    : 'cog fa-spin',
                                                'iconHidden'              : true
                                            ]
                                        ]
                                ]
                        ]
                    )}}
                </div>
            {% endif %}
        {% elseif mode == 'strategies' %}
            <hr>
            <div id="{{componentId}}-{{sectionId}}-strategies-form">
                {% if strategy is defined and strategy != '' %}
                    {% include 'portfolios/strategies/' ~ strategy %}
                    <div id="strategies-buttons" class="row">
                        <div class="col">
                            {{adminltetags.useTag('buttons',
                                [
                                    'component'                      : component,
                                    'componentName'                  : componentName,
                                    'componentId'                    : componentId,
                                    'sectionId'                      : sectionId,
                                    'buttonType'                    : 'button',
                                    'buttons'                       :
                                        [
                                            'apply-strategy'        : [
                                                'title'                   : 'apply strategy',
                                                'type'                    : 'success',
                                                'icon'                    : 'cog fa-spin',
                                                'position'                : 'right',
                                                'iconHidden'              : true
                                            ],
                                            'view-strategy-transactions'    : [
                                                'title'                   : 'View Strategy Transactions',
                                                'icon'                    : 'eye',
                                                'type'                    : 'info'
                                            ]
                                        ]
                                ]
                            )}}
                        </div>
                    </div>
                    <div class="row" id="portfolio-access-buttons" hidden>
                        <div class="col">
                            {{adminltetags.useTag('buttons',
                                [
                                    'component'                      : component,
                                    'componentName'                  : componentName,
                                    'componentId'                    : componentId,
                                    'sectionId'                      : sectionId,
                                    'buttonType'                    : 'button',
                                    'buttons'                       :
                                        [
                                            'transact-mode'        : [
                                                'title'                   : 'Access Portfolio (Transact Mode)'
                                            ],
                                            'timeline-mode'        : [
                                                'title'                   : 'Access Portfolio (Timeline Mode)',
                                                'type'                    : 'info'
                                            ]
                                        ]
                                ]
                            )}}
                        </div>
                    </div>
                {% else %}
                    <div class="row text-center m-2" id="{{componentId}}-{{sectionId}}-strategies-noinfo">
                        <div class="col">
                            <h6><i class="fa fa-fw fa-info-circle text-info"></i> Please select strategy</h6>
                        </div>
                    </div>
                {% endif %}
                <div class="row">
                    <div class="col">
                        <div id="strategies-progress" class="mb-3 mt-3" hidden></div>
                    </div>
                </div>
            </div>
            <div>
                {{adminltetags.useTag('modal',
                    [
                        'component'                 : component,
                        'componentName'             : componentName,
                        'componentId'               : componentId,
                        'sectionId'                 : sectionId,
                        'modalId'                   : 'strategies-transactions-modal',
                        'modalBodyInclude'          : 'portfolios/strategiestransactions',
                        'modalSize'                 : 'xl',
                        'modalType'                 : 'info',
                        'modalHeader'               : true,
                        'modalFooter'               : true,
                        'modalHeaderCloseButton'    : true,
                        'modalEscClose'             : true,
                        'modalTitle'                : 'STRATEGY TRANSACTIONS'
                    ]
                )}}
            </div>
        {% endif %}
        {% set investments = escaper.js(json_encode(investments, 16)) %}
        {% set transactions = escaper.js(json_encode(transactions, 16)) %}
        {% set allocation = escaper.js(json_encode(allocation, 16)) %}
        {% set portfolio = escaper.js(json_encode(portfolio, 16)) %}
        {% set strategies = escaper.js(json_encode(strategies, 16)) %}
        {% set amcs = escaper.js(json_encode(amcs, 16)) %}
        <script>
/*global paginatedPNotify BazProgress BazContentFields BazHelpers BazContentLoader Pace BazCore dataCollection Swal Chart */
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;

if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}

dataCollectionSection =
    $.extend(dataCollectionSection, {
        '{{componentId}}-{{sectionId}}-id'                                  : { },
        '{{componentId}}-{{sectionId}}-name'                                : { },
        '{{componentId}}-{{sectionId}}-user_id'                             : {
            placeholder: "SELECT USER"
        },
        '{{componentId}}-{{sectionId}}-description'                         : { },
        '{{componentId}}-{{sectionId}}-portfolio_name'                      : { },
        '{{componentId}}-{{sectionId}}-portfolio_user'                      : { },
        '{{componentId}}-{{sectionId}}-portfolio_description'               : { },
        '{{componentId}}-{{sectionId}}-strategies'                          : {
            placeholder : "SELECT STRATEGY TO APPLY",
            afterInit: function() {
                var id;

                $('#{{componentId}}-{{sectionId}}-strategies').on('select2:select', function(e) {
                    id = e.params.data.id;

                    if (dataCollectionSectionForm['vars']['strategies'][id]) {
                        if (dataCollectionSectionForm['vars']['strategies'][id]['description'] &&
                            dataCollectionSectionForm['vars']['strategies'][id]['description'] !== ''
                        ) {
                            $('#{{componentId}}-{{sectionId}}-strategies_description').html(
                                '<small class="text-info"><i class="fa-solid fa-circle-info"></i> ' +
                                dataCollectionSectionForm['vars']['strategies'][id]['description'] +
                                '</small>'
                            );
                        } else {
                            $('#{{componentId}}-{{sectionId}}-strategies_description').html('');
                        }

                        $('#{{componentId}}-{{sectionId}}-portfolios-link')
                            .attr(
                                'href',
                                dataCollection.env.httpScheme + '://' + dataCollection.env.httpHost + '/' + dataCollection.env.appRoute + '/' +
                                'mf/portfolios/q/id/' + dataCollectionSectionForm['vars']['portfolio']['id'] + '/mode/strategies/strategy/' + id
                            );

                        dataCollectionSectionForm['funcs']['browse']();
                    } else {
                        $('#{{componentId}}-{{sectionId}}-strategies_description').html('');
                    }
                });

                $('#{{componentId}}-{{sectionId}}-apply-strategy').click(function() {
                    dataCollectionSectionForm['funcs']['applyStrategy']();
                });

                if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-strategies-transactions-table')) {
                    dataCollectionSectionForm['vars']['strategiesTransactionsTable'] = $('#{{componentId}}-{{sectionId}}-strategies-transactions-table').DataTable({
                        dom: '<"row mb-1"<"col-md-3 col-xs-12"B><"col-md-3 col-xs-12"l><"col-md-3 col-xs-12"f><"col-md-3 col-xs-12"p>>' +
                             '<"row mb-1"<"col"tr>>' +
                             '<"row"<"col-md-6 col-xs-12"i><"col-md-6 col-xs-12"p>>',
                        columns: [
                            {orderable: false},
                            {orderable: false},
                            {orderable: false},
                            {orderable: false}
                        ],
                        order: false,
                        lengthMenu: [
                            [20, 50, 100, -1],
                            [20, 50, 100, 'All']
                        ],
                        buttons: [
                            {
                                extend          : 'collection',
                                text            : 'Export',
                                className       : 'btn-sm btn-info',
                                buttons         : [{
                                                    text            : 'Excel',
                                                    title           : 'Export transactions list',
                                                    extend          : 'excelHtml5',
                                                    footer          : false,
                                                    exportOptions   : {
                                                                        columns: ':visible'
                                                                    }
                                                },
                                                {
                                                    text            : 'CSV',
                                                    extend          : 'csvHtml5',
                                                    fieldSeparator  : ',',
                                                    exportOptions   : {
                                                                        columns: ':visible'
                                                                    }
                                                }
                                                ]
                            }
                        ]
                    });
                }
                BazProgress.buildProgressBar($('#strategies-progress'), false, true, true, true);
            }
        },
        '{{componentId}}-{{sectionId}}-portfolio_timeline'                  : {
            dateFormat          : "Y-m-d",
            altFormat           : "Y-m-d",
            static              : true,
            maxDate             : "today",
            onChange: function(selectedDates, dateStr, instance) {
                if (dateStr !== '') {
                    var postData = { };
                    postData[$('#security-token').attr('name')] = $('#security-token').val();
                    postData['portfolio_id'] = $('#{{componentId}}-{{sectionId}}-id').val();
                    postData['timelineDate'] = dateStr;

                    dataCollectionSectionForm['funcs']['browseTimeline'](postData);
                }
            },
            afterInit: function() {
                dataCollectionSection['{{componentId}}-{{sectionId}}-portfolio_timeline']['flatpickr'].config.minDate = dataCollectionSectionForm['vars']['portfolio']['start_date'];
                dataCollectionSection['{{componentId}}-{{sectionId}}-portfolio_timeline']['flatpickr'].setDate(dataCollectionSectionForm['vars']['portfolio']['timelineDate']);
                dataCollectionSection['{{componentId}}-{{sectionId}}-portfolio_timeline']['flatpickr'].config.maxDate = 'today';
            }
        },
        '{{componentId}}-{{sectionId}}-portfolio_timeline_browser'          : {
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-browser-previous, #{{componentId}}-{{sectionId}}-browser-next').off();
                $('#{{componentId}}-{{sectionId}}-browser-previous, #{{componentId}}-{{sectionId}}-browser-next').click(function(e) {
                    e.preventDefault();

                    var thisButton = $(this);
                    $(thisButton).attr('disabled', true);

                    var idArr = $(this)[0].id.split('-');

                    var postData = { };
                    postData[$('#security-token').attr('name')] = $('#security-token').val();
                    postData['portfolio_id'] = $('#{{componentId}}-{{sectionId}}-id').val();
                    postData['timelineDate'] = dataCollectionSectionForm['vars']['timelineDate'];
                    postData['browse'] = $('#{{componentId}}-{{sectionId}}-portfolio_timeline_browser').val();
                    postData['jump'] = idArr[idArr.length - 1];

                    if (postData['jump'] === 'next') {
                        $(thisButton).children('i').removeClass('fa-forward').addClass('fa-spin fa-cog');
                    } else if (postData['jump'] === 'previous') {
                        $(thisButton).children('i').removeClass('fa-rewind').addClass('fa-spin fa-cog');
                    }

                    dataCollectionSectionForm['funcs']['browseTimeline'](postData, thisButton);
                });
            }
        },
        '{{componentId}}-{{sectionId}}-total_value'                         : { },
        '{{componentId}}-{{sectionId}}-invested_amount'                     : { },
        '{{componentId}}-{{sectionId}}-return_amount'                       : { },
        '{{componentId}}-{{sectionId}}-sold_amount'                         : { },
        '{{componentId}}-{{sectionId}}-profit_loss'                         : { },
        '{{componentId}}-{{sectionId}}-xirr'                                : { },
        '{{componentId}}-{{sectionId}}-transaction_id'                      : { },
        '{{componentId}}-{{sectionId}}-type'                                : {
            placeholder: "SELECT TRANSACTION TYPE"
        },
        '{{componentId}}-{{sectionId}}-amc_id'                              : {
            placeholder: "SELECT AMC",
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-amc_id').on('select2:select', function(e) {
                    $('#{{componentId}}-{{sectionId}}-scheme_id').empty().trigger('change');
                    $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', false);
                    dataCollectionSectionForm['funcs']['cleanup']();
                });
            }
        },
        '{{componentId}}-{{sectionId}}-sell_transaction_id'                 : {
            placeholder: "SELECT SCHEME TO SELL",
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-sell_transaction_id').on('select2:select', function(e) {
                    dataCollectionSectionForm['funcs']['getSchemeNav']($(e.params.data.element).data()['value'], 'sell');
                });
            }
        },
        '{{componentId}}-{{sectionId}}-scheme_id'                           : {
            placeholder: "SELECT SCHEME",
            "ajax"          : {
                url         : "{{links.url('mf/schemes/searchSchemesForAMC')}}",
                dataType    : "json",
                method      : "post",
                data: function(params) {
                    var query = { };
                    query[$('#security-token').attr('name')] = $('#security-token').val();
                    query['amc_id'] = $('#{{componentId}}-{{sectionId}}-amc_id').val();
                    query['search'] = params.term;

                    return query;
                },
                processResults: function(response) {
                    if (response.responseData.schemes) {
                        var schemesData = [];

                        for (var scheme in response.responseData.schemes) {
                            schemesData.push({
                                "id"    : response.responseData.schemes[scheme]["id"],
                                "text"  : response.responseData.schemes[scheme]["name"]
                            });
                        }

                        return {
                            results: schemesData
                        }
                    } else {
                        return {
                            results : []
                        }
                    }
                }
            },
            minimumInputLength : 3,
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-scheme_id').on('select2:select', function(e) {
                    dataCollectionSectionForm['funcs']['getSchemeNav'](e.params.data.id, 'buy');
                });
            }
        },
        '{{componentId}}-{{sectionId}}-buy-date'                            : {
            dateFormat          : "Y-m-d",
            altFormat           : "Y-m-d",
            static              : true,
            maxDate             : "today",
            onChange: function(selectedDates, dateStr, instance) {
                if (dateStr !== '') {
                    if ($('#{{componentId}}-{{sectionId}}-scheme_id').val() === '' ||
                        !$('#{{componentId}}-{{sectionId}}-scheme_id').val()
                    ) {
                        paginatedPNotify('error', {text : 'Please select scheme first'});

                        return;
                    }

                    $('#{{componentId}}-{{sectionId}}-buy-amount').attr('disabled', false);

                    if (dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-buy-date').val()] &&
                        dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-buy-date').val()]['nav']
                    ) {
                        $('#{{componentId}}-{{sectionId}}-buy-selected_nav')
                            .html(dataCollectionSectionForm['vars']['currencySymbol'] +
                                  dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-buy-date').val()]['nav']
                            );
                    } else {
                        $('#{{componentId}}-{{sectionId}}-buy-selected_nav').html('-');
                    }
                } else {
                    $('#{{componentId}}-{{sectionId}}-buy-amount').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-buy-selected_nav').html('-');
                }
            }
        },
        '{{componentId}}-{{sectionId}}-sell-date'                           : {
            dateFormat          : "Y-m-d",
            altFormat           : "Y-m-d",
            static              : true,
            maxDate             : "today",
            onChange: function(selectedDates, dateStr, instance) {
                if (dateStr !== '') {
                    if ($('#{{componentId}}-{{sectionId}}-sell_transaction_id').val() === '' ||
                        !$('#{{componentId}}-{{sectionId}}-sell_transaction_id').val()
                    ) {
                        paginatedPNotify('error', {text : 'Please select scheme first'});

                        return;
                    }

                    $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', false);
                    $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', false);
                    $('#{{componentId}}-{{sectionId}}-sell_all').attr('disabled', false);
                    if (dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav']) {
                        $('#{{componentId}}-{{sectionId}}-sell-selected_nav')
                            .html(dataCollectionSectionForm['vars']['currencySymbol'] +
                                  dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav']
                            );
                        var units = dataCollectionSectionForm['vars']['investments'][dataCollectionSectionForm['vars']['scheme']['amfi_code']]['units'];

                        $('#{{componentId}}-{{sectionId}}-sell-available_amount')
                            .html(dataCollectionSectionForm['vars']['currencySymbol'] +
                                  (dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav'] * units).toFixed(2)
                            );
                    }
                } else {
                    $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-sell_all').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-sell-selected_nav').html('-');
                }
            }
        },
        '{{componentId}}-{{sectionId}}-buy-selected_nav'                    : { },
        '{{componentId}}-{{sectionId}}-sell-selected_nav'                   : { },
        '{{componentId}}-{{sectionId}}-buy-amount'                          : { },
        '{{componentId}}-{{sectionId}}-sell-amount'                         : { },
        '{{componentId}}-{{sectionId}}-buy-calculated_units'                : { },
        '{{componentId}}-{{sectionId}}-sell-available_amount'               : { },
        '{{componentId}}-{{sectionId}}-sell-units'                          : { },
        '{{componentId}}-{{sectionId}}-sell_all'                            : {
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-sell_all').off();
                $('#{{componentId}}-{{sectionId}}-sell_all').change(function() {
                    if ($(this)[0].checked === true) {
                        $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', true);
                        $('#{{componentId}}-{{sectionId}}-sell-units').val(
                            dataCollectionSectionForm['vars']['investments'][dataCollectionSectionForm['vars']['scheme']['amfi_code']]['units']
                        );
                        $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');

                        var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav'];
                        var amount = ($('#{{componentId}}-{{sectionId}}-sell-units').val() * nav).toFixed(2);
                        $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', true);
                        $('#{{componentId}}-{{sectionId}}-sell-amount').val(amount);
                        $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
                    } else {
                        $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', false);
                        $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', false);
                        $('#{{componentId}}-{{sectionId}}-sell-units').val('');
                        $('#{{componentId}}-{{sectionId}}-sell-amount').val('');
                    }
                });
            }
        },
        '{{componentId}}-{{sectionId}}-sell-available_units'                : { },
        '{{componentId}}-{{sectionId}}-buy-amc_transaction_id'              : { },
        '{{componentId}}-{{sectionId}}-sell-amc_transaction_id'             : { },
        '{{componentId}}-{{sectionId}}-buy-amfi_code'                       : { },
        '{{componentId}}-{{sectionId}}-sell-amfi_code'                      : { },
        '{{componentId}}-{{sectionId}}-buy-isin'                            : { },
        '{{componentId}}-{{sectionId}}-sell-isin'                           : { },
        '{{componentId}}-{{sectionId}}-buy-latest_nav'                      : { },
        '{{componentId}}-{{sectionId}}-sell-latest_nav'                     : { },
        '{{componentId}}-{{sectionId}}-buy-latest_nav_date'                 : { },
        '{{componentId}}-{{sectionId}}-sell-latest_nav_date'                : { },
        '{{componentId}}-{{sectionId}}-buy-first_nav_date'                  : { },
        '{{componentId}}-{{sectionId}}-sell-first_nav_date'                 : { },
        '{{componentId}}-{{sectionId}}-buy-details'                         : { },
        '{{componentId}}-{{sectionId}}-sell-details'                        : { },
        '{{componentId}}-{{sectionId}}-transactions'                        : { },
        '{{componentId}}-{{sectionId}}-categories_percentage_variance'      : { },
        '{{componentId}}-{{sectionId}}-subcategories_percentage_variance'   : { },
        '{{componentId}}-{{sectionId}}-form' : {
            rules: {
            },
            messages: {
            }
        }
    });

if (!dataCollectionSectionForm['vars']) {
    dataCollectionSectionForm['vars'] = { };
}
if (!dataCollectionSectionForm['funcs']) {
    dataCollectionSectionForm['funcs'] = { };
}
dataCollectionSectionForm['vars']['today'] = '{{today}}';
dataCollectionSectionForm['vars']['mode'] = '{{mode}}';
dataCollectionSectionForm['vars']['portfolio'] = JSON.parse('{{portfolio}}');
dataCollectionSectionForm['vars']['strategies'] = JSON.parse('{{strategies}}');
dataCollectionSectionForm['vars']['timelineDate'] = dataCollectionSectionForm['vars']['portfolio']['timelineDate'];
dataCollectionSectionForm['vars']['investments'] = JSON.parse('{{investments}}');
dataCollectionSectionForm['vars']['transactions'] = JSON.parse('{{transactions}}');
dataCollectionSectionForm['vars']['allocation'] = JSON.parse('{{allocation}}');
dataCollectionSectionForm['vars']['allocationCharts'] = { };
dataCollectionSectionForm['vars']['amcs'] = JSON.parse('{{amcs}}');
dataCollectionSectionForm['vars']['currencySymbol'] = '{{currencySymbol}}';
dataCollectionSectionForm['vars']['sellInput'] = 'amount';
dataCollectionSectionForm['vars']['scheme'] = { };

dataCollectionSectionForm['funcs']['processTransaction'] = function(task, update = false, remove = false) {
    var postData = { };

    postData[$('#security-token').attr('name')] = $('#security-token').val();
    if (remove) {
        postData['id'] = $('#{{componentId}}-{{sectionId}}-transaction_id').val();
    } else {
        if (update) {
            postData['id'] = $('#{{componentId}}-{{sectionId}}-transaction_id').val();
        }
        postData['user_id'] = $('#{{componentId}}-{{sectionId}}-user_id').val();
        postData['portfolio_id'] = $('#{{componentId}}-{{sectionId}}-id').val();
        postData['date'] = $('#{{componentId}}-{{sectionId}}-' + task + '-date').val();

        if (task === 'sell') {
            if (dataCollectionSectionForm['vars']['sellInput'] === 'amount') {
                postData['amount'] = $('#{{componentId}}-{{sectionId}}-' + task + '-amount').val();
            } else if (dataCollectionSectionForm['vars']['sellInput'] === 'units') {
                postData['units'] = $('#{{componentId}}-{{sectionId}}-' + task + '-units').val();
            }
            postData['sell_all'] = $('#{{componentId}}-{{sectionId}}-sell_all')[0].checked;
            postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-sell_transaction_id option:selected').data()['value'];
        } else {
            postData['amc_id'] = $('#{{componentId}}-{{sectionId}}-amc_id').val();
            postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-scheme_id').val();
            postData['amount'] = $('#{{componentId}}-{{sectionId}}-' + task + '-amount').val();
            postData['status'] = 'open';
        }

        postData['amc_transaction_id'] = $('#{{componentId}}-{{sectionId}}-' + task + '-amc_transaction_id').val();
        postData['type'] = task;
        postData['details'] = $('#{{componentId}}-{{sectionId}}-' + task + '-details').val();

        if (($('#{{componentId}}-{{sectionId}}-' + task + '-amount') && $('#{{componentId}}-{{sectionId}}-' + task + '-amount').hasClass('is-invalid')) ||
            ($('#{{componentId}}-{{sectionId}}-' + task + '-units') && $('#{{componentId}}-{{sectionId}}-' + task + '-units').hasClass('is-invalid'))
        ) {
            paginatedPNotify('error', {text : 'Fix amount/units errors.'});

            return false;
        }
    }

    if (postData['date'] === '' && !remove) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-date').siblings('input').addClass('is-invalid');
        $('#{{componentId}}-{{sectionId}}-' + task + '-date').siblings('input').focus(function() {
            $(this).removeClass('is-invalid');
        });
    } else if (postData['amount'] === '' && !remove) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-amount').addClass('is-invalid');
        $('#{{componentId}}-{{sectionId}}-' + task + '-amount').focus(function() {
            $(this).removeClass('is-invalid');
        });
    } else {
        // $('#{{componentId}}-{{sectionId}}-modal-button-save').attr('disabled', true);
        // $('#{{componentId}}-{{sectionId}}-modal-button-save').children('i').attr('hidden', false);

        var url;
        if (remove) {
            url = '{{links.url("mf/transactions/remove")}}';
        } else {
            url = '{{links.url("mf/transactions/add")}}';
            if (update) {
                url = '{{links.url("mf/transactions/update")}}';
            }
        }

        $.post(url, postData, function(response) {
            if (response.tokenKey && response.token) {
                $('#security-token').attr('name', response.tokenKey);
                $('#security-token').val(response.token);
            }

            if (response.responseCode == 0) {
                paginatedPNotify('success', {text : response.responseMessage});

                if (!remove) {
                    $('#{{componentId}}-{{sectionId}}-transaction-modal').modal('hide');
                    $('.modal-backdrop').remove();
                    $('#body').removeClass('modal-open');
                }

                dataCollectionSectionForm['funcs']['browse']();
            } else {
                paginatedPNotify('error', {text : response.responseMessage});
            }

            $('#{{componentId}}-{{sectionId}}-modal-button-save').attr('disabled', false);
            $('#{{componentId}}-{{sectionId}}-modal-button-save').children('i').attr('hidden', true);
        }, 'json');
    }
}

dataCollectionSectionForm['funcs']['getSchemeNav'] = function(id, task = null, taskId = null, view = false, update = false) {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['id'] = id;

    $.post('{{links.url("mf/schemes/getSchemeNav")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }

        if (response.responseCode === 0) {
            if (response.responseData.scheme) {
                dataCollectionSectionForm['funcs']['cleanup']();
                dataCollectionSectionForm['vars']['scheme'] = response.responseData.scheme;
                dataCollectionSectionForm['funcs']['processSchemeNav'](response.responseData.scheme, task, taskId, view, update);
            } else {
                paginatedPNotify('error', {
                    text : 'Scheme data not found!'
                });
            }
        } else {
            paginatedPNotify('error', {
                text : response.responseMessage
            });

            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.minDate = '2000-01-01';
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].setDate('today');
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.maxDate = "today";
            dataCollectionSectionForm['funcs']['cleanup']();
            $('#{{componentId}}-{{sectionId}}-' + task + '-import').attr('disabled', false);
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['processSchemeNav'] = function(scheme, task = null, taskId = null, view = false, update = false) {
    if (scheme.isin) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-isin').html(scheme.isin);
    }
    if (scheme.navs && scheme.navs.latest_nav) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-latest_nav').html(
            dataCollectionSectionForm['vars']['currencySymbol'] + scheme.navs.latest_nav
        );
    }
    if (scheme.navs && scheme.navs.last_updated) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-latest_nav_date').html(scheme.navs.last_updated);
    }

    if (scheme.navs &&
        scheme.navs.navs &&
        Object.keys(scheme.navs.navs).length > 0
    ) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-first_nav_date').html(Object.keys(scheme.navs.navs)[0]);
        if (dataCollectionSectionForm['vars']['mode'] === 'transact') {
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.minDate = Object.keys(scheme.navs.navs)[0];
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.maxDate = scheme.navs.last_updated;
        }
        if (dataCollectionSectionForm['vars']['mode'] === 'strategies') {
            dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']['flatpickr'].config.minDate = Object.keys(scheme.navs.navs)[0];
            dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']['flatpickr'].config.maxDate = scheme.navs.last_updated;
            dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']['flatpickr'].config.minDate = Object.keys(scheme.navs.navs)[0];
            dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']['flatpickr'].config.maxDate = scheme.navs.last_updated;
        }
        $('#{{componentId}}-{{sectionId}}-' + task + '-import').attr('disabled', false);
    } else {
        if (dataCollectionSectionForm['vars']['mode'] === 'transact') {
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.minDate = '2000-01-01';
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].setDate('today');
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.maxDate = "today";
        }
        if (dataCollectionSectionForm['vars']['mode'] === 'strategies') {
            dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']['flatpickr'].config.minDate = '2000-01-01';
            dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']['flatpickr'].config.maxDate = "today";
            dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']['flatpickr'].config.minDate = '2000-01-01';
            dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']['flatpickr'].config.maxDate = "today";
        }
        $('#{{componentId}}-{{sectionId}}-' + task + '-import').attr('disabled', true);
    }

    if (taskId) {
        $('#{{componentId}}-{{sectionId}}-transaction_id').val(taskId);

        $('#{{componentId}}-{{sectionId}}-' + task + '-date').val(dataCollectionSectionForm['vars']['transactions'][taskId]['date']);
        dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].setDate(dataCollectionSectionForm['vars']['transactions'][taskId]['date']);
        $('#{{componentId}}-{{sectionId}}-' + task + '-amount').val(parseFloat(dataCollectionSectionForm['vars']['transactions'][taskId]['amount'].replace(/,/g, '')));

        if (dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dataCollectionSectionForm['vars']['transactions'][taskId]['date']] &&
            dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dataCollectionSectionForm['vars']['transactions'][taskId]['date']]['nav']
        ) {
            $('#{{componentId}}-{{sectionId}}-' + task + '-selected_nav')
                .html(dataCollectionSectionForm['vars']['currencySymbol'] +
                      dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dataCollectionSectionForm['vars']['transactions'][taskId]['date']]['nav']
                );
        } else {
            $('#{{componentId}}-{{sectionId}}-' + task + '-selected_nav').html('-');
        }

        $('#{{componentId}}-{{sectionId}}-' + task + '-amc_transaction_id').val(dataCollectionSectionForm['vars']['transactions'][taskId]['amc_transaction_id']);
        $('#{{componentId}}-{{sectionId}}-' + task + '-details').val(dataCollectionSectionForm['vars']['transactions'][taskId]['details']);

        if (view) {
            $('#{{componentId}}-{{sectionId}}-' + task + '-amc_transaction_id, #{{componentId}}-{{sectionId}}-' + task + '-details').attr('disabled', true);
            $('#{{componentId}}-{{sectionId}}-' + task + '-modal-button-save').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-' + task + '-import').attr('hidden', true);
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.minDate = dataCollectionSectionForm['vars']['transactions'][taskId]['date'];
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.maxDate = dataCollectionSectionForm['vars']['transactions'][taskId]['date'];
            $('#{{componentId}}-{{sectionId}}-' + task + '-amount').attr('disabled', true);
        } else {
            $('#{{componentId}}-{{sectionId}}-' + task + '-amc_transaction_id, #{{componentId}}-{{sectionId}}-' + task + '-details').attr('disabled', false);

            if (update) {
                $('#{{componentId}}-{{sectionId}}-' + task + '-amount').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-' + task + '-modal-button-save').html('UPDATE');
            } else {
                $('#{{componentId}}-{{sectionId}}-' + task + '-amount').attr('disabled', true);
            }

            $('#{{componentId}}-{{sectionId}}-' + task + '-modal-button-save').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-' + task + '-modal-button-save').off();
            $('#{{componentId}}-{{sectionId}}-' + task + '-modal-button-save').click(function(e) {
                e.preventDefault();

                dataCollectionSectionForm['funcs']['processTransaction'](task, true);
            });
        }

        if (task === 'buy') {
            dataCollectionSectionForm['funcs']['calculateBuyUnits']();
        } else if (task === 'sell') {
            dataCollectionSectionForm['funcs']['calculateSellUnits']();
            dataCollectionSectionForm['funcs']['calculateSellAmount']();
            $('#{{componentId}}-{{sectionId}}-sell-available_amount').parents('.col').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-sell-available_units').parents('.col').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-sell_all').parents('.col').attr('hidden', true);
        }

        if (dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'] &&
            Object.keys(dataCollectionSectionForm['vars']['transactions'][taskId]['transactions']).length > 0
        ) {
            var tbody = '';
            for (var transaction in dataCollectionSectionForm['vars']['transactions'][taskId]['transactions']) {
                tbody += '<tr>';
                // tbody += '   <td>';
                // tbody += '      <span id="transaction-' + taskId + '-' + dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['id'] + '">' +
                //          dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['id'] +
                //          '      </span>';
                // tbody += '   </td>';
                tbody += '   <td>';
                tbody += '      <span id="transaction-' + taskId + '-' + dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['date'] + '">' +
                         dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['date'] +
                         '      </span>';
                tbody += '   </td>';
                tbody += '   <td>';
                tbody += '      <span id="transaction-' + taskId + '-' + dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['units'] + '">' +
                         dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['units'] +
                         '      </span>';
                tbody += '   </td>';
                tbody += '   <td>';
                tbody += '      <span id="transaction-' + taskId + '-' + dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['amount'] + '">' +
                         dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['amount'] +
                         '      </span>';
                tbody += '   </td>';
                tbody += '</tr>';
            }

            $('#{{componentId}}-{{sectionId}}-' + task + '-transactions-table tbody').html(tbody);
            $('.' + task + '-transactions').children('label').html(task.toUpperCase() + ' TRANSACTIONS');
            $('#' + task + '-transactions-div').attr('hidden', false);
        }

        $('#{{componentId}}-{{sectionId}}-' + task + '-modal').modal('show');
    } else {
        if (dataCollectionSectionForm['vars']['mode'] === 'transact') {
            $('#{{componentId}}-{{sectionId}}-' + task + '-amc_transaction_id, #{{componentId}}-{{sectionId}}-' + task + '-details').attr('disabled', false);

            if (task === 'buy') {
                //
            } else if (task === 'sell') {
                $('#{{componentId}}-{{sectionId}}-sell-available_amount').html(
                    dataCollectionSectionForm['vars']['currencySymbol'] +
                    dataCollectionSectionForm['vars']['investments'][scheme['amfi_code']]['latest_value']
                );
                $('#{{componentId}}-{{sectionId}}-sell-available_units').html(
                    dataCollectionSectionForm['vars']['investments'][scheme['amfi_code']]['units']
                );
            }
        }
    }
}

dataCollectionSectionForm['funcs']['importNavs'] = function(thisButton, postData, lastNavToImport = false) {
    if (postData['scheme_id'] === '' || !postData['scheme_id']) {
        paginatedPNotify('error', 'Provide proper scheme ID. Contact developer.');

        return;
    }

    $.post('{{links.url("mf/extractdata/getAllNavData")}}', postData, function(response) {
        if ($(thisButton)[0].id !== '{{componentId}}-{{sectionId}}-importInvestmentNavs') {
            $(thisButton).removeClass('disabled');
            $(thisButton).children('i').attr('hidden', true);
        }

        if (response.responseCode == 0) {
            if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-importInvestmentNavs') {
                return;
            } else {
                paginatedPNotify('success', 'Import success. Please reselect the scheme.');
            }
        } else {
            if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-importInvestmentNavs') {
                $('#{{componentId}}-{{sectionId}}-buy, #{{componentId}}-{{sectionId}}-sell, ' +
                  '#{{componentId}}-{{sectionId}}-recalculate, .buyInvestment, .sellInvestment').attr('disabled', false);

                $('#{{componentId}}-{{sectionId}}-timeline').removeClass('disabled');

                return;
            } else {
                paginatedPNotify('error', response.responseMessage);
            }
        }

        if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-sell-import') {
            $('#{{componentId}}-{{sectionId}}-sell_transaction_id').val(0).trigger('change');
        } else {
            $('#{{componentId}}-{{sectionId}}-scheme_id').empty().trigger('change');
        }

        dataCollectionSectionForm['funcs']['cleanup']();

        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }
    }, 'json').done(function() {
        if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-importInvestmentNavs') {
            if (lastNavToImport) {
                dataCollectionSectionForm['funcs']['recalculatePortfolio']();
            }

            return;
        }
    });
}

dataCollectionSectionForm['funcs']['cleanup'] = function() {
    $('#{{componentId}}-{{sectionId}}-buy-isin').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-latest_nav').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-latest_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-first_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-amount').val('');

    $('#{{componentId}}-{{sectionId}}-sell-isin').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-latest_nav').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-latest_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-first_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-amount').val('');

    if (dataCollectionSectionForm['vars']['mode'] === 'transact' ||
        dataCollectionSectionForm['vars']['mode'] === 'timeline'
    ) {
        $('#{{componentId}}-{{sectionId}}-transaction_id').val('');
        $('#{{componentId}}-{{sectionId}}-buy-calculated_units').html('-');
        $('#{{componentId}}-{{sectionId}}-buy-amc_transaction_id').val('');
        $('#{{componentId}}-{{sectionId}}-buy-details').val('');
        $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').html('BUY');
        dataCollectionSection['{{componentId}}-{{sectionId}}-buy-date']['flatpickr'].config.minDate = '2000-01-01';
        dataCollectionSection['{{componentId}}-{{sectionId}}-buy-date']['flatpickr'].config.maxDate = 'today';
        dataCollectionSection['{{componentId}}-{{sectionId}}-buy-date']['flatpickr'].clear();
        dataCollectionSection['{{componentId}}-{{sectionId}}-sell-date']['flatpickr'].config.minDate = '2000-01-01';
        dataCollectionSection['{{componentId}}-{{sectionId}}-sell-date']['flatpickr'].config.maxDate = 'today';
        dataCollectionSection['{{componentId}}-{{sectionId}}-sell-date']['flatpickr'].clear();
        $('#{{componentId}}-{{sectionId}}-sell-units').val('');
        $('#{{componentId}}-{{sectionId}}-sell-available_amount').html('-');
        $('#{{componentId}}-{{sectionId}}-sell-available_units').html('-');
        $('#{{componentId}}-{{sectionId}}-sell-amc_transaction_id').val('');
        $('#{{componentId}}-{{sectionId}}-sell-details').val('');
        $('#{{componentId}}-{{sectionId}}-sell_all')[0].checked = false;
        $('#{{componentId}}-{{sectionId}}-sell-available_amount').parents('.col').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-sell-available_units').parents('.col').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-sell_all').parents('.col').attr('hidden', false);
        $('#buy-transactions-div').attr('hidden', true);
        $('#sell-transactions-div').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-buy-transactions-table tbody').html('');
        $('#{{componentId}}-{{sectionId}}-sell-transactions-table tbody').html('');
        $('.buy-transactions').children('label').html('TRANSACTIONS');
        $('.sell-transactions').children('label').html('TRANSACTIONS');
    }


    dataCollectionSectionForm['vars']['scheme'] = { };
}

dataCollectionSectionForm['funcs']['calculateBuyUnits'] = function() {
    if ($('#{{componentId}}-{{sectionId}}-buy-amount').val() !== '') {
        var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-buy-date').val()]['nav'];
        var units = (parseFloat($('#{{componentId}}-{{sectionId}}-buy-amount').val().replace(/,/g, '')) / nav).toFixed(3);
        $('#{{componentId}}-{{sectionId}}-buy-calculated_units').html(units);
    } else {
        $('#{{componentId}}-{{sectionId}}-buy-calculated_units').html('-');
    }
}

dataCollectionSectionForm['funcs']['calculateSellUnits'] = function() {
    if ($('#{{componentId}}-{{sectionId}}-sell-amount').val() !== '') {
        var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav'];
        var units = (parseFloat($('#{{componentId}}-{{sectionId}}-sell-amount').val().replace(/,/g, '')) / nav).toFixed(3);
        $('#{{componentId}}-{{sectionId}}-sell-units').val(units);

        if (units > dataCollectionSectionForm['vars']['investments'][dataCollectionSectionForm['vars']['scheme']['amfi_code']]['units']) {
            if ($('#{{componentId}}-{{sectionId}}-transaction_id').val() === '') {
                $('#{{componentId}}-{{sectionId}}-sell-units').addClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').addClass('is-invalid');
            } else {
                $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
            }
        } else {
            $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');
            $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
        }
    } else {
        $('#{{componentId}}-{{sectionId}}-sell-units').val('');
    }
    dataCollectionSectionForm['vars']['sellInput'] = 'amount';
}

dataCollectionSectionForm['funcs']['calculateSellAmount'] = function() {
    if ($('#{{componentId}}-{{sectionId}}-sell-units').val() !== '') {
        var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav'];
        var amount = ($('#{{componentId}}-{{sectionId}}-sell-units').val() * nav).toFixed(2);
        $('#{{componentId}}-{{sectionId}}-sell-amount').val(amount);

        if (parseFloat(amount) >
            (nav * dataCollectionSectionForm['vars']['investments'][dataCollectionSectionForm['vars']['scheme']['amfi_code']]['units']).toFixed(2)
        ) {
            if ($('#{{componentId}}-{{sectionId}}-transaction_id').val() === '') {
                $('#{{componentId}}-{{sectionId}}-sell-units').addClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').addClass('is-invalid');
            } else {
                $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
            }
        } else {
            $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');
            $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
        }
    } else {
        $('#{{componentId}}-{{sectionId}}-sell-amount').val('');
    }
    dataCollectionSectionForm['vars']['sellInput'] = 'units';
}

dataCollectionSectionForm['funcs']['enableBuySell'] = function(button) {
    if (button === 'buy' || button === 'buyInvestment') {
        if (button === 'buyInvestment') {
            $('#{{componentId}}-{{sectionId}}-buy-import').attr('disabled', true);
            $('#{{componentId}}-{{sectionId}}-buy-import').attr('hidden', true);
        } else {
            $('#{{componentId}}-{{sectionId}}-buy-import').attr('disabled', false);
            $('#{{componentId}}-{{sectionId}}-buy-import').attr('hidden', false);
        }

        $('#{{componentId}}-{{sectionId}}-buy-modal').modal('show');

        $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').off();
        $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').click(function(e) {
            e.preventDefault();

            dataCollectionSectionForm['funcs']['processTransaction']('buy');
        });
    } else if (button === 'sell' || button === 'sellInvestment') {
        if (button === 'sellInvestment') {
            $('#{{componentId}}-{{sectionId}}-sell-import').attr('disabled', true);
            $('#{{componentId}}-{{sectionId}}-sell-import').attr('hidden', true);
        } else {
            $('#{{componentId}}-{{sectionId}}-sell-import').attr('disabled', false);
            $('#{{componentId}}-{{sectionId}}-sell-import').attr('hidden', false);
        }

        $('#{{componentId}}-{{sectionId}}-sell-modal').modal('show');

        $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').off();
        $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').click(function(e) {
            e.preventDefault();

            dataCollectionSectionForm['funcs']['processTransaction']('sell');
        });
    }
}

dataCollectionSectionForm['funcs']['recalculatePortfolio'] = function() {
    var postData = { };

    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['portfolio_id'] = $('#{{componentId}}-{{sectionId}}-id').val();

    if (dataCollectionSectionForm['vars']['mode'] == 'timeline' &&
        dataCollectionSectionForm['vars']['timelineDate'] &&
        dataCollectionSectionForm['vars']['timelineDate'] !== ''
    ) {
        postData['timelineDate'] = dataCollectionSectionForm['vars']['timelineDate'];
    }

    $.post('{{links.url("mf/portfolios/recalculatePortfolio")}}', postData, function(response) {
        $('#{{componentId}}-{{sectionId}}-recalculate').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-recalculate').children('i').attr('hidden', true);

        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }

        if (response.responseCode === 0) {
            paginatedPNotify('success', {
                text : response.responseMessage
            });

            if (dataCollectionSectionForm['vars']['mode'] == 'timeline') {
                $('#{{componentId}}-{{sectionId}}-portfolios-link')
                    .attr(
                        'href',
                        dataCollection.env.httpScheme + '://' + dataCollection.env.httpHost + '/' + dataCollection.env.appRoute + '/' +
                        'mf/portfolios/q/id/' + dataCollectionSectionForm['vars']['portfolio']['id'] + '/mode/timeline/date/' +
                        dataCollectionSectionForm['vars']['timelineDate'] + '/browse/' +
                        $('#{{componentId}}-{{sectionId}}-portfolio_timeline_browser').val()
                    );
                dataCollectionSectionForm['funcs']['browse']();
            } else {
                dataCollectionSectionForm['funcs']['browse']();
            }
        } else {
            paginatedPNotify('error', {
                text : response.responseMessage
            });
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['calculateCategoriesVariance'] = function(type, mainCategory, withCategory) {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['mainCategory'] = mainCategory[5];
    postData['withCategory'] = withCategory[5];

    $.post('{{links.url("mf/categories/calculateCategoriesVariance")}}', postData, function(response) {
        if (response.responseCode == 0) {
            var html;

            if (mainCategory[5] < withCategory[5]) {
                html = '<span>Compare ' + mainCategory[1] + ' with ' + withCategory[1] + '</span>';
            } else {
                html = '<span>Compare ' + withCategory[1] + ' with ' + mainCategory[1] + '</span>';
            }

            html += ' <span class="text-bold">' + response.responseData.percentage + '</span>';

            if (type === 'categories') {
                $('#{{componentId}}-{{sectionId}}-categories_percentage_variance').html(html);
            } else {
                $('#{{componentId}}-{{sectionId}}-subcategories_percentage_variance').html(html);
            }
        } else {
            paginatedPNotify('error', response.responseMessage);
        }

        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['init'] = function() {
    var swalSound = window['dataCollection'].env.sounds.swalSound;

    function generateChart(by, data, value, type = 'bar') {
        var datasets = [
            {
                label: 'INVESTMENT',
                data: data.map(row => row['invested_' + value])
            },
            {
                label: 'RETURN',
                data: data.map(row => row['return_' + value])
            }
        ];

        if (type === 'pie') {//We want the return circle to be outside
            datasets = [
                {
                    label: 'RETURN',
                    data: data.map(row => row['return_' + value])
                },
                {
                    label: 'INVESTMENT',
                    data: data.map(row => row['invested_' + value])
                }
            ];
        }

        var labels;
        if (by === 'schemes') {
            labels = data.map(row => row.scheme_id);
        } else {
            labels = data.map(row => row.category.name);
        }
        //Start with week data and generate chart
        dataCollectionSectionForm['vars']['allocationCharts']['by_' + by][value] = new Chart(document.getElementById('allocation-' + by + '-' + value),
            {
                type: type,
                options : {
                    responsive: true,
                    animation: false,
                    plugins: {
                        legend: {
                            position : 'top'
                        },
                        title: {
                            display: true,
                            text: 'INVESTMENT vs RETURN (' + value + ')'
                        }
                    }
                },
                data: {
                    labels: labels,
                    datasets: datasets
                }
            }
        );
    }

    setTimeout(function(){
        if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-investments-table')) {
            var investmentColumns =
                [
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false}
                ];

            if (dataCollectionSectionForm['vars']['mode'] === 'timeline') {
                investmentColumns =
                    [
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false}
                    ];
            }

            $('#{{componentId}}-{{sectionId}}-investments-table').DataTable({
                columns: investmentColumns,
                order: false,
                lengthMenu: [
                    [20, 50, 100, -1],
                    [20, 50, 100, 'All']
                ]
            });
        }

        if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-transactions-table')) {
            var transactionColumns =
                [
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false}
                ];

            if (dataCollectionSectionForm['vars']['mode'] === 'timeline') {
                transactionColumns =
                    [
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false}
                    ];
            }
            $('#{{componentId}}-{{sectionId}}-transactions-table').DataTable({
                columns: transactionColumns,
                order: false,
                lengthMenu: [
                    [20, 50, 100, -1],
                    [20, 50, 100, 'All']
                ]
            });
        }

        if (Object.keys(dataCollectionSectionForm['vars']['allocation']).length > 0) {
            if (dataCollectionSectionForm['vars']['allocation']['by_schemes'] &&
                Object.keys(dataCollectionSectionForm['vars']['allocation']['by_schemes']).length > 0
            ) {
                if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-allocation-schemes-table')) {
                    $('#{{componentId}}-{{sectionId}}-allocation-schemes-table').DataTable({
                        columns: [
                            {orderable: true},
                            {orderable: true},
                            {orderable: true},
                            {orderable: true},
                            {orderable: true},
                            {orderable: true}
                        ],
                        lengthMenu: [
                            [20, 50, 100, -1],
                            [20, 50, 100, 'All']
                        ]
                    });
                }

                // var byScehemesData = [];
                // for (var schemesInitData in dataCollectionSectionForm['vars']['allocation']['by_schemes']) {
                //     byScehemesData.push(dataCollectionSectionForm['vars']['allocation']['by_schemes'][schemesInitData]);
                // }

                // (async function() {
                //     dataCollectionSectionForm['vars']['allocationCharts']['by_schemes'] = { };

                //     var byScehemesCharts = ['amount', 'percent'];

                //     $(byScehemesCharts).each(function(index, value) {
                //         //Start with week data and generate chart
                //         dataCollectionSectionForm['vars']['allocationCharts']['by_schemes'][value] = new Chart(document.getElementById('allocation-schemes-' + value),
                //             {
                //                 type: 'bar',
                //                 options : {
                //                     responsive: true,
                //                     animation: false,
                //                     plugins: {
                //                         legend: {
                //                             position: 'top'
                //                         },
                //                         title: {
                //                             display: true,
                //                             text: 'INVESTMENT vs RETURN (' + value + ')'
                //                         }
                //                     }
                //                 },
                //                 data: {
                //                     labels: byScehemesData.map(row => row.scheme_id),
                //                     datasets: [
                //                         {
                //                             label: 'INVESTMENT',
                //                             data: byScehemesData.map(row => row['invested_' + value]),
                //                         },
                //                         {
                //                             label: 'RETURN',
                //                             data: byScehemesData.map(row => row['return_' + value]),
                //                         }
                //                     ]
                //                 }
                //             }
                //         );
                //     });
                // })();

                var byScehemesData = [];
                for (var schemesInitData in dataCollectionSectionForm['vars']['allocation']['by_schemes']) {
                    byScehemesData.push(dataCollectionSectionForm['vars']['allocation']['by_schemes'][schemesInitData]);
                }

                (async function() {
                    dataCollectionSectionForm['vars']['allocationCharts']['by_schemes'] = { };

                    var bySchemesCharts = ['amount', 'percent'];

                    $(bySchemesCharts).each(function(index, value) {
                        generateChart('schemes', byScehemesData, value);
                    });

                    $('#{{componentId}}-{{sectionId}}-switch-schemes-chart').click(function() {
                        var type;

                        if ($('#{{componentId}}-{{sectionId}}-switch-schemes-chart i').hasClass('fa-chart-simple')) {
                            type = 'bar';
                            $('#{{componentId}}-{{sectionId}}-switch-schemes-chart i').removeClass('fa-chart-simple').addClass('fa-chart-pie');
                        } else if ($('#{{componentId}}-{{sectionId}}-switch-schemes-chart i').hasClass('fa-chart-pie')) {
                            type = 'pie';
                            $('#{{componentId}}-{{sectionId}}-switch-schemes-chart i').removeClass('fa-chart-pie').addClass('fa-chart-simple');
                        }

                        $(bySchemesCharts).each(function(index, value) {
                            dataCollectionSectionForm['vars']['allocationCharts']['by_schemes'][value].destroy();

                            generateChart('schemes', byScehemesData, value, type);
                        });
                    });
                })();
            }
        }

        if (Object.keys(dataCollectionSectionForm['vars']['allocation']).length > 0) {
            if (dataCollectionSectionForm['vars']['allocation']['by_categories'] &&
                Object.keys(dataCollectionSectionForm['vars']['allocation']['by_categories']).length > 0
            ) {
                if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-allocation-categories-table')) {
                    var categoriesTable = $('#{{componentId}}-{{sectionId}}-allocation-categories-table').DataTable({
                        columns: [
                            {orderable: true},
                            {orderable: true},
                            {orderable: true},
                            {orderable: true},
                            {orderable: true},
                            {orderable: true},
                            {orderable: true}
                        ],
                        lengthMenu: [
                            [20, 50, 100, -1],
                            [20, 50, 100, 'All']
                        ],
                        select: {
                            style: 'multi'
                        }
                    });

                    categoriesTable.on('select', function(e, dt, type, ix) {
                        var selected = dt.rows({selected: true});

                        if (selected.count() > 2) {
                            dt.rows(ix).deselect();
                        } else if (selected.count() === 2) {
                            var select1 = dt.rows({selected: true}).data()[0];
                            var select2 = dt.rows({selected: true}).data()[1];

                            dataCollectionSectionForm['funcs']['calculateCategoriesVariance']('categories', select1, select2);
                        }
                    });

                    categoriesTable.on('deselect', function(e, dt, type, ix) {
                        var deselected = dt.rows({selected: true});

                        if (deselected.count() > 0) {
                            $('#{{componentId}}-{{sectionId}}-categories_percentage_variance').html('Please select 2 categories...');
                        }
                    });
                }

                var byCategoriesData = [];
                for (var categoriesInitData in dataCollectionSectionForm['vars']['allocation']['by_categories']) {
                    byCategoriesData.push(dataCollectionSectionForm['vars']['allocation']['by_categories'][categoriesInitData]);
                }

                (async function() {
                    dataCollectionSectionForm['vars']['allocationCharts']['by_categories'] = { };

                    var byCategoriesCharts = ['amount', 'percent'];

                    $(byCategoriesCharts).each(function(index, value) {
                        generateChart('categories', byCategoriesData, value);
                    });

                    $('#{{componentId}}-{{sectionId}}-switch-categories-chart').click(function() {
                        var type;

                        if ($('#{{componentId}}-{{sectionId}}-switch-categories-chart i').hasClass('fa-chart-simple')) {
                            type = 'bar';
                            $('#{{componentId}}-{{sectionId}}-switch-categories-chart i').removeClass('fa-chart-simple').addClass('fa-chart-pie');
                        } else if ($('#{{componentId}}-{{sectionId}}-switch-categories-chart i').hasClass('fa-chart-pie')) {
                            type = 'pie';
                            $('#{{componentId}}-{{sectionId}}-switch-categories-chart i').removeClass('fa-chart-pie').addClass('fa-chart-simple');
                        }

                        $(byCategoriesCharts).each(function(index, value) {
                            dataCollectionSectionForm['vars']['allocationCharts']['by_categories'][value].destroy();

                            generateChart('categories', byCategoriesData, value, type);
                        });
                    });
                })();
            }
        }

        if (Object.keys(dataCollectionSectionForm['vars']['allocation']).length > 0) {
            if (dataCollectionSectionForm['vars']['allocation']['by_subcategories'] &&
                Object.keys(dataCollectionSectionForm['vars']['allocation']['by_subcategories']).length > 0
            ) {
                if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-allocation-subcategories-table')) {
                    var subcategoriesTable = $('#{{componentId}}-{{sectionId}}-allocation-subcategories-table').DataTable({
                        columns: [
                            {orderable: true},
                            {orderable: true},
                            {orderable: true},
                            {orderable: true},
                            {orderable: true},
                            {orderable: true},
                            {orderable: true}
                        ],
                        lengthMenu: [
                            [20, 50, 100, -1],
                            [20, 50, 100, 'All']
                        ],
                        select: {
                            style: 'multi'
                        }
                    });

                    subcategoriesTable.on('select', function(e, dt, type, ix) {
                        var selected = dt.rows({selected: true});

                        if (selected.count() > 2) {
                            dt.rows(ix).deselect();
                        } else if (selected.count() === 2) {
                            var select1 = dt.rows({selected: true}).data()[0];
                            var select2 = dt.rows({selected: true}).data()[1];

                            dataCollectionSectionForm['funcs']['calculateCategoriesVariance']('subcategories', select1, select2);
                        }
                    });

                    subcategoriesTable.on('deselect', function(e, dt, type, ix) {
                        var deselected = dt.rows({selected: true});

                        if (deselected.count() > 0) {
                            $('#{{componentId}}-{{sectionId}}-subcategories_percentage_variance').html('Please select 2 subcategories...');
                        }
                    });
                }

                var bySubcategoriesData = [];
                for (var subcategoriesInitData in dataCollectionSectionForm['vars']['allocation']['by_subcategories']) {
                    bySubcategoriesData.push(dataCollectionSectionForm['vars']['allocation']['by_subcategories'][subcategoriesInitData]);
                }

                (async function() {
                    dataCollectionSectionForm['vars']['allocationCharts']['by_subcategories'] = { };

                    var bySubcategoriesCharts = ['amount', 'percent'];

                    $(bySubcategoriesCharts).each(function(index, value) {
                        generateChart('subcategories', bySubcategoriesData, value);
                    });

                    $('#{{componentId}}-{{sectionId}}-switch-subcategories-chart').click(function() {
                        var type;

                        if ($('#{{componentId}}-{{sectionId}}-switch-subcategories-chart i').hasClass('fa-chart-simple')) {
                            type = 'bar';
                            $('#{{componentId}}-{{sectionId}}-switch-subcategories-chart i').removeClass('fa-chart-simple').addClass('fa-chart-pie');
                        } else if ($('#{{componentId}}-{{sectionId}}-switch-subcategories-chart i').hasClass('fa-chart-pie')) {
                            type = 'pie';
                            $('#{{componentId}}-{{sectionId}}-switch-subcategories-chart i').removeClass('fa-chart-pie').addClass('fa-chart-simple');
                        }

                        $(bySubcategoriesCharts).each(function(index, value) {
                            dataCollectionSectionForm['vars']['allocationCharts']['by_subcategories'][value].destroy();

                            generateChart('subcategories', bySubcategoriesData, value, type);
                        });
                    });
                })();
            }
        }
    }, 1000);

    $('#{{componentId}}-{{sectionId}}-buy,' +
      '#{{componentId}}-{{sectionId}}-sell'
    ).off();
    $('#{{componentId}}-{{sectionId}}-buy,' +
      '#{{componentId}}-{{sectionId}}-sell'
    ).click(function(e) {
        e.preventDefault();

        if ($(this)[0].id === '{{componentId}}-{{sectionId}}-buy') {
            dataCollectionSectionForm['funcs']['enableBuySell']('buy');
        } else if ($(this)[0].id === '{{componentId}}-{{sectionId}}-sell') {
            dataCollectionSectionForm['funcs']['enableBuySell']('sell');
        }
    });

    $('#{{componentId}}-{{sectionId}}-recalculate').off();
    $('#{{componentId}}-{{sectionId}}-recalculate').click(function(e) {
        e.preventDefault();

        // $(this).attr('disabled', true);
        $(this).children('i').attr('hidden', false);

        if (dataCollectionSectionForm['vars']['mode'] == 'timeline') {
            Swal.fire({
                html                        : '<span class="text-warning">Recalculate timeline from ' + dataCollectionSectionForm['vars']['timelineDate'] + '<span>',
                icon                        : 'question',
                background                  : 'rgba(0,0,0,.8)',
                backdrop                    : 'rgba(0,0,0,.6)',
                buttonsStyling              : false,
                confirmButtonText           : 'Proceed',
                customClass                 : {
                    'confirmButton'             : 'btn btn-warning text-uppercase',
                    'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
                },
                showCancelButton            : true,
                keydownListenerCapture      : true,
                allowOutsideClick           : true,
                allowEscapeKey              : true,
                didOpen                     : function() {
                    swalSound.play();
                }
            }).then((result) => {
                if (result.value) {
                    dataCollectionSectionForm['funcs']['recalculatePortfolio']();
                }
            });
        } else {
            dataCollectionSectionForm['funcs']['recalculatePortfolio']();
        }
    });

    $('#{{componentId}}-{{sectionId}}-buy-import, #{{componentId}}-{{sectionId}}-sell-import, #{{componentId}}-{{sectionId}}-importInvestmentNavs').off();
    $('#{{componentId}}-{{sectionId}}-buy-import, #{{componentId}}-{{sectionId}}-sell-import, #{{componentId}}-{{sectionId}}-importInvestmentNavs').click(function(e) {
        e.preventDefault();

        var thisButton = $(this);
        $(thisButton).addClass('disabled');
        $(thisButton).children('i').attr('hidden', false);

        var postData = { };
        postData[$('#security-token').attr('name')] = $('#security-token').val();
        postData['get_all_navs'] = true;

        if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-sell-import') {
            postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-sell_transaction_id option:selected').data()['value'];

            dataCollectionSectionForm['funcs']['importNavs'](thisButton, postData);
        } else if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-buy-import') {
            postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-scheme_id').val();

            dataCollectionSectionForm['funcs']['importNavs'](thisButton, postData);
        } else if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-importInvestmentNavs') {
            if (Object.keys(dataCollectionSectionForm['vars']['portfolio']['investments']).length > 0) {
                $('#{{componentId}}-{{sectionId}}-buy, #{{componentId}}-{{sectionId}}-sell, ' +
                  '#{{componentId}}-{{sectionId}}-recalculate, .buyInvestment, .sellInvestment').attr('disabled', true);

                $('#{{componentId}}-{{sectionId}}-timeline').addClass('disabled');

                var lastInvestmentToImport =
                    Object.keys(dataCollectionSectionForm['vars']['portfolio']['investments'])[Object.keys(dataCollectionSectionForm['vars']['portfolio']['investments']).length - 1];

                for (var investment in dataCollectionSectionForm['vars']['portfolio']['investments']) {
                    if (dataCollectionSectionForm['vars']['portfolio']['investments'][investment]['scheme_id']) {
                        postData['scheme_id'] = dataCollectionSectionForm['vars']['portfolio']['investments'][investment]['scheme_id'];

                        if (investment === lastInvestmentToImport) {
                            dataCollectionSectionForm['funcs']['importNavs'](thisButton, postData, true);
                        } else {
                            dataCollectionSectionForm['funcs']['importNavs'](thisButton, postData);
                        }
                    }
                }
            }
        }
    });

    $('.viewTransaction').off();
    $('.viewTransaction').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var id = idArr[idArr.length - 1];

            $('#{{componentId}}-{{sectionId}}-transaction_id').val(dataCollectionSectionForm['vars']['transactions'][id]['id']);

            if (dataCollectionSectionForm['vars']['transactions'][id]['type'] === 'buy') {
                $('#{{componentId}}-{{sectionId}}-amc_id').val(dataCollectionSectionForm['vars']['transactions'][id]['amc_id']).trigger('change');
                $('#{{componentId}}-{{sectionId}}-amc_id').attr('disabled', true);

                $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', true);
                var newOption = new Option(
                    dataCollectionSectionForm['vars']['transactions'][id]['scheme']['name'],
                    dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id'],
                    false,
                    false
                );
                $('#{{componentId}}-{{sectionId}}-scheme_id').append(newOption).val(dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id']).trigger('change');

                dataCollectionSectionForm['funcs']['getSchemeNav'](dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id'], 'buy', id, true);
            } else if (dataCollectionSectionForm['vars']['transactions'][id]['type'] === 'sell') {
                $('#{{componentId}}-{{sectionId}}-sell_transaction_id').attr('disabled', true);
                $('#{{componentId}}-{{sectionId}}-sell_transaction_id')
                    .val(dataCollectionSectionForm['vars']['investments'][dataCollectionSectionForm['vars']['transactions'][id]['amfi_code']]['id']).trigger('change');

                dataCollectionSectionForm['funcs']['getSchemeNav'](dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id'], 'sell', id, true);
            }

            $('#{{componentId}}-{{sectionId}}-details').val(dataCollectionSectionForm['vars']['transactions'][id]['details']);
        });
    });

    $('.editTransaction').off();
    $('.editTransaction').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var id = idArr[idArr.length - 1];

            if (dataCollectionSectionForm['vars']['transactions'][id] &&
                dataCollectionSectionForm['vars']['transactions'][id]['status'] === 'open' &&
                dataCollectionSectionForm['vars']['transactions'][id]['units_sold'] == 0
            ) {
                $('#{{componentId}}-{{sectionId}}-amc_id').val(dataCollectionSectionForm['vars']['transactions'][id]['amc_id']).trigger('change');
                $('#{{componentId}}-{{sectionId}}-amc_id').attr('disabled', true);

                $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', true);
                var newOption = new Option(
                    dataCollectionSectionForm['vars']['transactions'][id]['scheme']['name'],
                    dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id'],
                    false,
                    false
                );
                $('#{{componentId}}-{{sectionId}}-scheme_id').append(newOption).val(dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id']).trigger('change');

                $('#{{componentId}}-{{sectionId}}-buy-import').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-buy-import').attr('hidden', false);

                dataCollectionSectionForm['funcs']['getSchemeNav'](dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id'], 'buy', id, false, true);
            } else {
                paginatedPNotify('error', {text : 'Cannot edit closed or transaction that has units sold!'});

                return;
            }
        });
    });

    $('.removeTransaction').off();
    $('.removeTransaction').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            Swal.fire({
                title                       : '<span class="text-danger"> Remove transaction?</span>',
                icon                        : 'question',
                background                  : 'rgba(0,0,0,.8)',
                backdrop                    : 'rgba(0,0,0,.6)',
                buttonsStyling              : false,
                confirmButtonText           : 'Remove',
                customClass                 : {
                    'confirmButton'             : 'btn btn-danger text-uppercase',
                    'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
                },
                showCancelButton            : true,
                keydownListenerCapture      : true,
                allowOutsideClick           : true,
                allowEscapeKey              : true,
                didOpen                     : function() {
                    swalSound.play();
                }
            }).then((result) => {
                if (result.value) {
                    var idArr = $(this)[0].id.split('-');
                    var id = idArr[idArr.length - 1];

                    if (dataCollectionSectionForm['vars']['transactions'][id]) {
                        $('#{{componentId}}-{{sectionId}}-transaction_id').val(dataCollectionSectionForm['vars']['transactions'][id]['id']);
                    }

                    dataCollectionSectionForm['funcs']['processTransaction']('', false, true);
                }
            });
        });
    });

    $('.buyInvestment').off();
    $('.buyInvestment').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var amfi_code = idArr[idArr.length - 1];

            if (dataCollectionSectionForm['vars']['investments'][amfi_code]) {
                $('#{{componentId}}-{{sectionId}}-amc_id').val(dataCollectionSectionForm['vars']['investments'][amfi_code]['amc_id']).trigger('change');
                $('#{{componentId}}-{{sectionId}}-amc_id').attr('disabled', true);

                $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', true);
                var newOption = new Option(
                    dataCollectionSectionForm['vars']['investments'][amfi_code]['scheme']['name'],
                    dataCollectionSectionForm['vars']['investments'][amfi_code]['scheme_id'],
                    false,
                    false
                );
                $('#{{componentId}}-{{sectionId}}-scheme_id').append(newOption).val(dataCollectionSectionForm['vars']['investments'][amfi_code]['scheme_id']).trigger('change');

                dataCollectionSectionForm['funcs']['getSchemeNav'](dataCollectionSectionForm['vars']['investments'][amfi_code]['scheme_id'], 'buy', null, false, true);

                dataCollectionSectionForm['funcs']['enableBuySell']('buyInvestment');
            } else {
                paginatedPNotify('error', {text : 'Investment with ID not found!'});

                return;
            }
        });
    });

    $('.sellInvestment').off();
    $('.sellInvestment').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var amfi_code = idArr[idArr.length - 1];

            if (dataCollectionSectionForm['vars']['investments'][amfi_code]) {
                $('#{{componentId}}-{{sectionId}}-sell_transaction_id').val(dataCollectionSectionForm['vars']['investments'][amfi_code]['scheme_id']).trigger('change');
                $('#{{componentId}}-{{sectionId}}-sell_transaction_id').attr('disabled', true);

                dataCollectionSectionForm['funcs']['getSchemeNav'](dataCollectionSectionForm['vars']['investments'][amfi_code]['scheme_id'], 'sell', null, false, true);

                dataCollectionSectionForm['funcs']['enableBuySell']('sellInvestment');
            } else {
                paginatedPNotify('error', {text : 'Investment with ID not found!'});

                return;
            }
        });
    });

    $('.schemeInvestment').off();
    $('.schemeInvestment').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var schemeId = idArr[idArr.length - 1];

            window.open(dataCollection.env.httpScheme + '://' + dataCollection.env.httpHost + '/' + dataCollection.env.appRoute + '/' + 'mf/schemes/q/id/' + schemeId)
        });
    });

    $('#{{componentId}}-{{sectionId}}-buy-modal, #{{componentId}}-{{sectionId}}-sell-modal').on('hide.bs.modal', function (e) {
        $('#{{componentId}}-{{sectionId}}-amc_id').val(0).trigger('change');
        $('#{{componentId}}-{{sectionId}}-amc_id').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-scheme_id').empty().trigger('change');
        $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-sell_transaction_id').val(0).trigger('change');
        $('#{{componentId}}-{{sectionId}}-sell_transaction_id').attr('disabled', false);
        dataCollectionSectionForm['funcs']['cleanup']();
    });

    $('#{{componentId}}-{{sectionId}}-buy-amount').keyup(function() {
        dataCollectionSectionForm['funcs']['calculateBuyUnits']();
    });

    $('#{{componentId}}-{{sectionId}}-sell-amount').keyup(function() {
        dataCollectionSectionForm['funcs']['calculateSellUnits']();
    });

    $('#{{componentId}}-{{sectionId}}-sell-units').keyup(function() {
        dataCollectionSectionForm['funcs']['calculateSellAmount']();
    });
}

dataCollectionSectionForm['funcs']['browseTimeline'] = function(postData, thisButton = null) {
    $.post('{{links.url("mf/portfolios/getPortfolioTimelineDateByBrowseAction")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }

        if (response.responseCode === 0) {
            if (response.responseData.browse_date) {
                if (postData['browse']) {
                    browseToTimelineDate(response.responseData.browse_date, '/browse/' + postData['browse']);
                } else {
                    browseToTimelineDate(response.responseData.browse_date);
                }
            }
        } else if (response.responseCode === 2) {
            var swalSound = window['dataCollection'].env.sounds.swalSound;
            var swalTitle = '<span class="text-warning">' + response.responseMessage + '</span>';
            var swalHtml;
            if (response.responseData.start_date) {
                swalHtml = '<span class="text-info">Portfolio starts at ' + response.responseData.start_date + '</span>';
            } else if (response.responseData.end_date) {
                swalHtml = '<span class="text-info">Portfolio ends at ' + response.responseData.end_date + '</span>';
            } else if (response.responseData.transaction_end_date) {
                swalHtml = '<span class="text-info">Portfolio transactions end at ' + response.responseData.transaction_end_date + '</span>';
            }
            Swal.fire({
                title                       : swalTitle,
                html                        : swalHtml,
                icon                        : 'warning',
                background                  : 'rgba(0,0,0,.8)',
                backdrop                    : 'rgba(0,0,0,.6)',
                buttonsStyling              : false,
                confirmButtonText           : 'Browse',
                customClass                 : {
                    'confirmButton'             : 'btn btn-info text-uppercase',
                    'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
                },
                showCancelButton            : true,
                keydownListenerCapture      : true,
                allowOutsideClick           : true,
                allowEscapeKey              : true,
                didOpen                     : function() {
                    swalSound.play();
                }
            }).then((result) => {
                if (result.value) {
                    var dateToBrowse;

                    if (response.responseData.start_date) {
                        dateToBrowse = response.responseData.start_date;
                    } else if (response.responseData.end_date) {
                        dateToBrowse = response.responseData.end_date;
                    } else if (response.responseData.transaction_end_date) {
                        dateToBrowse = response.responseData.transaction_end_date;
                    }

                    browseToTimelineDate(dateToBrowse);
                } else {
                    if (thisButton) {
                        $(thisButton).attr('disabled', false);

                        if (postData['jump'] === 'next') {
                            $(thisButton).children('i').removeClass('fa-spin fa-cog').addClass('fa-forward');
                        } else if (postData['jump'] === 'previous') {
                            $(thisButton).children('i').removeClass('fa-spin fa-cog').addClass('fa-rewind');
                        }
                    }
                }
            });
        } else {
            paginatedPNotify('error', {
                text : response.responseMessage
            });
        }
    }, 'json');
}

function browseToTimelineDate(dateToBrowse, additionalUrlString = '/') {
    $('#{{componentId}}-{{sectionId}}-portfolios-link')
        .attr(
            'href',
            dataCollection.env.httpScheme + '://' + dataCollection.env.httpHost + '/' + dataCollection.env.appRoute + '/' +
            'mf/portfolios/q/id/' + dataCollectionSectionForm['vars']['portfolio']['id'] + '/mode/timeline/date/' +
            dateToBrowse +
            additionalUrlString
        );

    dataCollectionSectionForm['funcs']['browse']();
}

dataCollectionSectionForm['funcs']['browse'] = function() {
    BazContentLoader.loadAjax($('#{{componentId}}-{{sectionId}}-portfolios-link'), {
        ajaxBefore                      : function () {
                                            Pace.restart();
                                            $("#baz-content").empty();
                                            $("#loader").attr('hidden', false);
                                        },
        ajaxFinished                    : function () {
                                            BazCore.updateBreadcrumb();
                                            $("#loader").attr('hidden', true);
                                        },
        ajaxError                       : function () {
                                            $("#loader").attr('hidden', true);
                                            BazCore.updateBreadcrumb();
                                        }
    });
}

dataCollectionSectionForm['funcs']['initChart'] = function() {
    dataCollectionSectionForm['vars']['performance_chunks'] = JSON.parse('{{performanceChunks}}');
    if (dataCollectionSectionForm['vars']['performance_chunks'].length === 0) {
        return;
    }
    dataCollectionSectionForm['vars']['actions'] = { };
    dataCollectionSectionForm['vars']['timelineChart'] = { };
    dataCollectionSectionForm['vars']['initData'] = [];
    dataCollectionSectionForm['vars']['initPerformanceData'] = { };
    dataCollectionSectionForm['vars']['weekData'] = [];
    dataCollectionSectionForm['vars']['weekPerformanceData'] = { };
    dataCollectionSectionForm['vars']['monthData'] = [];
    dataCollectionSectionForm['vars']['monthPerformanceData'] = { };
    dataCollectionSectionForm['vars']['yearData'] = [];
    dataCollectionSectionForm['vars']['yearPerformanceData'] = { };
    dataCollectionSectionForm['vars']['threeYearData'] = [];
    dataCollectionSectionForm['vars']['threeYearPerformanceData'] = { };
    dataCollectionSectionForm['vars']['fiveYearData'] = [];
    dataCollectionSectionForm['vars']['fiveYearPerformanceData'] = { };
    dataCollectionSectionForm['vars']['tenYearData'] = [];
    dataCollectionSectionForm['vars']['tenYearPerformanceData'] = { };
    dataCollectionSectionForm['vars']['allData'] = [];
    dataCollectionSectionForm['vars']['allPerformanceData'] = { };
    dataCollectionSectionForm['vars']['dataType'] = 'invested_return_amount';
    dataCollectionSectionForm['vars']['timeline'] = 'week';

    (async function() {
        var initDataObj;
        var dataSets = [];

        initDataObj = dataCollectionSectionForm['vars']['performance_chunks']['all'];

        for (var initData in initDataObj) {
            dataCollectionSectionForm['vars']['initPerformanceData'] = { };
            dataCollectionSectionForm['vars']['initPerformanceData']['date'] = initData;
            dataCollectionSectionForm['vars']['initPerformanceData']['invested_amount'] = initDataObj[initData]['invested_amount'];
            dataCollectionSectionForm['vars']['initPerformanceData']['return_amount'] = initDataObj[initData]['return_amount'];

            dataCollectionSectionForm['vars']['initData'].push(dataCollectionSectionForm['vars']['initPerformanceData']);
        }

        if (dataCollectionSectionForm['vars']['performance_chunks']['week']) {
            dataCollectionSectionForm['vars']['actions']['one-week'] =
                {
                    name: "1 WEEK",
                    handler(chart) {
                        for (var weekDate in dataCollectionSectionForm['vars']['performance_chunks']['week']) {
                            dataCollectionSectionForm['vars']['weekPerformanceData'] = { };
                            dataCollectionSectionForm['vars']['weekPerformanceData']['date'] = weekDate;
                            if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                                dataCollectionSectionForm['vars']['weekPerformanceData']['invested_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['week'][weekDate]['invested_amount'];
                                dataCollectionSectionForm['vars']['weekPerformanceData']['return_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['week'][weekDate]['return_amount'];
                            } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                                dataCollectionSectionForm['vars']['weekPerformanceData'][dataCollectionSectionForm['vars']['dataType']] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['week'][weekDate][dataCollectionSectionForm['vars']['dataType']];
                            }

                            dataCollectionSectionForm['vars']['weekData'].push(dataCollectionSectionForm['vars']['weekPerformanceData']);
                        }

                        dataSets = [];
                        if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                            dataSets =
                                [
                                    {
                                        label: 'INVESTED AMOUNT',
                                        data: dataCollectionSectionForm['vars']['weekData'].map(row => row['invested_amount']),
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'RETURN AMOUNT',
                                        data: dataCollectionSectionForm['vars']['weekData'].map(row => row['return_amount']),
                                        pointRadius: 0
                                    }
                                ]

                        } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                            dataSets =
                                [
                                    {
                                        label: 'PROFIT/LOSS (WEEK)',
                                        data: dataCollectionSectionForm['vars']['weekData'].map(row => row[dataCollectionSectionForm['vars']['dataType']]),
                                        pointRadius: 0
                                    }
                                ];
                        }

                        chart.data.labels = dataCollectionSectionForm['vars']['weekData'].map(row => row.date);
                        chart.data.datasets = dataSets;
                        chart.update();
                    }
                };
        }

        if (dataCollectionSectionForm['vars']['performance_chunks']['month']) {
            dataCollectionSectionForm['vars']['actions']['one-month'] =
                {
                    name: "1 MONTH",
                    handler(chart) {
                        for (var monthDate in dataCollectionSectionForm['vars']['performance_chunks']['month']) {
                            dataCollectionSectionForm['vars']['monthPerformanceData'] = { };
                            dataCollectionSectionForm['vars']['monthPerformanceData']['date'] = monthDate;
                            if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                                dataCollectionSectionForm['vars']['monthPerformanceData']['invested_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['month'][monthDate]['invested_amount'];
                                dataCollectionSectionForm['vars']['monthPerformanceData']['return_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['month'][monthDate]['return_amount'];
                            } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                                dataCollectionSectionForm['vars']['monthPerformanceData'][dataCollectionSectionForm['vars']['dataType']] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['month'][monthDate][dataCollectionSectionForm['vars']['dataType']];
                            }

                            dataCollectionSectionForm['vars']['monthData'].push(dataCollectionSectionForm['vars']['monthPerformanceData']);
                        }

                        dataSets = [];
                        if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                            dataSets =
                                [
                                    {
                                        label: 'INVESTED AMOUNT',
                                        data: dataCollectionSectionForm['vars']['monthData'].map(row => row['invested_amount']),
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'RETURN AMOUNT',
                                        data: dataCollectionSectionForm['vars']['monthData'].map(row => row['return_amount']),
                                        pointRadius: 0
                                    }
                                ]

                        } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                            dataSets =
                                [
                                    {
                                        label: 'PROFIT/LOSS (MONTH)',
                                        data: dataCollectionSectionForm['vars']['monthData'].map(row => row[dataCollectionSectionForm['vars']['dataType']]),
                                        pointRadius: 0
                                    }
                                ];
                        }

                        chart.data.labels = dataCollectionSectionForm['vars']['monthData'].map(row => row.date);
                        chart.data.datasets = dataSets;
                        chart.update();
                    }
                };
        }

        if (dataCollectionSectionForm['vars']['performance_chunks']['year']) {
            dataCollectionSectionForm['vars']['actions']['one-year'] =
                {
                    name: "1 YEAR",
                    handler(chart) {
                        for (var yearDate in dataCollectionSectionForm['vars']['performance_chunks']['year']) {
                            dataCollectionSectionForm['vars']['yearPerformanceData'] = { };
                            dataCollectionSectionForm['vars']['yearPerformanceData']['date'] = yearDate;
                            if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                                dataCollectionSectionForm['vars']['yearPerformanceData']['invested_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['year'][yearDate]['invested_amount'];
                                dataCollectionSectionForm['vars']['yearPerformanceData']['return_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['year'][yearDate]['return_amount'];
                            } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                                dataCollectionSectionForm['vars']['yearPerformanceData'][dataCollectionSectionForm['vars']['dataType']] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['year'][yearDate][dataCollectionSectionForm['vars']['dataType']];
                            }

                            dataCollectionSectionForm['vars']['yearData'].push(dataCollectionSectionForm['vars']['yearPerformanceData']);
                        }

                        dataSets = [];
                        if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                            dataSets =
                                [
                                    {
                                        label: 'INVESTED AMOUNT',
                                        data: dataCollectionSectionForm['vars']['yearData'].map(row => row['invested_amount']),
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'RETURN AMOUNT',
                                        data: dataCollectionSectionForm['vars']['yearData'].map(row => row['return_amount']),
                                        pointRadius: 0
                                    }
                                ]

                        } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                            dataSets =
                                [
                                    {
                                        label: 'PROFIT/LOSS (YEAR)',
                                        data: dataCollectionSectionForm['vars']['yearData'].map(row => row[dataCollectionSectionForm['vars']['dataType']]),
                                        pointRadius: 0
                                    }
                                ];
                        }

                        chart.data.labels = dataCollectionSectionForm['vars']['yearData'].map(row => row.date);
                        chart.data.datasets = dataSets;
                        chart.update();
                    }
                };
        }

        if (dataCollectionSectionForm['vars']['performance_chunks']['threeYear']) {
            dataCollectionSectionForm['vars']['actions']['three-year'] =
                {
                    name: "3 YEARS",
                    handler(chart) {
                        for (var threeYearDate in dataCollectionSectionForm['vars']['performance_chunks']['threeYear']) {
                            dataCollectionSectionForm['vars']['threeYearPerformanceData'] = { };
                            dataCollectionSectionForm['vars']['threeYearPerformanceData']['date'] = threeYearDate;
                            if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                                dataCollectionSectionForm['vars']['threeYearPerformanceData']['invested_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['threeYear'][threeYearDate]['invested_amount'];
                                dataCollectionSectionForm['vars']['threeYearPerformanceData']['return_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['threeYear'][threeYearDate]['return_amount'];
                            } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                                dataCollectionSectionForm['vars']['threeYearPerformanceData'][dataCollectionSectionForm['vars']['dataType']] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['threeYear'][threeYearDate][dataCollectionSectionForm['vars']['dataType']];
                            }

                            dataCollectionSectionForm['vars']['threeYearData'].push(dataCollectionSectionForm['vars']['threeYearPerformanceData']);
                        }

                        dataSets = [];
                        if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                            dataSets =
                                [
                                    {
                                        label: 'INVESTED AMOUNT',
                                        data: dataCollectionSectionForm['vars']['threeYearData'].map(row => row['invested_amount']),
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'RETURN AMOUNT',
                                        data: dataCollectionSectionForm['vars']['threeYearData'].map(row => row['return_amount']),
                                        pointRadius: 0
                                    }
                                ]

                        } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                            dataSets =
                                [
                                    {
                                        label: 'PROFIT/LOSS (3 YEARS)',
                                        data: dataCollectionSectionForm['vars']['threeYearData'].map(row => row[dataCollectionSectionForm['vars']['dataType']]),
                                        pointRadius: 0
                                    }
                                ];
                        }

                        chart.data.labels = dataCollectionSectionForm['vars']['threeYearData'].map(row => row.date);
                        chart.data.datasets = dataSets;
                        chart.update();
                    }
                };
        }

        if (dataCollectionSectionForm['vars']['performance_chunks']['fiveYear']) {
            dataCollectionSectionForm['vars']['actions']['five-year'] =
                {
                    name: "5 YEARS",
                    handler(chart) {
                        for (var fiveYearDate in dataCollectionSectionForm['vars']['performance_chunks']['fiveYear']) {
                            dataCollectionSectionForm['vars']['fiveYearPerformanceData'] = { };
                            dataCollectionSectionForm['vars']['fiveYearPerformanceData']['date'] = fiveYearDate;
                            if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                                dataCollectionSectionForm['vars']['fiveYearPerformanceData']['invested_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['fiveYear'][fiveYearDate]['invested_amount'];
                                dataCollectionSectionForm['vars']['fiveYearPerformanceData']['return_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['fiveYear'][fiveYearDate]['return_amount'];
                            } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                                dataCollectionSectionForm['vars']['fiveYearPerformanceData'][dataCollectionSectionForm['vars']['dataType']] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['fiveYear'][fiveYearDate][dataCollectionSectionForm['vars']['dataType']];
                            }

                            dataCollectionSectionForm['vars']['fiveYearData'].push(dataCollectionSectionForm['vars']['fiveYearPerformanceData']);
                        }

                        dataSets = [];
                        if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                            dataSets =
                                [
                                    {
                                        label: 'INVESTED AMOUNT',
                                        data: dataCollectionSectionForm['vars']['fiveYearData'].map(row => row['invested_amount']),
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'RETURN AMOUNT',
                                        data: dataCollectionSectionForm['vars']['fiveYearData'].map(row => row['return_amount']),
                                        pointRadius: 0
                                    }
                                ]

                        } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                            dataSets =
                                [
                                    {
                                        label: 'PROFIT/LOSS (5 YEARS)',
                                        data: dataCollectionSectionForm['vars']['fiveYearData'].map(row => row[dataCollectionSectionForm['vars']['dataType']]),
                                        pointRadius: 0
                                    }
                                ];
                        }

                        chart.data.labels = dataCollectionSectionForm['vars']['fiveYearData'].map(row => row.date);
                        chart.data.datasets = dataSets;
                        chart.update();
                    }
                };
        }

        if (dataCollectionSectionForm['vars']['performance_chunks']['tenYear']) {
            dataCollectionSectionForm['vars']['actions']['ten-year'] =
                {
                    name: "10 YEARS",
                    handler(chart) {
                        for (var tenYearDate in dataCollectionSectionForm['vars']['performance_chunks']['tenYear']) {
                            dataCollectionSectionForm['vars']['tenYearPerformanceData'] = { };
                            dataCollectionSectionForm['vars']['tenYearPerformanceData']['date'] = tenYearDate;
                            if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                                dataCollectionSectionForm['vars']['tenYearPerformanceData']['invested_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['tenYear'][tenYearDate]['invested_amount'];
                                dataCollectionSectionForm['vars']['tenYearPerformanceData']['return_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['tenYear'][tenYearDate]['return_amount'];
                            } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                                dataCollectionSectionForm['vars']['tenYearPerformanceData'][dataCollectionSectionForm['vars']['dataType']] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['tenYear'][tenYearDate][dataCollectionSectionForm['vars']['dataType']];
                            }

                            dataCollectionSectionForm['vars']['tenYearData'].push(dataCollectionSectionForm['vars']['tenYearPerformanceData']);
                        }

                        dataSets = [];
                        if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                            dataSets =
                                [
                                    {
                                        label: 'INVESTED AMOUNT',
                                        data: dataCollectionSectionForm['vars']['tenYearData'].map(row => row['invested_amount']),
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'RETURN AMOUNT',
                                        data: dataCollectionSectionForm['vars']['tenYearData'].map(row => row['return_amount']),
                                        pointRadius: 0
                                    }
                                ]

                        } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                            dataSets =
                                [
                                    {
                                        label: 'PROFIT/LOSS (10 YEARS)',
                                        data: dataCollectionSectionForm['vars']['tenYearData'].map(row => row[dataCollectionSectionForm['vars']['dataType']]),
                                        pointRadius: 0
                                    }
                                ];
                        }

                        chart.data.labels = dataCollectionSectionForm['vars']['tenYearData'].map(row => row.date);
                        chart.data.datasets = dataSets;
                        chart.update();
                    }
                };
        }

        if (dataCollectionSectionForm['vars']['performance_chunks']['all']) {
            dataCollectionSectionForm['vars']['actions']['all'] =
                {
                    name: "ALL",
                    handler(chart) {
                        for (var allDate in dataCollectionSectionForm['vars']['performance_chunks']['all']) {
                            dataCollectionSectionForm['vars']['allPerformanceData'] = { };
                            dataCollectionSectionForm['vars']['allPerformanceData']['date'] = allDate;
                            if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                                dataCollectionSectionForm['vars']['allPerformanceData']['invested_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['all'][allDate]['invested_amount'];
                                dataCollectionSectionForm['vars']['allPerformanceData']['return_amount'] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['all'][allDate]['return_amount'];
                            } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                                dataCollectionSectionForm['vars']['allPerformanceData'][dataCollectionSectionForm['vars']['dataType']] =
                                    dataCollectionSectionForm['vars']['performance_chunks']['all'][allDate][dataCollectionSectionForm['vars']['dataType']];
                            }

                            dataCollectionSectionForm['vars']['allData'].push(dataCollectionSectionForm['vars']['allPerformanceData']);
                        }

                        dataSets = [];
                        if (dataCollectionSectionForm['vars']['dataType'] === 'invested_return_amount') {
                            dataSets =
                                [
                                    {
                                        label: 'INVESTED AMOUNT',
                                        data: dataCollectionSectionForm['vars']['allData'].map(row => row['invested_amount']),
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'RETURN AMOUNT',
                                        data: dataCollectionSectionForm['vars']['allData'].map(row => row['return_amount']),
                                        pointRadius: 0
                                    }
                                ]

                        } else if (dataCollectionSectionForm['vars']['dataType'] === 'profit_loss') {
                            dataSets =
                                [
                                    {
                                        label: 'PROFIT/LOSS (ALL)',
                                        data: dataCollectionSectionForm['vars']['allData'].map(row => row[dataCollectionSectionForm['vars']['dataType']]),
                                        pointRadius: 0
                                    }
                                ];
                        }

                        chart.data.labels = dataCollectionSectionForm['vars']['allData'].map(row => row.date);
                        chart.data.datasets = dataSets;
                        chart.update();
                    }
                };
        }

        //Start with week data and generate chart
        dataCollectionSectionForm['vars']['timelineChart'] = new Chart(document.getElementById('timelineChart'),
            {
                type: 'line',
                options : {
                    animation: false,
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    }
                },
                data: {
                    labels: dataCollectionSectionForm['vars']['initData'].map(row => row.date),
                    datasets: [
                        {
                            label: 'INVESTED AMOUNT',
                            data: dataCollectionSectionForm['vars']['initData'].map(row => row['invested_amount']),
                            pointRadius: 0
                        },
                        {
                            label: 'RETURN AMOUNT',
                            data: dataCollectionSectionForm['vars']['initData'].map(row => row['return_amount']),
                            pointRadius: 0
                        }
                    ]
                },
                plugins : [
                    {
                        afterRender: function(chart, options) {
                            $('#timeline-buttons').attr('hidden', false);
                            $('#datatype-buttons').attr('hidden', false);
                            $('#timeline-loader').attr('hidden', true);
                            $('#import-loader').attr('hidden', true);
                            $('#timeline-chart').attr('hidden', false);
                        }
                    }
                ]
            }
        );
    })();

    //Activate All button
    var timelineChecked = $("input[type='radio'][name='timeline']:checked");
    var timelineTimeline = $(timelineChecked).data('value');
    var timelineLabels = $(timelineChecked).parents('.btn-group').children('label');
    $(timelineLabels).each(function(index, timelineLabel) {
        $(timelineLabel).removeClass('focus active disabled');
        $(timelineLabel).css('cursor', 'pointer');

        if ($(timelineLabel).children('input')[0].id === timelineTimeline) {
            $(timelineLabel).addClass('focus active disabled');
            $(timelineLabel).css('cursor', 'default');
        }
    });

    $("input[type='radio'][name='timeline']:checked").parents('.btn-group').children('label').children('input').off();
    $("input[type='radio'][name='timeline']:checked").parents('.btn-group').children('label').children('input').click(function() {
        timelineChecked = $("input[type='radio'][name='timeline']:checked");
        timelineTimeline = $(timelineChecked).data('value');
        timelineLabels = $(timelineChecked).parents('.btn-group').children('label');

        $(timelineLabels).each(function(index, timelineLabel) {
            $(timelineLabel).removeClass('focus active disabled');
            $(timelineLabel).css('cursor', 'pointer');

            if ($(timelineLabel).children('input')[0].id === timelineTimeline) {
                $(timelineLabel).addClass('focus active disabled');
                $(timelineLabel).css('cursor', 'default');
            }
        });

        if (timelineTimeline === 'one-week') {
            dataCollectionSectionForm['vars']['weekData'] = [];
            dataCollectionSectionForm['vars']['weekPerformanceData'] = { };
        } else if (timelineTimeline === 'one-month') {
            dataCollectionSectionForm['vars']['monthData'] = [];
            dataCollectionSectionForm['vars']['monthPerformanceData'] = { };
        } else if (timelineTimeline === 'one-year') {
            dataCollectionSectionForm['vars']['yearData'] = [];
            dataCollectionSectionForm['vars']['yearPerformanceData'] = { };
        } else if (timelineTimeline === 'three-year') {
            dataCollectionSectionForm['vars']['threeYearData'] = [];
            dataCollectionSectionForm['vars']['threeYearPerformanceData'] = { };
        } else if (timelineTimeline === 'five-year') {
            dataCollectionSectionForm['vars']['fiveYearData'] = [];
            dataCollectionSectionForm['vars']['fiveYearPerformanceData'] = { };
        } else if (timelineTimeline === 'ten-year') {
            dataCollectionSectionForm['vars']['tenYearData'] = [];
            dataCollectionSectionForm['vars']['tenYearPerformanceData'] = { };
        } else if (timelineTimeline === 'all') {
            dataCollectionSectionForm['vars']['allData'] = [];
            dataCollectionSectionForm['vars']['allPerformanceData'] = { };
        }

        dataCollectionSectionForm['vars']['actions'][timelineTimeline].handler(dataCollectionSectionForm['vars']['timelineChart']);
    });

    //Activate Return Amount button
    var datatypeChecked = $("input[type='radio'][name='datatype']:checked");
    var datatypeDatatype = $(datatypeChecked).data('value');
    var datatypeLabels = $(datatypeChecked).parents('.btn-group').children('label');
    $(datatypeLabels).each(function(index, datatypeLabel) {
        $(datatypeLabel).removeClass('focus active disabled');
        $(datatypeLabel).css('cursor', 'pointer');

        if ($(datatypeLabel).children('input')[0].id === datatypeDatatype) {
            $(datatypeLabel).addClass('focus active disabled');
            $(datatypeLabel).css('cursor', 'default');
        }
    });

    $("input[type='radio'][name='datatype']:checked").parents('.btn-group').children('label').children('input').off();
    $("input[type='radio'][name='datatype']:checked").parents('.btn-group').children('label').children('input').click(function() {
        datatypeChecked = $("input[type='radio'][name='datatype']:checked");
        datatypeDatatype = $(datatypeChecked).data('value');
        datatypeLabels = $(datatypeChecked).parents('.btn-group').children('label');

        $(datatypeLabels).each(function(index, datatypeLabel) {
            $(datatypeLabel).removeClass('focus active disabled');
            $(datatypeLabel).css('cursor', 'pointer');

            if ($(datatypeLabel).children('input')[0].id === datatypeDatatype) {
                $(datatypeLabel).addClass('focus active disabled');
                $(datatypeLabel).css('cursor', 'default');
            }
        });

        dataCollectionSectionForm['vars']['dataType'] = datatypeDatatype;

        $($("input[type='radio'][name='timeline']:checked").parents('.btn-group').children('label')).each(function(index, label) {
            if ($(label).hasClass('active')) {
                timelineTimeline = $(label).children('input').data('value');
            }
        });

        if (timelineTimeline === 'one-week') {
            dataCollectionSectionForm['vars']['weekData'] = [];
            dataCollectionSectionForm['vars']['weekPerformanceData'] = { };
        } else if (timelineTimeline === 'one-month') {
            dataCollectionSectionForm['vars']['monthData'] = [];
            dataCollectionSectionForm['vars']['monthPerformanceData'] = { };
        } else if (timelineTimeline === 'one-year') {
            dataCollectionSectionForm['vars']['yearData'] = [];
            dataCollectionSectionForm['vars']['yearPerformanceData'] = { };
        } else if (timelineTimeline === 'three-year') {
            dataCollectionSectionForm['vars']['threeYearData'] = [];
            dataCollectionSectionForm['vars']['threeYearPerformanceData'] = { };
        } else if (timelineTimeline === 'five-year') {
            dataCollectionSectionForm['vars']['fiveYearData'] = [];
            dataCollectionSectionForm['vars']['fiveYearPerformanceData'] = { };
        } else if (timelineTimeline === 'ten-year') {
            dataCollectionSectionForm['vars']['tenYearData'] = [];
            dataCollectionSectionForm['vars']['tenYearPerformanceData'] = { };
        } else if (timelineTimeline === 'all') {
            dataCollectionSectionForm['vars']['allData'] = [];
            dataCollectionSectionForm['vars']['allPerformanceData'] = { };
        }

        dataCollectionSectionForm['vars']['actions'][timelineTimeline].handler(dataCollectionSectionForm['vars']['timelineChart']);
    });
}

$(document).ready(function() {
    dataCollectionSectionForm['funcs']['init']();
    if (dataCollectionSectionForm['vars']['mode'] === 'timeline' ) {
        dataCollectionSectionForm['funcs']['initChart']();
    }
});
</script>
    {% endif %}
{% endif %}