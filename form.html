{% set performanceChunks = json_encode([]) %}
{% if mode == 'timeline' and timelineNeedsGeneration is defined and timelineNeedsGeneration == true %}
    {% include 'portfolios/timelineprogress.html' %}
{% else %}
    {% if mode == 'edit' %}
        {% set disableUser = false %}
        {% set disableInvestmentSource = false %}
        {% set accountingDivHidden = 'hidden' %}
        {% set userBooksArr = [] %}
        {% set bookAccountsArr = [] %}
        {% if portfolio['id'] is defined %}
            {% set portfolioId = portfolio['id'] %}
            {% set portfolioName = portfolio['name'] %}
            {% set portfolioUser = portfolio['user_id'] %}
            {% set portfolioInvestmentSource = portfolio['investment_source'] %}
            {% if portfolioInvestmentSource == 'accounting' %}
                {% set accountingDivHidden = '' %}
                {% set userBooksArr = userBooks %}
                {% set bookAccountsArr = userBooks[portfolio['book_id']]['accounts'] %}
            {% endif %}
            {% set portfolioBookId = portfolio['book_id'] %}
            {% set portfolioWithdrawAccountId = portfolio['withdraw_bankaccount_id'] %}
            {% set portfolioDepositAccountId = portfolio['deposit_bankaccount_id'] %}
            {% set portfolioDescription = portfolio['description'] %}
            {% set disableUser = true %}
            {% set disableInvestmentSource = true %}
        {% else %}
            {% set portfolio = [] %}
            {% set portfolioId = '' %}
            {% set portfolioName = '' %}
            {% set portfolioUser = '' %}
            {% set portfolioInvestmentSource = '' %}
            {% set portfolioBookId = '' %}
            {% set portfolioWithdrawAccountId = '' %}
            {% set portfolioDepositAccountId = '' %}
            {% set portfolioDescription = '' %}
        {% endif %}
        {% include 'portfolios/edit.html' %}
    {% else %}
        {% set portfolioColor = 'primary' %}
        {% if portfolio['status'] == 'positive' %}
            {% set portfolioColor = 'success' %}
        {% elseif portfolio['status'] == 'negative' %}
            {% set portfolioColor = 'danger' %}
        {% endif %}
        {% set portfolioId = portfolio['id'] %}
        {% set portfolioInvestedAmount = currencySymbol ~ portfolio['invested_amount'] %}
        {% set portfolioSoldAmount = currencySymbol ~ portfolio['sold_amount'] %}
        {% set portfolioReturnAmount = '<span class="text-' ~ portfolioColor ~ '">' ~ currencySymbol ~ portfolio['return_amount'] ~ '</span>' %}
        {% set portfolioTotalValue = currencySymbol ~ portfolio['total_value'] %}
        {% set portfolioProfitLoss = '<span class="text-' ~ portfolioColor ~ '">' ~ currencySymbol ~ portfolio['profit_loss'] ~ '</span>' %}
        {% set portfolioXirr = '<span class="text-' ~ portfolioColor ~ '">' ~ portfolio['xirr'] ~ '%</span>' %}
        <form data-validateon="section" id="{{componentId}}-{{sectionId}}-form">
            <fieldset id="{{componentId}}-{{sectionId}}-fieldset">
                <div class="row">
                    <div class="col">
                        {{adminltetags.useTag('fields',
                            [
                                'component'                      : component,
                                'componentName'                  : componentName,
                                'componentId'                    : componentId,
                                'sectionId'                      : sectionId,
                                'fieldId'                        : 'id',
                                'fieldLabel'                     : 'ID',
                                'fieldType'                      : 'input',
                                'fieldHelp'                      : true,
                                'fieldHelpTooltipContent'        : 'ID',
                                'fieldRequired'                  : true,
                                'fieldBazScan'                   : true,
                                'fieldBazPostOnCreate'           : false,
                                'fieldBazPostOnUpdate'           : true,
                                'fieldHidden'                    : true,
                                'fieldDisabled'                  : true,
                                'fieldValue'                     : portfolioId
                            ]
                        )}}
                    </div>
                </div>
                <div class="row vdivide">
                    <div class="col">
                        {% if mode == 'timeline' %}
                            {% include 'portfolios/timeline.html' %}
                        {% else %}
                            <div class="row">
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'portfolio_name',
                                            'fieldLabel'                     : 'Portfolio Name',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : false,
                                            'fieldHelpTooltipContent'        : 'Portfolio Name',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolio['name']
                                        ]
                                    )}}
                                </div>
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'portfolio_user',
                                            'fieldLabel'                     : 'Portfolio User',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : false,
                                            'fieldHelpTooltipContent'        : 'Portfolio User',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : users[portfolio['user_id']]['name']
                                        ]
                                    )}}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    {% if portfolio['description'] == '' %}
                                        {% set portfolio['description'] = '-' %}
                                    {% endif %}
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'portfolio_description',
                                            'fieldLabel'                     : 'Portfolio Description',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : false,
                                            'fieldHelpTooltipContent'        : 'Portfolio Description',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolio['description']
                                        ]
                                    )}}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    {% if mode == 'strategies' %}
                        {% include 'portfolios/strategies.html' %}
                    {% else %}
                        <div class="col">
                            <div class="row">
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'invested_amount',
                                            'fieldLabel'                     : 'Invested Amount',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'Invested Amount',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioInvestedAmount
                                        ]
                                    )}}
                                </div>
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'xirr',
                                            'fieldLabel'                     : 'Xirr',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'XIRR of portfolio',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioXirr
                                        ]
                                    )}}
                                </div>
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'total_value',
                                            'fieldLabel'                     : 'Total value',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'Total value',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioTotalValue
                                        ]
                                    )}}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'return_amount',
                                            'fieldLabel'                     : 'Return Amount',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'Return Amount.',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioReturnAmount
                                        ]
                                    )}}
                                </div>
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'sold_amount',
                                            'fieldLabel'                     : 'Sold Amount',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'Sold Amount',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioSoldAmount
                                        ]
                                    )}}
                                </div>
                                <div class="col">
                                    {{adminltetags.useTag('fields',
                                        [
                                            'component'                      : component,
                                            'componentName'                  : componentName,
                                            'componentId'                    : componentId,
                                            'sectionId'                      : sectionId,
                                            'fieldId'                        : 'profit_loss',
                                            'fieldLabel'                     : 'Profit/Loss',
                                            'fieldType'                      : 'html',
                                            'fieldHelp'                      : true,
                                            'fieldHelpTooltipContent'        : 'Profit/Loss.',
                                            'fieldRequired'                  : false,
                                            'fieldBazScan'                   : true,
                                            'fieldBazPostOnUpdate'           : true,
                                            'fieldHtmlContent'               : portfolioProfitLoss
                                        ]
                                    )}}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </fieldset>
        </form>
        {% if mode == 'timeline' %}
            {% set url = links.url('mf/portfolios/q/mode/timeline/id/' ~ portfolio['id']) %}
        {% elseif mode == 'transact' or mode == 'strategies' %}
            {% set url = links.url('mf/portfolios/q/mode/transact/id/' ~ portfolio['id']) %}
        {% endif %}
        {{adminltetags.useTag('buttons',
            [
                'component'                      : component,
                'componentName'                  : componentName,
                'componentId'                    : componentId,
                'sectionId'                      : sectionId,
                'buttonType'                    : 'button',
                'buttons'                       :
                    [
                        'portfolios-link'    : [
                            'title'                   : 'link',
                            'size'                    : 'xs',
                            'disabled'                : true,
                            'hidden'                  : true,
                            'url'                     : url
                        ]
                    ]
            ]
        )}}
        {% set investments = [] %}
        {% set transactions = [] %}
        {% set allocation = [] %}
        {% if mode != 'strategies' %}
            {% if portfolio['investments'] is defined and portfolio['investments']|length > 0 %}
                {% set investments = portfolio['investments'] %}
            {% endif %}
            {% if portfolio['transactions'] is defined and portfolio['transactions']|length > 0 %}
                {% set transactions = portfolio['transactions'] %}
            {% endif %}
            {% if portfolio['allocation'] is defined and portfolio['allocation']|length > 0 %}
                {% set allocation = portfolio['allocation'] %}
            {% endif %}
            <hr>
        {% endif %}
        {% if mode != 'strategies' %}
            <div class="row">
                {% set transactionButtons = [] %}
                {% set sell = false %}
                {% set recalculate = false %}
                {% set importNav = false %}
                {% if mode == 'transact' %}
                    {% if portfolio['investments']|length > 0 %}
                        {% for investment in portfolio['investments'] %}
                            {% if investment['status'] == 'open' %}
                                {% set recalculate = true %}
                                {% set sell = true %}
                                {% set importNav = true %}
                                {% break %}
                            {% endif %}
                        {% endfor %}
                        {% set transactionButtons = array_merge(transactionButtons,
                                [
                                    'timeline' : [
                                        'title'                   : 'Timeline',
                                        'size'                    : 'xs',
                                        'type'                    : 'info',
                                        'buttonAdditionalClass'   : 'contentAjaxLink',
                                        'icon'                    : 'timeline',
                                        'url'                     : links.url('mf/portfolios/q/mode/timeline/id/' ~ portfolio['id'])
                                    ]
                                ]
                            )
                        %}
                    {% endif %}
                    {% if portfolio['transactions']|length > 0 %}
                        {% for transaction in portfolio['transactions'] %}
                            {% if transaction['status'] == 'open' %}
                                {% set recalculate = true %}
                                {% set sell = true %}
                                {% set importNav = true %}
                                {% break %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% elseif mode == 'timeline' %}
                    {% if portfolio['investments']|length > 0 %}
                        {% set recalculate = true %}
                    {% endif %}
                    {% set transactionButtons = array_merge(transactionButtons,
                            [
                                'transact' : [
                                    'title'                   : 'Transact',
                                    'size'                    : 'xs',
                                    'type'                    : 'primary',
                                    'buttonAdditionalClass'   : 'contentAjaxLink',
                                    'icon'                    : 'exchange-alt',
                                    'url'                     : links.url('mf/portfolios/q/id/' ~ portfolio['id'])
                                ]
                            ]
                        )
                    %}
                {% endif %}
                {% if importNav == true %}
                    {% set transactionButtons = array_merge(transactionButtons,
                            [
                                'importInvestmentNavs' : [
                                    'title'                   : 'Import Navs',
                                    'size'                    : 'xs',
                                    'position'                : 'right',
                                    'icon'                    : 'cog fa-spin',
                                    'iconHidden'              : true
                                ]
                            ]
                        )
                    %}
                {% endif %}
                {% if recalculate == true %}
                    {% set transactionButtons = array_merge(transactionButtons,
                            [
                                'recalculate' : [
                                    'title'                   : 'Recalculate',
                                    'size'                    : 'xs',
                                    'type'                    : 'info',
                                    'position'                : 'right',
                                    'icon'                    : 'cog fa-spin',
                                    'iconHidden'              : true
                                ]
                            ]
                        )
                    %}
                {% endif %}
                {% if sell == true %}
                    {% set transactionButtons = array_merge(transactionButtons,
                            [
                                'sell' : [
                                    'title'                   : 'Sell',
                                    'size'                    : 'xs',
                                    'type'                    : 'warning',
                                    'position'                : 'right'
                                ]
                            ]
                        )
                    %}
                {% endif %}
                {% if mode == 'transact' %}
                    {% set transactionButtons = array_merge(transactionButtons,
                            [
                                'buy' : [
                                    'title'                   : 'Buy',
                                    'size'                    : 'xs',
                                    'type'                    : 'success',
                                    'position'                : 'right'
                                ]
                            ]
                        )
                    %}
                {% endif %}
                <div class="col mb-2">
                    {{adminltetags.useTag('buttons',
                        [
                        'component'                     : component,
                        'componentName'                 : componentName,
                        'componentId'                   : componentId,
                        'parentComponentId'             : parent,
                        'sectionId'                     : sectionId,
                        'buttonType'                    : 'button',
                        'buttons'                       : transactionButtons
                        ]
                    )}}
                </div>
            </div>
            <hr>
        {% endif %}
        {% include 'portfolios/timelinechart.html' %}
        {% if mode != 'strategies' %}
            {% if portfolio['transactions'] is defined and portfolio['transactions']|length > 0 %}
                <div class="row">
                    <div class="col">
                        {{adminltetags.useTag('tabs',
                            [
                                'component'                     : component,
                                'componentName'                 : componentName,
                                'componentId'                   : componentId,
                                'sectionId'                     : 'main',
                                'tabsId'                        : 'tabs',
                                'tabsStyle'                     : 'card-outline-tabs',
                                'tabsData'                      :
                                    [
                                        'investments'   :
                                        [
                                            'tabTitle'          : 'Investments',
                                            'tabInclude'        : 'portfolios/form/investments'
                                        ],
                                        'transactions'   :
                                        [
                                            'tabTitle'          : 'Transactions',
                                            'tabInclude'        : 'portfolios/form/transactions'
                                        ],
                                        'allocation'   :
                                        [
                                            'tabTitle'          : 'Allocation',
                                            'tabInclude'        : 'portfolios/form/allocation'
                                        ]
                                    ]
                            ]
                        )}}
                    </div>
                </div>
            {% endif %}
            {% if mode == 'transact' %}
                <div>
                    {{adminltetags.useTag('modal',
                        [
                            'component'                 : component,
                            'componentName'             : componentName,
                            'componentId'               : componentId,
                            'sectionId'                 : sectionId,
                            'modalId'                   : 'buy-modal',
                            'modalBodyInclude'          : 'portfolios/transaction/buy',
                            'modalSize'                 : 'xl',
                            'modalType'                 : 'success',
                            'modalHeader'               : true,
                            'modalFooter'               : true,
                            'modalHeaderCloseButton'    : true,
                            'modalEscClose'             : true,
                            'modalTitle'                : currencySymbol ~ ' BUY INVESTMENT',
                            'modalFooterButtons'        :
                                [
                                'component'                     : component,
                                'componentName'                 : componentName,
                                'componentId'                   : componentId,
                                'parentComponentId'             : parent,
                                'sectionId'                     : sectionId,
                                'buttonType'                    : 'button',
                                'buttons'                       :
                                        [
                                            'buy-modal-button-save' : [
                                                'title'                   : 'buy',
                                                'type'                    : 'success',
                                                'position'                : 'right',
                                                'icon'                    : 'cog fa-spin',
                                                'iconHidden'              : true
                                            ]
                                        ]
                                ]
                        ]
                    )}}
                </div>
                <div>
                    {{adminltetags.useTag('modal',
                        [
                            'component'                 : component,
                            'componentName'             : componentName,
                            'componentId'               : componentId,
                            'sectionId'                 : sectionId,
                            'modalId'                   : 'sell-modal',
                            'modalBodyInclude'          : 'portfolios/transaction/sell',
                            'modalSize'                 : 'xl',
                            'modalType'                 : 'warning',
                            'modalHeader'               : true,
                            'modalFooter'               : true,
                            'modalHeaderCloseButton'    : true,
                            'modalEscClose'             : true,
                            'modalTitle'                : currencySymbol ~ ' SELL INVESTMENT',
                            'modalFooterButtons'        :
                                [
                                'component'                     : component,
                                'componentName'                 : componentName,
                                'componentId'                   : componentId,
                                'parentComponentId'             : parent,
                                'sectionId'                     : sectionId,
                                'buttonType'                    : 'button',
                                'buttons'                       :
                                        [
                                            'sell-modal-button-save' : [
                                                'title'                   : 'sell',
                                                'type'                    : 'warning',
                                                'position'                : 'right',
                                                'icon'                    : 'cog fa-spin',
                                                'iconHidden'              : true
                                            ]
                                        ]
                                ]
                        ]
                    )}}
                </div>
            {% endif %}
        {% elseif mode == 'strategies' %}
            <hr>
            <div id="{{componentId}}-{{sectionId}}-strategies-form">
                {% if strategy is defined and strategy != '' %}
                    {% include 'portfolios/strategies/' ~ strategy %}
                    <div id="strategies-buttons" class="row">
                        <div class="col">
                            {{adminltetags.useTag('buttons',
                                [
                                    'component'                      : component,
                                    'componentName'                  : componentName,
                                    'componentId'                    : componentId,
                                    'sectionId'                      : sectionId,
                                    'buttonType'                    : 'button',
                                    'buttons'                       :
                                        [
                                            'apply-strategy'        : [
                                                'title'                   : 'apply strategy',
                                                'type'                    : 'success',
                                                'icon'                    : 'cog fa-spin',
                                                'position'                : 'right',
                                                'iconHidden'              : true
                                            ],
                                            'view-strategy-transactions'    : [
                                                'title'                   : 'View Strategy Transactions',
                                                'icon'                    : 'eye',
                                                'type'                    : 'info'
                                            ]
                                        ]
                                ]
                            )}}
                        </div>
                    </div>
                    <div class="row" id="portfolio-access-buttons" hidden>
                        <div class="col">
                            {{adminltetags.useTag('buttons',
                                [
                                    'component'                      : component,
                                    'componentName'                  : componentName,
                                    'componentId'                    : componentId,
                                    'sectionId'                      : sectionId,
                                    'buttonType'                    : 'button',
                                    'buttons'                       :
                                        [
                                            'transact-mode'        : [
                                                'title'                   : 'Access Portfolio (Transact Mode)'
                                            ],
                                            'timeline-mode'        : [
                                                'title'                   : 'Access Portfolio (Timeline Mode)',
                                                'type'                    : 'info'
                                            ]
                                        ]
                                ]
                            )}}
                        </div>
                    </div>
                {% else %}
                    <div class="row text-center m-2" id="{{componentId}}-{{sectionId}}-strategies-noinfo">
                        <div class="col">
                            <h6><i class="fa fa-fw fa-info-circle text-info"></i> Please select strategy</h6>
                        </div>
                    </div>
                {% endif %}
                <div class="row">
                    <div class="col">
                        <div id="strategies-progress" class="mb-3 mt-3" hidden></div>
                    </div>
                </div>
            </div>
            <div>
                {{adminltetags.useTag('modal',
                    [
                        'component'                 : component,
                        'componentName'             : componentName,
                        'componentId'               : componentId,
                        'sectionId'                 : sectionId,
                        'modalId'                   : 'strategies-transactions-modal',
                        'modalBodyInclude'          : 'portfolios/strategiestransactions',
                        'modalSize'                 : 'xl',
                        'modalType'                 : 'info',
                        'modalHeader'               : true,
                        'modalFooter'               : true,
                        'modalHeaderCloseButton'    : true,
                        'modalEscClose'             : true,
                        'modalTitle'                : 'STRATEGY TRANSACTIONS'
                    ]
                )}}
            </div>
        {% endif %}
        {% set investments = escaper.js(json_encode(investments, 16)) %}
        {% set transactions = escaper.js(json_encode(transactions, 16)) %}
        {% set allocation = escaper.js(json_encode(allocation, 16)) %}
        {% set portfolio = escaper.js(json_encode(portfolio, 16)) %}
        {% set strategies = escaper.js(json_encode(strategies, 16)) %}
        {% set amcs = escaper.js(json_encode(amcs, 16)) %}
        <script>
/*global paginatedPNotify BazProgress BazContentFields BazHelpers BazContentLoader Pace BazCore dataCollection Swal echarts Chart */
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;

if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}

dataCollectionSection =
    $.extend(dataCollectionSection, {
        '{{componentId}}-{{sectionId}}-id'                                  : { },
        '{{componentId}}-{{sectionId}}-name'                                : { },
        '{{componentId}}-{{sectionId}}-user_id'                             : {
            placeholder: "SELECT USER"
        },
        '{{componentId}}-{{sectionId}}-description'                         : { },
        '{{componentId}}-{{sectionId}}-portfolio_name'                      : { },
        '{{componentId}}-{{sectionId}}-portfolio_user'                      : { },
        '{{componentId}}-{{sectionId}}-portfolio_description'               : { },
        '{{componentId}}-{{sectionId}}-strategies'                          : {
            placeholder : "SELECT STRATEGY TO APPLY",
            afterInit: function() {
                var id;

                $('#{{componentId}}-{{sectionId}}-strategies').on('select2:select', function(e) {
                    id = e.params.data.id;

                    if (dataCollectionSectionForm['vars']['strategies'][id]) {
                        $('#{{componentId}}-{{sectionId}}-portfolios-link')
                            .attr(
                                'href',
                                dataCollection.env.httpScheme + '://' + dataCollection.env.httpHost + '/' + dataCollection.env.appRoute + '/' +
                                'mf/portfolios/q/id/' + dataCollectionSectionForm['vars']['portfolio']['id'] + '/mode/strategies/strategy/' + id
                            );

                        dataCollectionSectionForm['funcs']['browse']();
                    } else {
                        $('#{{componentId}}-{{sectionId}}-strategies_description').html('');
                    }
                });

                $('#{{componentId}}-{{sectionId}}-apply-strategy').click(function() {
                    dataCollectionSectionForm['funcs']['applyStrategy']();
                });

                dataCollectionSectionForm['funcs']['initDatatables']('strategies-transactions');

                BazProgress.buildProgressBar($('#strategies-progress'), false, true, true, true);
            }
        },
        '{{componentId}}-{{sectionId}}-clone_portfolio'                     : {
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-clone_portfolio').click(function() {
                    if ($(this)[0].checked === true) {
                        $('#{{componentId}}-{{sectionId}}-clone_portfolio_name').attr('disabled', false);
                    } else {
                        $('#{{componentId}}-{{sectionId}}-clone_portfolio_name').attr('disabled', true);
                    }
                });
            }
        },
        '{{componentId}}-{{sectionId}}-clone_portfolio_name'                : { },
        '{{componentId}}-{{sectionId}}-portfolio_timeline'                  : {
            dateFormat          : "Y-m-d",
            altFormat           : "d-m-Y",
            allowInput          : true,
            static              : true,
            maxDate             : "today",
            onChange: function(selectedDates, dateStr, instance) {
                if (dateStr !== '') {
                    var postData = { };
                    postData[$('#security-token').attr('name')] = $('#security-token').val();
                    postData['portfolio_id'] = $('#{{componentId}}-{{sectionId}}-id').val();
                    postData['timelineDate'] = dateStr;

                    dataCollectionSectionForm['funcs']['browseTimeline'](postData);
                }
            },
            disable: [
                function(date) {
                    // return true to disable
                    return (date.getDay() === 0);
                }
            ],
            locale: {
                "firstDayOfWeek": 1 // start week on Monday
            },
            afterInit: function() {
                dataCollectionSection['{{componentId}}-{{sectionId}}-portfolio_timeline']['flatpickr'].config.minDate = dataCollectionSectionForm['vars']['portfolio']['start_date'];
                dataCollectionSection['{{componentId}}-{{sectionId}}-portfolio_timeline']['flatpickr'].setDate(dataCollectionSectionForm['vars']['portfolio']['timelineDate']);
                dataCollectionSection['{{componentId}}-{{sectionId}}-portfolio_timeline']['flatpickr'].config.maxDate = 'today';
            }
        },
        '{{componentId}}-{{sectionId}}-portfolio_timeline_browser'          : {
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-browse-previous, #{{componentId}}-{{sectionId}}-browse-next, ' +
                  '#{{componentId}}-{{sectionId}}-browse-start, #{{componentId}}-{{sectionId}}-browse-today').off();
                $('#{{componentId}}-{{sectionId}}-browse-previous, #{{componentId}}-{{sectionId}}-browse-next, ' +
                  '#{{componentId}}-{{sectionId}}-browse-start, #{{componentId}}-{{sectionId}}-browse-today').click(function(e) {
                    e.preventDefault();

                    var thisButton = $(this);
                    $(thisButton).attr('disabled', true);

                    var idArr = $(this)[0].id.split('-');

                    var postData = { };
                    postData[$('#security-token').attr('name')] = $('#security-token').val();
                    postData['portfolio_id'] = $('#{{componentId}}-{{sectionId}}-id').val();
                    postData['timelineDate'] = dataCollectionSectionForm['vars']['timelineDate'];
                    postData['jump'] = idArr[idArr.length - 1];

                    if (postData['jump'] === 'start') {
                        $(thisButton).children('i').removeClass('fa-backward-fast').addClass('fa-spin fa-cog');
                        postData['timelineDate'] = dataCollectionSectionForm['vars']['portfolio']['start_date'];
                    } else if (postData['jump'] === 'previous') {
                        $(thisButton).children('i').removeClass('fa-backward-step').addClass('fa-spin fa-cog');
                        postData['browse'] = $('#{{componentId}}-{{sectionId}}-portfolio_timeline_browser').val();
                    } else if (postData['jump'] === 'next') {
                        $(thisButton).children('i').removeClass('fa-forward-step').addClass('fa-spin fa-cog');
                        postData['browse'] = $('#{{componentId}}-{{sectionId}}-portfolio_timeline_browser').val();
                    } else if (postData['jump'] === 'today') {
                        $(thisButton).children('i').removeClass('fa-forward-fast').addClass('fa-spin fa-cog');
                        postData['timelineDate'] = dataCollectionSectionForm['vars']['today'];
                    }

                    dataCollectionSectionForm['funcs']['browseTimeline'](postData, thisButton);
                });
            }
        },
        '{{componentId}}-{{sectionId}}-total_value'                         : { },
        '{{componentId}}-{{sectionId}}-invested_amount'                     : { },
        '{{componentId}}-{{sectionId}}-return_amount'                       : { },
        '{{componentId}}-{{sectionId}}-sold_amount'                         : { },
        '{{componentId}}-{{sectionId}}-profit_loss'                         : { },
        '{{componentId}}-{{sectionId}}-xirr'                                : { },
        '{{componentId}}-{{sectionId}}-transaction_id'                      : { },
        '{{componentId}}-{{sectionId}}-type'                                : {
            placeholder: "SELECT TRANSACTION TYPE"
        },
        '{{componentId}}-{{sectionId}}-amc_id'                              : {
            placeholder: "SELECT AMC",
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-amc_id').on('select2:select', function(e) {
                    $('#{{componentId}}-{{sectionId}}-scheme_id').empty().trigger('change');
                    $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', false);
                    dataCollectionSectionForm['funcs']['cleanup']();
                });
            }
        },
        '{{componentId}}-{{sectionId}}-sell_transaction_id'                 : {
            placeholder: "SELECT SCHEME TO SELL",
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-sell_transaction_id').on('select2:select', function(e) {
                    if (dataCollectionSectionForm['vars']['mode'] === 'strategies') {
                        $('#{{componentId}}-{{sectionId}}-sell-available_amount').html(
                            dataCollectionSectionForm['vars']['currencySymbol'] +
                            dataCollectionSectionForm['vars']['investments'][$(e.params.data.element).data()['value']]['latest_value']
                        );
                        $('#{{componentId}}-{{sectionId}}-sell-available_units').html(
                            dataCollectionSectionForm['vars']['investments'][$(e.params.data.element).data()['value']]['units']
                        );
                        $('#{{componentId}}-{{sectionId}}-sell-isin').html(
                            dataCollectionSectionForm['vars']['investments'][$(e.params.data.element).data()['value']]['scheme']['isin']
                        );

                        if (dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']) {
                            dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']['flatpickr'].config.minDate =
                                dataCollectionSectionForm['vars']['investments'][$(e.params.data.element).data()['value']]['start_date'];
                            dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']['flatpickr'].config.maxDate =
                                dataCollectionSectionForm['vars']['investments'][$(e.params.data.element).data()['value']]['latest_value_date'];
                        }
                        if (dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']) {
                            dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']['flatpickr'].config.minDate =
                                dataCollectionSectionForm['vars']['investments'][$(e.params.data.element).data()['value']]['start_date'];
                            dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']['flatpickr'].config.maxDate =
                                dataCollectionSectionForm['vars']['investments'][$(e.params.data.element).data()['value']]['latest_value_date'];
                        }
                        if (dataCollectionSection['{{componentId}}-{{sectionId}}-sell_dates']) {
                            dataCollectionSection['{{componentId}}-{{sectionId}}-sell_dates']['flatpickr'].config.minDate =
                                dataCollectionSectionForm['vars']['investments'][$(e.params.data.element).data()['value']]['start_date'];
                            dataCollectionSection['{{componentId}}-{{sectionId}}-sell_dates']['flatpickr'].config.maxDate =
                                dataCollectionSectionForm['vars']['investments'][$(e.params.data.element).data()['value']]['latest_value_date'];
                        }
                    } else {
                        dataCollectionSectionForm['funcs']['getSchemeDetails']($(e.params.data.element).data()['value'], 'sell');
                    }
                });
            }
        },
        '{{componentId}}-{{sectionId}}-scheme_id'                           : {
            placeholder: "SELECT SCHEME",
            "ajax"          : {
                url         : "{{links.url('mf/schemes/searchSchemesForAMC')}}",
                dataType    : "json",
                method      : "post",
                data: function(params) {
                    var query = { };
                    query[$('#security-token').attr('name')] = $('#security-token').val();
                    query['amc_id'] = $('#{{componentId}}-{{sectionId}}-amc_id').val();
                    query['search'] = params.term;

                    return query;
                },
                processResults: function(response) {
                    if (response.responseData.schemes) {
                        var schemesData = [];

                        for (var scheme in response.responseData.schemes) {
                            schemesData.push({
                                "id"    : response.responseData.schemes[scheme]["id"],
                                "text"  : response.responseData.schemes[scheme]["name"]
                            });
                        }

                        return {
                            results: schemesData
                        }
                    } else {
                        return {
                            results : []
                        }
                    }
                }
            },
            minimumInputLength : 3,
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-scheme_id').on('select2:select', function(e) {
                    dataCollectionSectionForm['funcs']['getSchemeDetails'](e.params.data.id, 'buy');
                });
            }
        },
        '{{componentId}}-{{sectionId}}-buy-date'                            : {
            dateFormat          : "Y-m-d",
            altFormat           : "d-m-Y",
            allowInput          : true,
            static              : true,
            maxDate             : "today",
            onChange: function(selectedDates, dateStr, instance) {
                if (dateStr !== '') {
                    if ($('#{{componentId}}-{{sectionId}}-scheme_id').val() === '' ||
                        !$('#{{componentId}}-{{sectionId}}-scheme_id').val()
                    ) {
                        paginatedPNotify('error', {text : 'Please select scheme first'});

                        return;
                    }

                    $('#{{componentId}}-{{sectionId}}-buy-amount').attr('disabled', false);

                    if (dataCollectionSectionForm['vars']['scheme']['navs']['navs'] &&
                        dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dateStr]
                    ) {
                        $('#{{componentId}}-{{sectionId}}-buy-selected_nav').html(
                            dataCollectionSectionForm['vars']['currencySymbol'] +
                            dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dateStr]['nav']
                        );

                        return;
                    }

                    dataCollectionSectionForm['funcs']['getSchemeNavByDate'](dateStr, 'buy');
                } else {
                    $('#{{componentId}}-{{sectionId}}-buy-amount').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-buy-selected_nav').html('-');
                }
            },
            disable: [
                function(date) {
                    // return true to disable
                    return (date.getDay() === 0);
                }
            ],
            locale: {
                "firstDayOfWeek": 1 // start week on Monday
            }
        },
        '{{componentId}}-{{sectionId}}-sell-date'                           : {
            dateFormat          : "Y-m-d",
            altFormat           : "d-m-Y",
            allowInput          : true,
            static              : true,
            maxDate             : "today",
            onChange: function(selectedDates, dateStr, instance) {
                if (dateStr !== '') {
                    if ($('#{{componentId}}-{{sectionId}}-sell_transaction_id').val() === '' ||
                        !$('#{{componentId}}-{{sectionId}}-sell_transaction_id').val()
                    ) {
                        paginatedPNotify('error', {text : 'Please select scheme first'});

                        return;
                    }

                    $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', false);
                    $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', false);
                    $('#{{componentId}}-{{sectionId}}-sell_all').attr('disabled', false);

                    if (dataCollectionSectionForm['vars']['scheme']['navs']['navs'] &&
                        dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dateStr]
                    ) {
                        $('#{{componentId}}-{{sectionId}}-sell-selected_nav').html(
                            dataCollectionSectionForm['vars']['currencySymbol'] +
                            dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dateStr]['nav']
                        );

                        return;
                    }

                    dataCollectionSectionForm['funcs']['getSchemeNavByDate'](dateStr, 'sell');
                } else {
                    $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-sell_all').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-sell-selected_nav').html('-');
                }
            },
            disable: [
                function(date) {
                    // return true to disable
                    return (date.getDay() === 0);
                }
            ],
            locale: {
                "firstDayOfWeek": 1 // start week on Monday
            }
        },
        '{{componentId}}-{{sectionId}}-buy-selected_nav'                    : { },
        '{{componentId}}-{{sectionId}}-sell-selected_nav'                   : { },
        '{{componentId}}-{{sectionId}}-buy-amount'                          : { },
        '{{componentId}}-{{sectionId}}-sell-amount'                         : { },
        '{{componentId}}-{{sectionId}}-buy-calculated_units'                : { },
        '{{componentId}}-{{sectionId}}-sell-available_amount'               : { },
        '{{componentId}}-{{sectionId}}-sell-units'                          : { },
        '{{componentId}}-{{sectionId}}-sell_all'                            : {
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-sell_all').off();
                $('#{{componentId}}-{{sectionId}}-sell_all').change(function() {
                    if ($(this)[0].checked === true) {
                        $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', true);
                        $('#{{componentId}}-{{sectionId}}-sell-units').val(
                            dataCollectionSectionForm['vars']['investments'][dataCollectionSectionForm['vars']['scheme']['id']]['units']
                        );
                        $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');

                        var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav'];
                        var amount = ($('#{{componentId}}-{{sectionId}}-sell-units').val() * nav).toFixed(2);
                        $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', true);
                        $('#{{componentId}}-{{sectionId}}-sell-amount').val(amount);
                        $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
                    } else {
                        $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', false);
                        $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', false);
                        $('#{{componentId}}-{{sectionId}}-sell-units').val('');
                        $('#{{componentId}}-{{sectionId}}-sell-amount').val('');
                    }
                });
            }
        },
        '{{componentId}}-{{sectionId}}-sell-available_units'                : { },
        '{{componentId}}-{{sectionId}}-buy-amc_transaction_id'              : { },
        '{{componentId}}-{{sectionId}}-sell-amc_transaction_id'             : { },
        '{{componentId}}-{{sectionId}}-buy-scheme_id'                       : { },
        '{{componentId}}-{{sectionId}}-sell-scheme_id'                      : { },
        '{{componentId}}-{{sectionId}}-buy-isin'                            : { },
        '{{componentId}}-{{sectionId}}-sell-isin'                           : { },
        '{{componentId}}-{{sectionId}}-buy-latest_nav'                      : { },
        '{{componentId}}-{{sectionId}}-sell-latest_nav'                     : { },
        '{{componentId}}-{{sectionId}}-buy-latest_nav_date'                 : { },
        '{{componentId}}-{{sectionId}}-sell-latest_nav_date'                : { },
        '{{componentId}}-{{sectionId}}-buy-first_nav_date'                  : { },
        '{{componentId}}-{{sectionId}}-sell-first_nav_date'                 : { },
        '{{componentId}}-{{sectionId}}-buy-details'                         : { },
        '{{componentId}}-{{sectionId}}-sell-details'                        : { },
        '{{componentId}}-{{sectionId}}-transactions'                        : { },
        '{{componentId}}-{{sectionId}}-categories_percentage_variance'      : { },
        '{{componentId}}-{{sectionId}}-subcategories_percentage_variance'   : { },
        '{{componentId}}-{{sectionId}}-form' : {
            rules: {
            },
            messages: {
            }
        }
    });

if (!dataCollectionSectionForm['vars']) {
    dataCollectionSectionForm['vars'] = { };
}
if (!dataCollectionSectionForm['funcs']) {
    dataCollectionSectionForm['funcs'] = { };
}
dataCollectionSectionForm['vars']['today'] = '{{today}}';
dataCollectionSectionForm['vars']['mode'] = '{{mode}}';
dataCollectionSectionForm['vars']['portfolio'] = JSON.parse('{{portfolio}}');
dataCollectionSectionForm['vars']['strategies'] = JSON.parse('{{strategies}}');
dataCollectionSectionForm['vars']['timelineDate'] = dataCollectionSectionForm['vars']['portfolio']['timelineDate'];
dataCollectionSectionForm['vars']['investments'] = JSON.parse('{{investments}}');
dataCollectionSectionForm['vars']['transactions'] = JSON.parse('{{transactions}}');
dataCollectionSectionForm['vars']['allocation'] = JSON.parse('{{allocation}}');
dataCollectionSectionForm['vars']['allocationCharts'] = { };

dataCollectionSectionForm['vars']['amcs'] = JSON.parse('{{amcs}}');
dataCollectionSectionForm['vars']['currencySymbol'] = '{{currencySymbol}}';
dataCollectionSectionForm['vars']['sellInput'] = 'amount';
dataCollectionSectionForm['vars']['scheme'] = { };

dataCollectionSectionForm['funcs']['getSchemeNavByDate'] = function(dateStr, type) {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    if (type === 'buy') {
        postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-scheme_id').val();
    } else if (type === 'sell') {
        postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-sell_transaction_id').val();
    }
    postData['date'] = dateStr;
    postData['latest'] = false;

    $.post('{{links.url("mf/schemes/getSchemeNavByDate")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $('#security-token').attr('name', response.tokenKey);
            $('#security-token').val(response.token);
        }

        if (!dataCollectionSectionForm['vars']['scheme']['navs']['navs']) {
            dataCollectionSectionForm['vars']['scheme']['navs']['navs'] = { };
        }

        if (response.responseCode == 0) {
            if (response.responseData.nav && response.responseData.nav['nav']) {
                $('#{{componentId}}-{{sectionId}}-' + type + '-selected_nav')
                    .html(dataCollectionSectionForm['vars']['currencySymbol'] +
                          response.responseData.nav['nav']
                    );

                dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dateStr] = response.responseData.nav;
            } else {
                $('#{{componentId}}-{{sectionId}}-' + type + '-selected_nav').html('-');

                dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dateStr] = { };
                dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dateStr]['nav'] = 0;
            }
        } else {
            paginatedPNotify('error', {text : response.responseMessage});
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['processTransaction'] = function(task, update = false, remove = false) {
    var postData = { };

    postData[$('#security-token').attr('name')] = $('#security-token').val();
    if (remove) {
        postData['id'] = $('#{{componentId}}-{{sectionId}}-transaction_id').val();
    } else {
        if (update) {
            postData['id'] = $('#{{componentId}}-{{sectionId}}-transaction_id').val();
        }
        postData['user_id'] = $('#{{componentId}}-{{sectionId}}-user_id').val();
        postData['portfolio_id'] = $('#{{componentId}}-{{sectionId}}-id').val();
        postData['date'] = $('#{{componentId}}-{{sectionId}}-' + task + '-date').val();

        if (task === 'sell') {
            if (dataCollectionSectionForm['vars']['sellInput'] === 'amount') {
                postData['amount'] = $('#{{componentId}}-{{sectionId}}-' + task + '-amount').val();
            } else if (dataCollectionSectionForm['vars']['sellInput'] === 'units') {
                postData['units'] = $('#{{componentId}}-{{sectionId}}-' + task + '-units').val();
            }
            postData['sell_all'] = $('#{{componentId}}-{{sectionId}}-sell_all')[0].checked;
            postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-sell_transaction_id option:selected').data()['value'];
        } else {
            postData['amc_id'] = $('#{{componentId}}-{{sectionId}}-amc_id').val();
            postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-scheme_id').val();
            postData['amount'] = $('#{{componentId}}-{{sectionId}}-' + task + '-amount').val();
            postData['status'] = 'open';
        }

        postData['amc_transaction_id'] = $('#{{componentId}}-{{sectionId}}-' + task + '-amc_transaction_id').val();
        postData['type'] = task;
        postData['details'] = $('#{{componentId}}-{{sectionId}}-' + task + '-details').val();

        if (($('#{{componentId}}-{{sectionId}}-' + task + '-amount') && $('#{{componentId}}-{{sectionId}}-' + task + '-amount').hasClass('is-invalid')) ||
            ($('#{{componentId}}-{{sectionId}}-' + task + '-units') && $('#{{componentId}}-{{sectionId}}-' + task + '-units').hasClass('is-invalid'))
        ) {
            paginatedPNotify('error', {text : 'Fix amount/units errors.'});

            return false;
        }
    }

    if (postData['date'] === '' && !remove) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-date').siblings('input').addClass('is-invalid');
        $('#{{componentId}}-{{sectionId}}-' + task + '-date').siblings('input').focus(function() {
            $(this).removeClass('is-invalid');
        });
    } else if (postData['amount'] === '' && !remove) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-amount').addClass('is-invalid');
        $('#{{componentId}}-{{sectionId}}-' + task + '-amount').focus(function() {
            $(this).removeClass('is-invalid');
        });
    } else {
        // $('#{{componentId}}-{{sectionId}}-modal-button-save').attr('disabled', true);
        // $('#{{componentId}}-{{sectionId}}-modal-button-save').children('i').attr('hidden', false);

        var url;
        if (remove) {
            url = '{{links.url("mf/transactions/remove")}}';
        } else {
            url = '{{links.url("mf/transactions/add")}}';
            if (update) {
                url = '{{links.url("mf/transactions/update")}}';
            }
        }

        $.post(url, postData, function(response) {
            if (response.tokenKey && response.token) {
                $('#security-token').attr('name', response.tokenKey);
                $('#security-token').val(response.token);
            }

            if (response.responseCode == 0) {
                paginatedPNotify('success', {text : response.responseMessage});

                if (!remove) {
                    $('#{{componentId}}-{{sectionId}}-transaction-modal').modal('hide');
                    $('.modal-backdrop').remove();
                    $('#body').removeClass('modal-open');
                }

                dataCollectionSectionForm['funcs']['browse']();
            } else {
                paginatedPNotify('error', {text : response.responseMessage});
            }

            $('#{{componentId}}-{{sectionId}}-modal-button-save').attr('disabled', false);
            $('#{{componentId}}-{{sectionId}}-modal-button-save').children('i').attr('hidden', true);
        }, 'json');
    }
}

dataCollectionSectionForm['funcs']['getSchemeDetails'] = function(id, task = null, taskId = null, view = false, update = false) {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['id'] = id;
    postData['navs'] = true;

    $.post('{{links.url("mf/schemes/getSchemeDetails")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }

        if (response.responseCode === 0) {
            if (response.responseData.scheme) {
                dataCollectionSectionForm['funcs']['cleanup']();
                dataCollectionSectionForm['vars']['scheme'] = response.responseData.scheme;
                dataCollectionSectionForm['funcs']['processSchemeNav'](response.responseData.scheme, task, taskId, view, update);
            } else {
                paginatedPNotify('error', {
                    text : 'Scheme data not found!'
                });
            }
        } else {
            paginatedPNotify('error', {
                text : response.responseMessage
            });

            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.minDate = '2000-01-01';
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].setDate('today');
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.maxDate = "today";
            dataCollectionSectionForm['funcs']['cleanup']();
            $('#{{componentId}}-{{sectionId}}-' + task + '-import').attr('disabled', false);
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['processSchemeNav'] = function(scheme, task = null, taskId = null, view = false, update = false) {
    if (scheme.isin) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-isin').html(scheme.isin);
    }
    if (scheme.latest_nav) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-latest_nav').html(
            dataCollectionSectionForm['vars']['currencySymbol'] + scheme.latest_nav
        );
    }
    if (scheme.navs_last_updated) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-latest_nav_date').html(scheme.navs_last_updated);
    }

    if (scheme) {
        $('#{{componentId}}-{{sectionId}}-' + task + '-first_nav_date').html(scheme.start_date);
        if (dataCollectionSectionForm['vars']['mode'] === 'transact') {
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.minDate = scheme.start_date;
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.maxDate = scheme.navs_last_updated;
        }
        if (dataCollectionSectionForm['vars']['mode'] === 'strategies') {
            if (dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']) {
                dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']['flatpickr'].config.minDate = scheme.start_date;
                dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']['flatpickr'].config.maxDate = scheme.navs_last_updated;
            }
            if (dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']) {
                dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']['flatpickr'].config.minDate = scheme.start_date;
                dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']['flatpickr'].config.maxDate = scheme.navs_last_updated;
            }
            if (dataCollectionSection['{{componentId}}-{{sectionId}}-investment_date']) {
                dataCollectionSection['{{componentId}}-{{sectionId}}-investment_date']['flatpickr'].config.minDate = scheme.start_date;
                dataCollectionSection['{{componentId}}-{{sectionId}}-investment_date']['flatpickr'].config.maxDate = scheme.navs_last_updated;
            }
            if (dataCollectionSection['{{componentId}}-{{sectionId}}-buy_dates']) {
                dataCollectionSection['{{componentId}}-{{sectionId}}-buy_dates']['flatpickr'].config.minDate = scheme.start_date;
                dataCollectionSection['{{componentId}}-{{sectionId}}-buy_dates']['flatpickr'].config.maxDate = scheme.navs_last_updated;
            }
            if (dataCollectionSection['{{componentId}}-{{sectionId}}-sell_dates']) {
                dataCollectionSection['{{componentId}}-{{sectionId}}-sell_dates']['flatpickr'].config.minDate = scheme.start_date;
                dataCollectionSection['{{componentId}}-{{sectionId}}-sell_dates']['flatpickr'].config.maxDate = scheme.navs_last_updated;
            }
        }
        $('#{{componentId}}-{{sectionId}}-' + task + '-import').attr('disabled', false);
    } else {
        if (dataCollectionSectionForm['vars']['mode'] === 'transact') {
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.minDate = '2000-01-01';
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].setDate('today');
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.maxDate = "today";
        }
        if (dataCollectionSectionForm['vars']['mode'] === 'strategies') {
            if (dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']) {
                dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']['flatpickr'].config.minDate = '2000-01-01';
                dataCollectionSection['{{componentId}}-{{sectionId}}-start-date']['flatpickr'].config.maxDate = "today";
            }
            if (dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']) {
                dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']['flatpickr'].config.minDate = '2000-01-01';
                dataCollectionSection['{{componentId}}-{{sectionId}}-end-date']['flatpickr'].config.maxDate = "today";
            }
            if (dataCollectionSection['{{componentId}}-{{sectionId}}-investment_date']) {
                dataCollectionSection['{{componentId}}-{{sectionId}}-investment_date']['flatpickr'].config.minDate = '2000-01-01';
                dataCollectionSection['{{componentId}}-{{sectionId}}-investment_date']['flatpickr'].config.maxDate = "today";
            }
            if (dataCollectionSection['{{componentId}}-{{sectionId}}-buy_dates']) {
                dataCollectionSection['{{componentId}}-{{sectionId}}-buy_dates']['flatpickr'].config.minDate = '2000-01-01';
                dataCollectionSection['{{componentId}}-{{sectionId}}-buy_dates']['flatpickr'].config.maxDate = "today";
            }
            if (dataCollectionSection['{{componentId}}-{{sectionId}}-sell_dates']) {
                dataCollectionSection['{{componentId}}-{{sectionId}}-sell_dates']['flatpickr'].config.minDate = '2000-01-01';
                dataCollectionSection['{{componentId}}-{{sectionId}}-sell_dates']['flatpickr'].config.maxDate = "today";
            }
        }
        $('#{{componentId}}-{{sectionId}}-' + task + '-import').attr('disabled', true);
    }

    if (taskId) {
        $('#{{componentId}}-{{sectionId}}-transaction_id').val(taskId);

        $('#{{componentId}}-{{sectionId}}-' + task + '-date').val(dataCollectionSectionForm['vars']['transactions'][taskId]['date']);
        dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].setDate(dataCollectionSectionForm['vars']['transactions'][taskId]['date']);
        $('#{{componentId}}-{{sectionId}}-' + task + '-amount').val(parseFloat(dataCollectionSectionForm['vars']['transactions'][taskId]['amount'].replace(/,/g, '')));

        if (dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dataCollectionSectionForm['vars']['transactions'][taskId]['date']] &&
            dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dataCollectionSectionForm['vars']['transactions'][taskId]['date']]['nav']
        ) {
            $('#{{componentId}}-{{sectionId}}-' + task + '-selected_nav')
                .html(dataCollectionSectionForm['vars']['currencySymbol'] +
                      dataCollectionSectionForm['vars']['scheme']['navs']['navs'][dataCollectionSectionForm['vars']['transactions'][taskId]['date']]['nav']
                );
        } else {
            $('#{{componentId}}-{{sectionId}}-' + task + '-selected_nav').html('-');
        }

        $('#{{componentId}}-{{sectionId}}-' + task + '-amc_transaction_id').val(dataCollectionSectionForm['vars']['transactions'][taskId]['amc_transaction_id']);
        $('#{{componentId}}-{{sectionId}}-' + task + '-details').val(dataCollectionSectionForm['vars']['transactions'][taskId]['details']);

        if (view) {
            $('#{{componentId}}-{{sectionId}}-' + task + '-amc_transaction_id, #{{componentId}}-{{sectionId}}-' + task + '-details').attr('disabled', true);
            $('#{{componentId}}-{{sectionId}}-' + task + '-modal-button-save').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-' + task + '-import').attr('hidden', true);
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.minDate = dataCollectionSectionForm['vars']['transactions'][taskId]['date'];
            dataCollectionSection['{{componentId}}-{{sectionId}}-' + task + '-date']['flatpickr'].config.maxDate = dataCollectionSectionForm['vars']['transactions'][taskId]['date'];
            $('#{{componentId}}-{{sectionId}}-' + task + '-amount').attr('disabled', true);
        } else {
            $('#{{componentId}}-{{sectionId}}-' + task + '-amc_transaction_id, #{{componentId}}-{{sectionId}}-' + task + '-details').attr('disabled', false);

            if (update) {
                $('#{{componentId}}-{{sectionId}}-' + task + '-amount').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-' + task + '-modal-button-save').html('UPDATE');
            } else {
                $('#{{componentId}}-{{sectionId}}-' + task + '-amount').attr('disabled', true);
            }

            $('#{{componentId}}-{{sectionId}}-' + task + '-modal-button-save').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-' + task + '-modal-button-save').off();
            $('#{{componentId}}-{{sectionId}}-' + task + '-modal-button-save').click(function(e) {
                e.preventDefault();

                dataCollectionSectionForm['funcs']['processTransaction'](task, true);
            });
        }

        if (task === 'buy') {
            dataCollectionSectionForm['funcs']['calculateBuyUnits']();
        } else if (task === 'sell') {
            dataCollectionSectionForm['funcs']['calculateSellUnits']();
            dataCollectionSectionForm['funcs']['calculateSellAmount']();
            $('#{{componentId}}-{{sectionId}}-sell-available_amount').parents('.col').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-sell-available_units').parents('.col').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-sell_all').parents('.col').attr('hidden', true);
        }

        if (dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'] &&
            Object.keys(dataCollectionSectionForm['vars']['transactions'][taskId]['transactions']).length > 0
        ) {
            var tbody = '';
            for (var transaction in dataCollectionSectionForm['vars']['transactions'][taskId]['transactions']) {
                tbody += '<tr>';
                tbody += '   <td>';
                tbody += '      <span id="transaction-' + taskId + '-' + dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['date'] + '">' +
                         dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['date'] +
                         '      </span>';
                tbody += '   </td>';
                tbody += '   <td>';
                tbody += '      <span id="transaction-' + taskId + '-' + dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['units'] + '">' +
                         dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['units'] +
                         '      </span>';
                tbody += '   </td>';
                tbody += '   <td>';
                tbody += '      <span id="transaction-' + taskId + '-' + dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['amount'] + '">' +
                         dataCollectionSectionForm['vars']['transactions'][taskId]['transactions'][transaction]['amount'] +
                         '      </span>';
                tbody += '   </td>';
                tbody += '</tr>';
            }

            $('#{{componentId}}-{{sectionId}}-' + task + '-transactions-table tbody').html(tbody);
            $('.' + task + '-transactions').children('label').html(task.toUpperCase() + ' TRANSACTIONS');
            $('#' + task + '-transactions-div').attr('hidden', false);
        }

        $('#{{componentId}}-{{sectionId}}-' + task + '-modal').modal('show');
    } else {
        if (dataCollectionSectionForm['vars']['mode'] === 'transact') {
            $('#{{componentId}}-{{sectionId}}-' + task + '-amc_transaction_id, #{{componentId}}-{{sectionId}}-' + task + '-details').attr('disabled', false);

            if (task === 'buy') {
                //
            } else if (task === 'sell') {
                $('#{{componentId}}-{{sectionId}}-sell-available_amount').html(
                    dataCollectionSectionForm['vars']['currencySymbol'] +
                    dataCollectionSectionForm['vars']['investments'][scheme['id']]['latest_value']
                );
                $('#{{componentId}}-{{sectionId}}-sell-available_units').html(
                    dataCollectionSectionForm['vars']['investments'][scheme['id']]['units']
                );
            }
        }
    }
}

dataCollectionSectionForm['funcs']['importNavs'] = function(thisButton, postData, lastNavToImport = false) {
    if (postData['scheme_id'] === '' || !postData['scheme_id']) {
        $(thisButton).removeClass('disabled');
        $(thisButton).children('i').attr('hidden', true);

        paginatedPNotify('error', 'Provide choose correct scheme.');

        return;
    }

    $.post('{{links.url("mf/extractdata/getAllNavData")}}', postData, function(response) {
        if ($(thisButton)[0].id !== '{{componentId}}-{{sectionId}}-importInvestmentNavs') {
            $(thisButton).removeClass('disabled');
            $(thisButton).children('i').attr('hidden', true);
        }

        if (response.responseCode == 0) {
            if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-importInvestmentNavs') {
                return;
            } else {
                paginatedPNotify('success', 'Import success. Please reselect the scheme.');
            }
        } else {
            if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-importInvestmentNavs') {
                $('#{{componentId}}-{{sectionId}}-buy, #{{componentId}}-{{sectionId}}-sell, ' +
                  '#{{componentId}}-{{sectionId}}-recalculate, .buyInvestment, .sellInvestment').attr('disabled', false);

                $('#{{componentId}}-{{sectionId}}-timeline').removeClass('disabled');

                return;
            } else {
                paginatedPNotify('error', response.responseMessage);
            }
        }

        if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-sell-import') {
            $('#{{componentId}}-{{sectionId}}-sell_transaction_id').val(0).trigger('change');
        } else {
            $('#{{componentId}}-{{sectionId}}-scheme_id').empty().trigger('change');
        }

        dataCollectionSectionForm['funcs']['cleanup']();

        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }
    }, 'json').done(function() {
        if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-importInvestmentNavs') {
            if (lastNavToImport) {
                dataCollectionSectionForm['funcs']['recalculatePortfolio']();
            }

            return;
        }
    });
}

dataCollectionSectionForm['funcs']['cleanup'] = function() {
    $('#{{componentId}}-{{sectionId}}-buy-isin').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-latest_nav').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-latest_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-first_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-amount').val('');

    $('#{{componentId}}-{{sectionId}}-sell-isin').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-latest_nav').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-latest_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-first_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-amount').val('');

    if (dataCollectionSectionForm['vars']['mode'] === 'transact' ||
        dataCollectionSectionForm['vars']['mode'] === 'timeline'
    ) {
        $('#{{componentId}}-{{sectionId}}-transaction_id').val('');
        $('#{{componentId}}-{{sectionId}}-buy-calculated_units').html('-');
        $('#{{componentId}}-{{sectionId}}-buy-amc_transaction_id').val('');
        $('#{{componentId}}-{{sectionId}}-buy-details').val('');
        $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').html('BUY');
        dataCollectionSection['{{componentId}}-{{sectionId}}-buy-date']['flatpickr'].config.minDate = '2000-01-01';
        dataCollectionSection['{{componentId}}-{{sectionId}}-buy-date']['flatpickr'].config.maxDate = 'today';
        dataCollectionSection['{{componentId}}-{{sectionId}}-buy-date']['flatpickr'].clear();
        dataCollectionSection['{{componentId}}-{{sectionId}}-sell-date']['flatpickr'].config.minDate = '2000-01-01';
        dataCollectionSection['{{componentId}}-{{sectionId}}-sell-date']['flatpickr'].config.maxDate = 'today';
        dataCollectionSection['{{componentId}}-{{sectionId}}-sell-date']['flatpickr'].clear();
        $('#{{componentId}}-{{sectionId}}-sell-units').val('');
        $('#{{componentId}}-{{sectionId}}-sell-available_amount').html('-');
        $('#{{componentId}}-{{sectionId}}-sell-available_units').html('-');
        $('#{{componentId}}-{{sectionId}}-sell-amc_transaction_id').val('');
        $('#{{componentId}}-{{sectionId}}-sell-details').val('');
        $('#{{componentId}}-{{sectionId}}-sell_all')[0].checked = false;
        $('#{{componentId}}-{{sectionId}}-sell-available_amount').parents('.col').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-sell-available_units').parents('.col').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-sell_all').parents('.col').attr('hidden', false);
        $('#buy-transactions-div').attr('hidden', true);
        $('#sell-transactions-div').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-buy-transactions-table tbody').html('');
        $('#{{componentId}}-{{sectionId}}-sell-transactions-table tbody').html('');
        $('.buy-transactions').children('label').html('TRANSACTIONS');
        $('.sell-transactions').children('label').html('TRANSACTIONS');
    }


    dataCollectionSectionForm['vars']['scheme'] = { };
}

dataCollectionSectionForm['funcs']['calculateBuyUnits'] = function() {
    if ($('#{{componentId}}-{{sectionId}}-buy-amount').val() !== '') {
        var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-buy-date').val()]['nav'];
        var units = (parseFloat($('#{{componentId}}-{{sectionId}}-buy-amount').val().replace(/,/g, '')) / nav).toFixed(3);
        $('#{{componentId}}-{{sectionId}}-buy-calculated_units').html(units);
    } else {
        $('#{{componentId}}-{{sectionId}}-buy-calculated_units').html('-');
    }
}

dataCollectionSectionForm['funcs']['calculateSellUnits'] = function() {
    if ($('#{{componentId}}-{{sectionId}}-sell-amount').val() !== '') {
        var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav'];
        var units = (parseFloat($('#{{componentId}}-{{sectionId}}-sell-amount').val().replace(/,/g, '')) / nav).toFixed(3);
        $('#{{componentId}}-{{sectionId}}-sell-units').val(units);

        if (units > dataCollectionSectionForm['vars']['investments'][dataCollectionSectionForm['vars']['scheme']['id']]['units']) {
            if ($('#{{componentId}}-{{sectionId}}-transaction_id').val() === '') {
                $('#{{componentId}}-{{sectionId}}-sell-units').addClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').addClass('is-invalid');
            } else {
                $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
            }
        } else {
            $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');
            $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
        }
    } else {
        $('#{{componentId}}-{{sectionId}}-sell-units').val('');
    }
    dataCollectionSectionForm['vars']['sellInput'] = 'amount';
}

dataCollectionSectionForm['funcs']['calculateSellAmount'] = function() {
    if ($('#{{componentId}}-{{sectionId}}-sell-units').val() !== '') {
        var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav'];
        var amount = ($('#{{componentId}}-{{sectionId}}-sell-units').val() * nav).toFixed(2);
        $('#{{componentId}}-{{sectionId}}-sell-amount').val(amount);

        if (parseFloat(amount) >
            (nav * dataCollectionSectionForm['vars']['investments'][dataCollectionSectionForm['vars']['scheme']['id']]['units']).toFixed(2)
        ) {
            if ($('#{{componentId}}-{{sectionId}}-transaction_id').val() === '') {
                $('#{{componentId}}-{{sectionId}}-sell-units').addClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').addClass('is-invalid');
            } else {
                $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
            }
        } else {
            $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');
            $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
        }
    } else {
        $('#{{componentId}}-{{sectionId}}-sell-amount').val('');
    }
    dataCollectionSectionForm['vars']['sellInput'] = 'units';
}

dataCollectionSectionForm['funcs']['enableBuySell'] = function(button) {
    if (button === 'buy' || button === 'buyInvestment') {
        if (button === 'buyInvestment') {
            $('#{{componentId}}-{{sectionId}}-buy-import').attr('disabled', true);
            $('#{{componentId}}-{{sectionId}}-buy-import').attr('hidden', true);
        } else {
            $('#{{componentId}}-{{sectionId}}-buy-import').attr('disabled', false);
            $('#{{componentId}}-{{sectionId}}-buy-import').attr('hidden', false);
        }

        $('#{{componentId}}-{{sectionId}}-buy-modal').modal('show');

        $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').off();
        $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').click(function(e) {
            e.preventDefault();

            dataCollectionSectionForm['funcs']['processTransaction']('buy');
        });
    } else if (button === 'sell' || button === 'sellInvestment') {
        if (button === 'sellInvestment') {
            $('#{{componentId}}-{{sectionId}}-sell-import').attr('disabled', true);
            $('#{{componentId}}-{{sectionId}}-sell-import').attr('hidden', true);
        } else {
            $('#{{componentId}}-{{sectionId}}-sell-import').attr('disabled', false);
            $('#{{componentId}}-{{sectionId}}-sell-import').attr('hidden', false);
        }

        $('#{{componentId}}-{{sectionId}}-sell-modal').modal('show');

        $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').off();
        $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').click(function(e) {
            e.preventDefault();

            dataCollectionSectionForm['funcs']['processTransaction']('sell');
        });
    }
}

dataCollectionSectionForm['funcs']['recalculatePortfolio'] = function() {
    var postData = { };

    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['portfolio_id'] = $('#{{componentId}}-{{sectionId}}-id').val();

    if (dataCollectionSectionForm['vars']['mode'] == 'timeline' &&
        dataCollectionSectionForm['vars']['timelineDate'] &&
        dataCollectionSectionForm['vars']['timelineDate'] !== ''
    ) {
        postData['timelineDate'] = dataCollectionSectionForm['vars']['timelineDate'];
    }

    $.post('{{links.url("mf/portfolios/recalculatePortfolio")}}', postData, function(response) {
        $('#{{componentId}}-{{sectionId}}-recalculate').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-recalculate').children('i').attr('hidden', true);

        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }

        if (response.responseCode === 0) {
            paginatedPNotify('success', {
                text : response.responseMessage
            });

            if (dataCollectionSectionForm['vars']['mode'] == 'timeline') {
                $('#{{componentId}}-{{sectionId}}-portfolios-link')
                    .attr(
                        'href',
                        dataCollection.env.httpScheme + '://' + dataCollection.env.httpHost + '/' + dataCollection.env.appRoute + '/' +
                        'mf/portfolios/q/id/' + dataCollectionSectionForm['vars']['portfolio']['id'] + '/mode/timeline/date/' +
                        dataCollectionSectionForm['vars']['timelineDate'] + '/browse/' +
                        $('#{{componentId}}-{{sectionId}}-portfolio_timeline_browser').val()
                    );
                dataCollectionSectionForm['funcs']['browse']();
            } else {
                dataCollectionSectionForm['funcs']['browse']();
            }
        } else {
            paginatedPNotify('error', {
                text : response.responseMessage
            });
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['calculateCategoriesPercentDiff'] = function(type, mainCategory, withCategory) {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['mainCategory'] = mainCategory[5];
    postData['withCategory'] = withCategory[5];

    $.post('{{links.url("mf/categories/calculateCategoriesPercentDiff")}}', postData, function(response) {
        if (response.responseCode == 0) {
            var html;

            if (mainCategory[5] < withCategory[5]) {
                html = '<span>Compare ' + mainCategory[1] + ' with ' + withCategory[1] + '</span>';
            } else {
                html = '<span>Compare ' + withCategory[1] + ' with ' + mainCategory[1] + '</span>';
            }

            html += ' <span class="text-bold">' + response.responseData.diff + '</span>';

            if (type === 'categories') {
                $('#{{componentId}}-{{sectionId}}-categories_percentage_variance').html(html);
            } else {
                $('#{{componentId}}-{{sectionId}}-subcategories_percentage_variance').html(html);
            }
        } else {
            paginatedPNotify('error', response.responseMessage);
        }

        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['init'] = function() {
    var swalSound = window['dataCollection'].env.sounds.swalSound;

    setTimeout(function(){
        dataCollectionSectionForm['funcs']['initDatatables']('investments');
        dataCollectionSectionForm['funcs']['initDatatables']('transactions');
        dataCollectionSectionForm['funcs']['initCharts']();
    }, 1000);

    $('#{{componentId}}-{{sectionId}}-buy, #{{componentId}}-{{sectionId}}-sell').off();
    $('#{{componentId}}-{{sectionId}}-buy, #{{componentId}}-{{sectionId}}-sell').click(function(e) {
        e.preventDefault();

        if ($(this)[0].id === '{{componentId}}-{{sectionId}}-buy') {
            dataCollectionSectionForm['funcs']['enableBuySell']('buy');
        } else if ($(this)[0].id === '{{componentId}}-{{sectionId}}-sell') {
            dataCollectionSectionForm['funcs']['enableBuySell']('sell');
        }
    });

    $('#{{componentId}}-{{sectionId}}-recalculate').off();
    $('#{{componentId}}-{{sectionId}}-recalculate').click(function(e) {
        e.preventDefault();

        // $(this).attr('disabled', true);
        $(this).children('i').attr('hidden', false);

        if (dataCollectionSectionForm['vars']['mode'] == 'timeline') {
            Swal.fire({
                html                        : '<span class="text-warning">Recalculate timeline from ' + dataCollectionSectionForm['vars']['timelineDate'] + '<span>',
                icon                        : 'question',
                background                  : 'rgba(0,0,0,.8)',
                backdrop                    : 'rgba(0,0,0,.6)',
                buttonsStyling              : false,
                confirmButtonText           : 'Proceed',
                customClass                 : {
                    'confirmButton'             : 'btn btn-warning text-uppercase',
                    'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
                },
                showCancelButton            : true,
                keydownListenerCapture      : true,
                allowOutsideClick           : true,
                allowEscapeKey              : true,
                didOpen                     : function() {
                    swalSound.play();
                }
            }).then((result) => {
                if (result.value) {
                    dataCollectionSectionForm['funcs']['recalculatePortfolio']();
                }
            });
        } else {
            dataCollectionSectionForm['funcs']['recalculatePortfolio']();
        }
    });

    $('#{{componentId}}-{{sectionId}}-buy-import, #{{componentId}}-{{sectionId}}-sell-import, #{{componentId}}-{{sectionId}}-importInvestmentNavs').off();
    $('#{{componentId}}-{{sectionId}}-buy-import, #{{componentId}}-{{sectionId}}-sell-import, #{{componentId}}-{{sectionId}}-importInvestmentNavs').click(function(e) {
        e.preventDefault();

        var thisButton = $(this);
        $(thisButton).addClass('disabled');
        $(thisButton).children('i').attr('hidden', false);

        var postData = { };
        postData[$('#security-token').attr('name')] = $('#security-token').val();
        postData['get_all_navs'] = true;

        if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-sell-import') {
            postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-sell_transaction_id option:selected').data()['value'];

            dataCollectionSectionForm['funcs']['importNavs'](thisButton, postData);
        } else if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-buy-import') {
            postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-scheme_id').val();

            dataCollectionSectionForm['funcs']['importNavs'](thisButton, postData);
        } else if ($(thisButton)[0].id === '{{componentId}}-{{sectionId}}-importInvestmentNavs') {
            if (Object.keys(dataCollectionSectionForm['vars']['portfolio']['investments']).length > 0) {
                $('#{{componentId}}-{{sectionId}}-buy, #{{componentId}}-{{sectionId}}-sell, ' +
                  '#{{componentId}}-{{sectionId}}-recalculate, .buyInvestment, .sellInvestment').attr('disabled', true);

                $('#{{componentId}}-{{sectionId}}-timeline').addClass('disabled');

                var lastInvestmentToImport =
                    Object.keys(dataCollectionSectionForm['vars']['portfolio']['investments'])[Object.keys(dataCollectionSectionForm['vars']['portfolio']['investments']).length - 1];

                for (var investment in dataCollectionSectionForm['vars']['portfolio']['investments']) {
                    if (dataCollectionSectionForm['vars']['portfolio']['investments'][investment]['scheme_id']) {
                        postData['scheme_id'] = dataCollectionSectionForm['vars']['portfolio']['investments'][investment]['scheme_id'];

                        if (investment === lastInvestmentToImport) {
                            dataCollectionSectionForm['funcs']['importNavs'](thisButton, postData, true);
                        } else {
                            dataCollectionSectionForm['funcs']['importNavs'](thisButton, postData);
                        }
                    }
                }
            }
        }
    });

    $('.viewTransaction').off();
    $('.viewTransaction').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var id = idArr[idArr.length - 1];

            $('#{{componentId}}-{{sectionId}}-transaction_id').val(dataCollectionSectionForm['vars']['transactions'][id]['id']);

            if (dataCollectionSectionForm['vars']['transactions'][id]['type'] === 'buy') {
                $('#{{componentId}}-{{sectionId}}-amc_id').val(dataCollectionSectionForm['vars']['transactions'][id]['amc_id']).trigger('change');
                $('#{{componentId}}-{{sectionId}}-amc_id').attr('disabled', true);

                $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', true);
                var newOption = new Option(
                    dataCollectionSectionForm['vars']['transactions'][id]['scheme']['name'],
                    dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id'],
                    false,
                    false
                );
                $('#{{componentId}}-{{sectionId}}-scheme_id').append(newOption).val(dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id']).trigger('change');

                dataCollectionSectionForm['funcs']['getSchemeDetails'](dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id'], 'buy', id, true);
            } else if (dataCollectionSectionForm['vars']['transactions'][id]['type'] === 'sell') {
                $('#{{componentId}}-{{sectionId}}-sell_transaction_id').attr('disabled', true);
                $('#{{componentId}}-{{sectionId}}-sell_transaction_id')
                    .val(dataCollectionSectionForm['vars']['investments'][dataCollectionSectionForm['vars']['transactions'][id]['scheme_id']]['id']).trigger('change');

                dataCollectionSectionForm['funcs']['getSchemeDetails'](dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id'], 'sell', id, true);
            }

            $('#{{componentId}}-{{sectionId}}-details').val(dataCollectionSectionForm['vars']['transactions'][id]['details']);
        });
    });

    $('.editTransaction').off();
    $('.editTransaction').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var id = idArr[idArr.length - 1];

            if (dataCollectionSectionForm['vars']['transactions'][id] &&
                dataCollectionSectionForm['vars']['transactions'][id]['status'] === 'open' &&
                dataCollectionSectionForm['vars']['transactions'][id]['units_sold'] == 0
            ) {
                $('#{{componentId}}-{{sectionId}}-amc_id').val(dataCollectionSectionForm['vars']['transactions'][id]['amc_id']).trigger('change');
                $('#{{componentId}}-{{sectionId}}-amc_id').attr('disabled', true);

                $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', true);
                var newOption = new Option(
                    dataCollectionSectionForm['vars']['transactions'][id]['scheme']['name'],
                    dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id'],
                    false,
                    false
                );
                $('#{{componentId}}-{{sectionId}}-scheme_id').append(newOption).val(dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id']).trigger('change');

                $('#{{componentId}}-{{sectionId}}-buy-import').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-buy-import').attr('hidden', false);

                dataCollectionSectionForm['funcs']['getSchemeDetails'](dataCollectionSectionForm['vars']['transactions'][id]['scheme']['id'], 'buy', id, false, true);
            } else {
                paginatedPNotify('error', {text : 'Cannot edit closed or transaction that has units sold!'});

                return;
            }
        });
    });

    $('.removeTransaction').off();
    $('.removeTransaction').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            Swal.fire({
                title                       : '<span class="text-danger"> Remove transaction?</span>',
                icon                        : 'question',
                background                  : 'rgba(0,0,0,.8)',
                backdrop                    : 'rgba(0,0,0,.6)',
                buttonsStyling              : false,
                confirmButtonText           : 'Remove',
                customClass                 : {
                    'confirmButton'             : 'btn btn-danger text-uppercase',
                    'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
                },
                showCancelButton            : true,
                keydownListenerCapture      : true,
                allowOutsideClick           : true,
                allowEscapeKey              : true,
                didOpen                     : function() {
                    swalSound.play();
                }
            }).then((result) => {
                if (result.value) {
                    var idArr = $(this)[0].id.split('-');
                    var id = idArr[idArr.length - 1];

                    if (dataCollectionSectionForm['vars']['transactions'][id]) {
                        $('#{{componentId}}-{{sectionId}}-transaction_id').val(dataCollectionSectionForm['vars']['transactions'][id]['id']);
                    }

                    dataCollectionSectionForm['funcs']['processTransaction']('', false, true);
                }
            });
        });
    });

    $('.buyInvestment').off();
    $('.buyInvestment').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var schemeId = idArr[idArr.length - 1];

            if (dataCollectionSectionForm['vars']['investments'][schemeId]) {
                $('#{{componentId}}-{{sectionId}}-amc_id').val(dataCollectionSectionForm['vars']['investments'][schemeId]['amc_id']).trigger('change');
                $('#{{componentId}}-{{sectionId}}-amc_id').attr('disabled', true);

                $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', true);
                var newOption = new Option(
                    dataCollectionSectionForm['vars']['investments'][schemeId]['scheme']['name'],
                    dataCollectionSectionForm['vars']['investments'][schemeId]['scheme_id'],
                    false,
                    false
                );
                $('#{{componentId}}-{{sectionId}}-scheme_id').append(newOption).val(dataCollectionSectionForm['vars']['investments'][schemeId]['scheme_id']).trigger('change');

                dataCollectionSectionForm['funcs']['getSchemeDetails'](dataCollectionSectionForm['vars']['investments'][schemeId]['scheme_id'], 'buy', null, false, true);

                dataCollectionSectionForm['funcs']['enableBuySell']('buyInvestment');
            } else {
                paginatedPNotify('error', {text : 'Investment with ID not found!'});

                return;
            }
        });
    });

    $('.sellInvestment').off();
    $('.sellInvestment').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var schemeId = idArr[idArr.length - 1];

            if (dataCollectionSectionForm['vars']['investments'][schemeId]) {
                $('#{{componentId}}-{{sectionId}}-sell_transaction_id').val(dataCollectionSectionForm['vars']['investments'][schemeId]['scheme_id']).trigger('change');
                $('#{{componentId}}-{{sectionId}}-sell_transaction_id').attr('disabled', true);

                dataCollectionSectionForm['funcs']['getSchemeDetails'](dataCollectionSectionForm['vars']['investments'][schemeId]['scheme_id'], 'sell', null, false, true);

                dataCollectionSectionForm['funcs']['enableBuySell']('sellInvestment');
            } else {
                paginatedPNotify('error', {text : 'Investment with ID not found!'});

                return;
            }
        });
    });

    $('.schemeInvestment').off();
    $('.schemeInvestment').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var schemeId = idArr[idArr.length - 1];

            $('#{{componentId}}-{{sectionId}}-portfolios-link')
                .attr(
                    'href',
                    dataCollection.env.httpScheme + '://' + dataCollection.env.httpHost + '/' + dataCollection.env.appRoute + '/' + 'mf/schemes/q/id/' + schemeId
                );

            dataCollectionSectionForm['funcs']['browse']();
        });
    });

    $('#{{componentId}}-{{sectionId}}-buy-modal, #{{componentId}}-{{sectionId}}-sell-modal').on('hide.bs.modal', function (e) {
        $('#{{componentId}}-{{sectionId}}-amc_id').val(0).trigger('change');
        $('#{{componentId}}-{{sectionId}}-amc_id').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-scheme_id').empty().trigger('change');
        $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-sell_transaction_id').val(0).trigger('change');
        $('#{{componentId}}-{{sectionId}}-sell_transaction_id').attr('disabled', false);
        dataCollectionSectionForm['funcs']['cleanup']();
    });

    $('#{{componentId}}-{{sectionId}}-buy-amount').keyup(function() {
        dataCollectionSectionForm['funcs']['calculateBuyUnits']();
    });

    $('#{{componentId}}-{{sectionId}}-sell-amount').keyup(function() {
        dataCollectionSectionForm['funcs']['calculateSellUnits']();
    });

    $('#{{componentId}}-{{sectionId}}-sell-units').keyup(function() {
        dataCollectionSectionForm['funcs']['calculateSellAmount']();
    });
}

dataCollectionSectionForm['funcs']['initDatatables'] = function(type) {
    if (type === 'investments') {
        if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-investments-table')) {
            var investmentColumns =
                [
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: false}
                ];

            if (dataCollectionSectionForm['vars']['mode'] === 'timeline') {
                investmentColumns =
                    [
                        {orderable: true},
                        {orderable: true},
                        {orderable: true},
                        {orderable: true},
                        {orderable: true},
                        {orderable: true},
                        {orderable: true},
                        {orderable: true},
                        {orderable: true},
                        {orderable: false}
                    ];
            }

            $('#{{componentId}}-{{sectionId}}-investments-table').DataTable({
                columns: investmentColumns,
                lengthMenu: [
                    [20, 50, 100, -1],
                    [20, 50, 100, 'All']
                ],
                dom: '<"row mb-1"<"col-md-3 col-xs-12"B><"col-md-3 col-xs-12"l><"col-md-3 col-xs-12"f><"col-md-3 col-xs-12"p>>' +
                     '<"row mb-1"<"col"tr>>' +
                     '<"row"<"col-md-6 col-xs-12"i><"col-md-6 col-xs-12"p>>',
                buttons: [
                    {
                        extend          : 'collection',
                        text            : 'Export',
                        className       : 'btn-sm btn-info',
                        buttons         : [{
                                            text            : 'Excel',
                                            title           : 'Export transactions list',
                                            extend          : 'excelHtml5',
                                            footer          : false,
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        },
                                        {
                                            text            : 'CSV',
                                            extend          : 'csvHtml5',
                                            fieldSeparator  : ',',
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        }
                                        ]
                    }
                ]
            });
        }
    }

    if (type === 'transactions') {
        if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-transactions-table')) {
            var transactionColumns =
                [
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false}
                ];

            if (dataCollectionSectionForm['vars']['mode'] === 'timeline') {
                transactionColumns =
                    [
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false},
                        {orderable: false}
                    ];
            }
            $('#{{componentId}}-{{sectionId}}-transactions-table').DataTable({
                columns: transactionColumns,
                order: false,
                lengthMenu: [
                    [20, 50, 100, -1],
                    [20, 50, 100, 'All']
                ],
                dom: '<"row mb-1"<"col-md-3 col-xs-12"B><"col-md-3 col-xs-12"l><"col-md-3 col-xs-12"f><"col-md-3 col-xs-12"p>>' +
                     '<"row mb-1"<"col"tr>>' +
                     '<"row"<"col-md-6 col-xs-12"i><"col-md-6 col-xs-12"p>>',
                buttons: [
                    {
                        extend          : 'collection',
                        text            : 'Export',
                        className       : 'btn-sm btn-info',
                        buttons         : [{
                                            text            : 'Excel',
                                            title           : 'Export transactions list',
                                            extend          : 'excelHtml5',
                                            footer          : false,
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        },
                                        {
                                            text            : 'CSV',
                                            extend          : 'csvHtml5',
                                            fieldSeparator  : ',',
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        }
                                        ]
                    }
                ]
            });
        }
    }

    if (type === 'strategies-transactions') {
        if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-strategies-transactions-table')) {
            dataCollectionSectionForm['vars']['strategiesTransactionsTable'] = $('#{{componentId}}-{{sectionId}}-strategies-transactions-table').DataTable({
                columns: [
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false}
                ],
                order: false,
                lengthMenu: [
                    [20, 50, 100, -1],
                    [20, 50, 100, 'All']
                ],
                dom: '<"row mb-1"<"col-md-3 col-xs-12"B><"col-md-3 col-xs-12"l><"col-md-3 col-xs-12"f><"col-md-3 col-xs-12"p>>' +
                     '<"row mb-1"<"col"tr>>' +
                     '<"row"<"col-md-6 col-xs-12"i><"col-md-6 col-xs-12"p>>',
                buttons: [
                    {
                        extend          : 'collection',
                        text            : 'Export',
                        className       : 'btn-sm btn-info',
                        buttons         : [{
                                            text            : 'Excel',
                                            title           : 'Export transactions list',
                                            extend          : 'excelHtml5',
                                            footer          : false,
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        },
                                        {
                                            text            : 'CSV',
                                            extend          : 'csvHtml5',
                                            fieldSeparator  : ',',
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        }
                                        ]
                    }
                ]
            });
        }
    }

    if (type === 'allocation-schemes') {
        if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-allocation-schemes-table')) {
            $('#{{componentId}}-{{sectionId}}-allocation-schemes-table').DataTable({
                columns: [
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true}
                ],
                lengthMenu: [
                    [20, 50, 100, -1],
                    [20, 50, 100, 'All']
                ],
                dom: '<"row mb-1"<"col-md-3 col-xs-12"B><"col-md-3 col-xs-12"l><"col-md-3 col-xs-12"f><"col-md-3 col-xs-12"p>>' +
                     '<"row mb-1"<"col"tr>>' +
                     '<"row"<"col-md-6 col-xs-12"i><"col-md-6 col-xs-12"p>>',
                buttons: [
                    {
                        extend          : 'collection',
                        text            : 'Export',
                        className       : 'btn-sm btn-info',
                        buttons         : [{
                                            text            : 'Excel',
                                            title           : 'Export transactions list',
                                            extend          : 'excelHtml5',
                                            footer          : false,
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        },
                                        {
                                            text            : 'CSV',
                                            extend          : 'csvHtml5',
                                            fieldSeparator  : ',',
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        }
                                        ]
                    }
                ]
            });
        }
    }

    if (type === 'allocation-categories') {
        if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-allocation-categories-table')) {
            var categoriesTable = $('#{{componentId}}-{{sectionId}}-allocation-categories-table').DataTable({
                columns: [
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true}
                ],
                lengthMenu: [
                    [20, 50, 100, -1],
                    [20, 50, 100, 'All']
                ],
                select: {
                    style: 'multi'
                },
                dom: '<"row mb-1"<"col-md-3 col-xs-12"B><"col-md-3 col-xs-12"l><"col-md-3 col-xs-12"f><"col-md-3 col-xs-12"p>>' +
                     '<"row mb-1"<"col"tr>>' +
                     '<"row"<"col-md-6 col-xs-12"i><"col-md-6 col-xs-12"p>>',
                buttons: [
                    {
                        extend          : 'collection',
                        text            : 'Export',
                        className       : 'btn-sm btn-info',
                        buttons         : [{
                                            text            : 'Excel',
                                            title           : 'Export transactions list',
                                            extend          : 'excelHtml5',
                                            footer          : false,
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        },
                                        {
                                            text            : 'CSV',
                                            extend          : 'csvHtml5',
                                            fieldSeparator  : ',',
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        }
                                        ]
                    }
                ]
            });

            categoriesTable.on('select', function(e, dt, type, ix) {
                var selected = dt.rows({selected: true});

                if (selected.count() > 2) {
                    dt.rows(ix).deselect();
                } else if (selected.count() === 2) {
                    var select1 = dt.rows({selected: true}).data()[0];
                    var select2 = dt.rows({selected: true}).data()[1];

                    dataCollectionSectionForm['funcs']['calculateCategoriesPercentDiff']('categories', select1, select2);
                }
            });

            categoriesTable.on('deselect', function(e, dt, type, ix) {
                var deselected = dt.rows({selected: true});

                if (deselected.count() > 0) {
                    $('#{{componentId}}-{{sectionId}}-categories_percentage_variance').html('Please select 2 categories...');
                }
            });
        }
    }

    if (type === 'allocation-subcategories') {
        if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-allocation-subcategories-table')) {
            var subcategoriesTable = $('#{{componentId}}-{{sectionId}}-allocation-subcategories-table').DataTable({
                columns: [
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true},
                    {orderable: true}
                ],
                lengthMenu: [
                    [20, 50, 100, -1],
                    [20, 50, 100, 'All']
                ],
                select: {
                    style: 'multi'
                },
                dom: '<"row mb-1"<"col-md-3 col-xs-12"B><"col-md-3 col-xs-12"l><"col-md-3 col-xs-12"f><"col-md-3 col-xs-12"p>>' +
                     '<"row mb-1"<"col"tr>>' +
                     '<"row"<"col-md-6 col-xs-12"i><"col-md-6 col-xs-12"p>>',
                buttons: [
                    {
                        extend          : 'collection',
                        text            : 'Export',
                        className       : 'btn-sm btn-info',
                        buttons         : [{
                                            text            : 'Excel',
                                            title           : 'Export transactions list',
                                            extend          : 'excelHtml5',
                                            footer          : false,
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        },
                                        {
                                            text            : 'CSV',
                                            extend          : 'csvHtml5',
                                            fieldSeparator  : ',',
                                            exportOptions   : {
                                                                columns: ':visible'
                                                            }
                                        }
                                        ]
                    }
                ]
            });

            subcategoriesTable.on('select', function(e, dt, type, ix) {
                var selected = dt.rows({selected: true});

                if (selected.count() > 2) {
                    dt.rows(ix).deselect();
                } else if (selected.count() === 2) {
                    var select1 = dt.rows({selected: true}).data()[0];
                    var select2 = dt.rows({selected: true}).data()[1];

                    dataCollectionSectionForm['funcs']['calculateCategoriesPercentDiff']('subcategories', select1, select2);
                }
            });

            subcategoriesTable.on('deselect', function(e, dt, type, ix) {
                var deselected = dt.rows({selected: true});

                if (deselected.count() > 0) {
                    $('#{{componentId}}-{{sectionId}}-subcategories_percentage_variance').html('Please select 2 subcategories...');
                }
            });
        }
    }
}

dataCollectionSectionForm['funcs']['initCharts'] = function() {
    if (Object.keys(dataCollectionSectionForm['vars']['allocation']).length > 0) {
        if (dataCollectionSectionForm['vars']['allocation']['by_schemes'] &&
            Object.keys(dataCollectionSectionForm['vars']['allocation']['by_schemes']).length > 0
        ) {
            dataCollectionSectionForm['funcs']['initDatatables']('allocation-schemes');

            var byScehemesData = [];
            for (var schemesInitData in dataCollectionSectionForm['vars']['allocation']['by_schemes']) {
                byScehemesData.push(dataCollectionSectionForm['vars']['allocation']['by_schemes'][schemesInitData]);
            }

            dataCollectionSectionForm['vars']['allocationCharts']['by_schemes'] = { };

            var bySchemesCharts = ['amount', 'percent'];

            $(bySchemesCharts).each(function(index, value) {
                dataCollectionSectionForm['vars']['allocationCharts']['by_schemes'][value] = echarts.init(document.getElementById('allocation-schemes-' + value), 'macarons');

                dataCollectionSectionForm['vars']['allocationCharts']['by_schemes'][value].on('rendered', function() {
                    if (dataCollectionSectionForm['vars']['allocationCharts'] &&
                        dataCollectionSectionForm['vars']['allocationCharts']['by_schemes'] &&
                        dataCollectionSectionForm['vars']['allocationCharts']['by_schemes'][value]
                    ) {
                        dataCollectionSectionForm['vars']['allocationCharts']['by_schemes'][value].resize({
                            height: 400
                        });
                    }
                });

                dataCollectionSectionForm['funcs']['generateAllocationCharts']('schemes', byScehemesData, value);
            });
        }

        if (dataCollectionSectionForm['vars']['allocation']['by_categories'] &&
            Object.keys(dataCollectionSectionForm['vars']['allocation']['by_categories']).length > 0
        ) {
            dataCollectionSectionForm['funcs']['initDatatables']('allocation-categories');

            var byCategoriesData = [];
            for (var categoriesInitData in dataCollectionSectionForm['vars']['allocation']['by_categories']) {
                byCategoriesData.push(dataCollectionSectionForm['vars']['allocation']['by_categories'][categoriesInitData]);
            }

            dataCollectionSectionForm['vars']['allocationCharts']['by_categories'] = { };

            var byCategoriesCharts = ['amount', 'percent'];

            $(byCategoriesCharts).each(function(index, value) {
                dataCollectionSectionForm['vars']['allocationCharts']['by_categories'][value] = echarts.init(document.getElementById('allocation-categories-' + value), 'macarons');

                dataCollectionSectionForm['vars']['allocationCharts']['by_categories'][value].on('rendered', function() {
                    if (dataCollectionSectionForm['vars']['allocationCharts'] &&
                        dataCollectionSectionForm['vars']['allocationCharts']['by_categories'] &&
                        dataCollectionSectionForm['vars']['allocationCharts']['by_categories'][value]
                    ) {
                        dataCollectionSectionForm['vars']['allocationCharts']['by_categories'][value].resize({
                            height: 400
                        });
                    }
                });

                dataCollectionSectionForm['funcs']['generateAllocationCharts']('categories', byCategoriesData, value);
            });
        }

        if (dataCollectionSectionForm['vars']['allocation']['by_subcategories'] &&
            Object.keys(dataCollectionSectionForm['vars']['allocation']['by_subcategories']).length > 0
        ) {
            dataCollectionSectionForm['funcs']['initDatatables']('allocation-subcategories');

            var bySubcategoriesData = [];
            for (var subcategoriesInitData in dataCollectionSectionForm['vars']['allocation']['by_subcategories']) {
                bySubcategoriesData.push(dataCollectionSectionForm['vars']['allocation']['by_subcategories'][subcategoriesInitData]);
            }

            dataCollectionSectionForm['vars']['allocationCharts']['by_subcategories'] = { };

            var bySubcategoriesCharts = ['amount', 'percent'];

            $(bySubcategoriesCharts).each(function(index, value) {
                dataCollectionSectionForm['vars']['allocationCharts']['by_subcategories'][value] = echarts.init(document.getElementById('allocation-subcategories-' + value), 'macarons');

                dataCollectionSectionForm['vars']['allocationCharts']['by_subcategories'][value].on('rendered', function() {
                    if (dataCollectionSectionForm['vars']['allocationCharts'] &&
                        dataCollectionSectionForm['vars']['allocationCharts']['by_subcategories'] &&
                        dataCollectionSectionForm['vars']['allocationCharts']['by_subcategories'][value]
                    ) {
                        dataCollectionSectionForm['vars']['allocationCharts']['by_subcategories'][value].resize({
                            height: 400
                        });
                    }
                });

                dataCollectionSectionForm['funcs']['generateAllocationCharts']('subcategories', bySubcategoriesData, value);
            });
        }
    }
}

dataCollectionSectionForm['funcs']['generateAllocationCharts'] = function(by, data, value, type = 'bar') {
    var options = {
        title: {
            text: 'INVESTMENTS VS RETURNS (' + value.toUpperCase() + ')'
        },
        tooltip: {
            trigger: 'axis',
            textStyle: {
                align: 'left'
            },
            axisPointer: {
              type: 'shadow'
            }
        },
        legend: {},
        xAxis: {
            name: by.toUpperCase(),
            nameLocation: 'middle',
            nameTextStyle: {
                lineHeight: 50
            },
            data: []
        },
        yAxis: {
            name: value.toUpperCase(),
            nameRotate: 90,
            nameLocation: "middle",
            nameTextStyle: {
                lineHeight: 60,
            }
        },
        series: [
            {
                type: type,
                data: [],
            }
        ]
    }

    var series = [
        {
            type: type,
            name: 'INVESTED',
            data: data.map(row => row['invested_' + value])
        },
        {
            type: type,
            name: 'RETURN',
            data: data.map(row => row['return_' + value])
        }
    ];

    var xData = [];
    var yData = [];

    if (by === 'schemes') {
        xData = data.map(row => row.scheme_id)
    } else {
        xData = data.map(row => row.category.name);
    }

    options['xAxis']['name'] = by.toUpperCase();
    options['yAxis']['name'] = value.toUpperCase();
    if (value === 'amount') {
        options['yAxis']['nameTextStyle']['lineHeight'] = 100;
    } else {
        options['yAxis']['nameTextStyle']['lineHeight'] = 60;
    }
    options['xAxis']['data'] = xData;
    options['series'] = series
    dataCollectionSectionForm['vars']['allocationCharts']['by_' + by][value].setOption(options);
}

dataCollectionSectionForm['funcs']['browseTimeline'] = function(postData, thisButton = null) {
    $.post('{{links.url("mf/portfolios/getPortfolioTimelineDateByBrowseAction")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }

        if (response.responseCode === 0) {
            if (response.responseData.browse_date) {
                if (postData['browse']) {
                    dataCollectionSectionForm['funcs']['browseToTimelineDate'](response.responseData.browse_date, '/browse/' + postData['browse']);
                } else {
                    dataCollectionSectionForm['funcs']['browseToTimelineDate'](response.responseData.browse_date);
                }
            }
        } else if (response.responseCode === 2) {
            var swalSound = window['dataCollection'].env.sounds.swalSound;
            var swalTitle = '<span class="text-warning">' + response.responseMessage + '</span>';
            var swalHtml;
            if (response.responseData.start_date) {
                swalHtml = '<span class="text-info">Portfolio starts at ' + response.responseData.start_date + '</span>';
            } else if (response.responseData.end_date) {
                swalHtml = '<span class="text-info">Portfolio ends at ' + response.responseData.end_date + '</span>';
            } else if (response.responseData.transaction_end_date) {
                swalHtml = '<span class="text-info">Portfolio transactions end at ' + response.responseData.transaction_end_date + '</span>';
            }
            Swal.fire({
                title                       : swalTitle,
                html                        : swalHtml,
                icon                        : 'warning',
                background                  : 'rgba(0,0,0,.8)',
                backdrop                    : 'rgba(0,0,0,.6)',
                buttonsStyling              : false,
                confirmButtonText           : 'Browse',
                customClass                 : {
                    'confirmButton'             : 'btn btn-info text-uppercase',
                    'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
                },
                showCancelButton            : true,
                keydownListenerCapture      : true,
                allowOutsideClick           : true,
                allowEscapeKey              : true,
                didOpen                     : function() {
                    swalSound.play();
                }
            }).then((result) => {
                if (result.value) {
                    var dateToBrowse;

                    if (response.responseData.start_date) {
                        dateToBrowse = response.responseData.start_date;
                    } else if (response.responseData.end_date) {
                        dateToBrowse = response.responseData.end_date;
                    } else if (response.responseData.transaction_end_date) {
                        dateToBrowse = response.responseData.transaction_end_date;
                    }

                    dataCollectionSectionForm['funcs']['browseToTimelineDate'](dateToBrowse);
                } else {
                    if (thisButton) {
                        $(thisButton).attr('disabled', false);

                        if (postData['jump'] === 'start') {
                            $(thisButton).children('i').removeClass('fa-spin fa-cog').addClass('fa-backward-fast');
                        } else if (postData['jump'] === 'previous') {
                            $(thisButton).children('i').removeClass('fa-spin fa-cog').addClass('fa-backward-step');
                        } else if (postData['jump'] === 'next') {
                            $(thisButton).children('i').removeClass('fa-spin fa-cog').addClass('fa-forward-step');
                        } else if (postData['jump'] === 'today') {
                            $(thisButton).children('i').removeClass('fa-spin fa-cog').addClass('fa-forward-fast');
                        }
                    }
                }
            });
        } else {
            paginatedPNotify('error', {
                text : response.responseMessage
            });
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['browseToTimelineDate'] = function(dateToBrowse, additionalUrlString = '/') {
    $('#{{componentId}}-{{sectionId}}-portfolios-link')
        .attr(
            'href',
            dataCollection.env.httpScheme + '://' + dataCollection.env.httpHost + '/' + dataCollection.env.appRoute + '/' +
            'mf/portfolios/q/id/' + dataCollectionSectionForm['vars']['portfolio']['id'] + '/mode/timeline/date/' +
            dateToBrowse +
            additionalUrlString
        );

    dataCollectionSectionForm['funcs']['browse']();
}

dataCollectionSectionForm['funcs']['browse'] = function() {
    BazContentLoader.loadAjax($('#{{componentId}}-{{sectionId}}-portfolios-link'), {
        ajaxBefore                      : function () {
                                            Pace.restart();
                                            $("#baz-content").empty();
                                            $("#loader").attr('hidden', false);
                                        },
        ajaxFinished                    : function () {
                                            BazCore.updateBreadcrumb();
                                            $("#loader").attr('hidden', true);
                                        },
        ajaxError                       : function () {
                                            $("#loader").attr('hidden', true);
                                            BazCore.updateBreadcrumb();
                                        }
    });
}

$(document).ready(function() {
    dataCollectionSectionForm['funcs']['init']();
});
</script>
    {% endif %}
{% endif %}