{% set disableUser = false %}
{% if portfolio['id'] is defined %}
    {% set portfolioId = portfolio['id'] %}
    {% set portfolioName = portfolio['name'] %}
    {% set portfolioUser = portfolio['user_id'] %}
    {% set portfolioDescription = portfolio['description'] %}
    {% set portfolioInvestedAmount = portfolio['invested_amount'] %}
    {% set portfolioTotalValue = portfolio['total_value'] %}
    {% set portfolioProfitLoss = portfolio['profit_loss'] %}
    {% set portfolioXirr = portfolio['xirr'] ~ '%' %}
    {% set disableUser = true %}
{% else %}
    {% set portfolio = [] %}
    {% set portfolioId = '' %}
    {% set portfolioName = '' %}
    {% set portfolioUser = '' %}
    {% set portfolioDescription = '' %}
    {% set portfolioInvestedAmount = '0.00' %}
    {% set portfolioTotalValue = '0.00' %}
    {% set portfolioProfitLoss = '0.00' %}
    {% set portfolioXirr = '0%' %}
{% endif %}
<form data-validateon="section" id="{{componentId}}-{{sectionId}}-form">
    <fieldset id="{{componentId}}-{{sectionId}}-fieldset">
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'id',
                        'fieldLabel'                     : 'ID',
                        'fieldType'                      : 'input',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'ID',
                        'fieldRequired'                  : true,
                        'fieldBazScan'                   : true,
                        'fieldBazPostOnCreate'           : false,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldHidden'                    : true,
                        'fieldDisabled'                  : true,
                        'fieldValue'                     : portfolioId
                    ]
                )}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'name',
                        'fieldLabel'                     : 'Name',
                        'fieldType'                      : 'input',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Name',
                        'fieldRequired'                  : true,
                        'fieldBazScan'                   : true,
                        'fieldBazJstreeSearch'           : true,
                        'fieldBazPostOnCreate'           : true,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldDataInputMinLength'        : 1,
                        'fieldDataInputMaxLength'        : 50,
                        'fieldValue'                     : portfolioName
                    ]
                )}}
            </div>
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'user_id',
                        'fieldLabel'                     : 'User',
                        'fieldType'                      : 'select2',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'User',
                        'fieldRequired'                  : true,
                        'fieldDisabled'                  : disableUser,
                        'fieldBazScan'                   : true,
                        'fieldBazPostOnCreate'           : true,
                        'fieldBazPostOnUpdate'           : false,
                        'fieldDataSelect2Options'        : users,
                        'fieldDataSelect2OptionsKey'     : 'id',
                        'fieldDataSelect2OptionsValue'   : 'name',
                        'fieldDataSelect2OptionsArray'   : true,
                        'fieldDataSelect2OptionsSelected': portfolioUser
                    ]
                )}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'description',
                        'fieldLabel'                     : 'Description',
                        'fieldType'                      : 'textarea',
                        'fieldDataMaxLength'             : 4096,
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Description of the portfolio',
                        'fieldRequired'                  : false,
                        'fieldBazScan'                   : true,
                        'fieldBazJstreeSearch'           : true,
                        'fieldBazPostOnCreate'           : true,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldDataInputMaxLength'        : 1024,
                        'fieldTextareaRows'              : 2,
                        'fieldValue'                     : portfolioDescription
                    ]
                )}}
            </div>
        </div>
        {% if portfolio['id'] is defined %}
            <div class="row">
                <div class="col">
                    {{adminltetags.useTag('fields',
                        [
                            'component'                      : component,
                            'componentName'                  : componentName,
                            'componentId'                    : componentId,
                            'sectionId'                      : sectionId,
                            'fieldId'                        : 'invested_amount',
                            'fieldLabel'                     : 'Invested Amount',
                            'fieldType'                      : 'html',
                            'fieldHelp'                      : true,
                            'fieldHelpTooltipContent'        : 'Invested Amount',
                            'fieldRequired'                  : false,
                            'fieldBazScan'                   : true,
                            'fieldBazPostOnUpdate'           : true,
                            'fieldHtmlContent'               : currencySymbol ~ portfolioInvestedAmount
                        ]
                    )}}
                </div>
                <div class="col">
                    {{adminltetags.useTag('fields',
                        [
                            'component'                      : component,
                            'componentName'                  : componentName,
                            'componentId'                    : componentId,
                            'sectionId'                      : sectionId,
                            'fieldId'                        : 'total_value',
                            'fieldLabel'                     : 'Total value',
                            'fieldType'                      : 'html',
                            'fieldHelp'                      : true,
                            'fieldHelpTooltipContent'        : 'Total value',
                            'fieldRequired'                  : false,
                            'fieldBazScan'                   : true,
                            'fieldBazPostOnUpdate'           : true,
                            'fieldHtmlContent'               : currencySymbol ~ portfolioTotalValue
                        ]
                    )}}
                </div>
                <div class="col">
                    {{adminltetags.useTag('fields',
                        [
                            'component'                      : component,
                            'componentName'                  : componentName,
                            'componentId'                    : componentId,
                            'sectionId'                      : sectionId,
                            'fieldId'                        : 'profit_loss',
                            'fieldLabel'                     : 'Profit/Loss',
                            'fieldType'                      : 'html',
                            'fieldHelp'                      : true,
                            'fieldHelpTooltipContent'        : 'Profit/Loss.',
                            'fieldRequired'                  : false,
                            'fieldBazScan'                   : true,
                            'fieldBazPostOnUpdate'           : true,
                            'fieldHtmlContent'               : currencySymbol ~ portfolioProfitLoss
                        ]
                    )}}
                </div>
                <div class="col">
                    {{adminltetags.useTag('fields',
                        [
                            'component'                      : component,
                            'componentName'                  : componentName,
                            'componentId'                    : componentId,
                            'sectionId'                      : sectionId,
                            'fieldId'                        : 'xirr',
                            'fieldLabel'                     : 'Xirr',
                            'fieldType'                      : 'html',
                            'fieldHelp'                      : true,
                            'fieldHelpTooltipContent'        : 'XIRR of portfolio',
                            'fieldRequired'                  : false,
                            'fieldBazScan'                   : true,
                            'fieldBazPostOnUpdate'           : true,
                            'fieldHtmlContent'               : portfolioXirr
                        ]
                    )}}
                </div>
            </div>
            <div class="row">
                <div class="col">
                    {{adminltetags.useTag('buttons',
                        [
                        'component'                     : component,
                        'componentName'                 : componentName,
                        'componentId'                   : componentId,
                        'parentComponentId'             : parent,
                        'sectionId'                     : sectionId,
                        'buttonType'                    : 'button',
                        'buttons'                       :
                                [
                                    'recalculate' : [
                                        'title'                   : 'Recalculate',
                                        'size'                    : 'xs',
                                        'type'                    : 'primary',
                                        'position'                : 'right',
                                        'icon'                    : 'cog fa-spin',
                                        'iconHidden'              : true
                                    ]
                                ]
                        ]
                    )}}
                </div>
            </div>
    </fieldset>
</form>
{% endif %}
{% set transactions = [] %}
{% if portfolio['id'] is defined %}
    <hr>
    <div class="row">
        <div class="col">
            {% set url = links.url('mf/portfolios/q/id/' ~ portfolio['id']) %}
            {% if mode == 'timeline' %}
                {% set url = links.url('mf/portfolios/q/mode/timeline/id/' ~ portfolio['id']) %}
            {% endif %}
            {{adminltetags.useTag('buttons',
                [
                    'component'                      : component,
                    'componentName'                  : componentName,
                    'componentId'                    : componentId,
                    'sectionId'                      : sectionId,
                    'buttonType'                    : 'button',
                    'buttons'                       :
                        [
                            'portfolios-link'    : [
                                'title'                   : 'link',
                                'size'                    : 'xs',
                                'disabled'                : true,
                                'hidden'                  : true,
                                'url'                     : url
                            ]
                        ]
                ]
            )}}
        </div>
        <div class="col">
            {{adminltetags.useTag('buttons',
                [
                'component'                     : component,
                'componentName'                 : componentName,
                'componentId'                   : componentId,
                'parentComponentId'             : parent,
                'sectionId'                     : sectionId,
                'buttonType'                    : 'button',
                'buttons'                       :
                        [
                            'sell' : [
                                'title'                   : 'Sell',
                                'size'                    : 'xs',
                                'type'                    : 'warning',
                                'position'                : 'right',
                                'icon'                    : 'minus'
                            ],
                            'buy' : [
                                'title'                   : 'Buy',
                                'size'                    : 'xs',
                                'type'                    : 'success',
                                'position'                : 'right',
                                'icon'                    : 'plus'
                            ]
                        ]
                ]
            )}}
        </div>
    </div>
    {% set transactionsHtml = '' %}
    {% if portfolio['transactions'] is defined and portfolio['transactions']|length > 0 %}
        {% for transaction in portfolio['transactions'] %}
            {% set textColor = 'success' %}
            {% if transaction['type'] == 'buy' %}
                {% if transaction['latest_value'] != 0 %}
                    {% set latestValue = '<span class="text-' ~textColor ~ '">' ~ transaction['latest_value'] ~ '</span>' %}
                    {% if transaction['cagr'] is defined %}
                        {% if str_contains(transaction['cagr'], '-') %}
                            {% set textColor = 'danger' %}
                        {% endif %}
                        {% set latestValue = '<span class="text-' ~textColor ~ '">' ~ transaction['latest_value'] ~ ' (' ~ transaction['diff'] ~ '/' ~ transaction['cagr'] ~ '%)</span>' %}
                    {% endif %}
                {% else %}
                    {% set latestValue = '-' %}
                    {% set transaction['latest_value_date'] = '-' %}
                {% endif %}
            {% else %}
                {% set latestValue = '-' %}
                {% set transaction['latest_value_date'] = '-' %}
            {% endif %}
            {% set transactionsHtml = transactionsHtml ~ '<tr>' ~
            '           <td>' ~ transaction['id'] ~ '</td>' ~
            '           <td>' ~ transaction['date'] ~ '</td>' ~
            '           <td>' ~ strtoupper(transaction['type']) ~ '</td>' ~
            '           <td>' ~ strtoupper(transaction['status']) ~ '</td>' ~
            '           <td>' ~ transaction['amfi_code'] ~ '</td>' ~
            '           <td>' ~ transaction['units_bought'] ~ ' (' ~ transaction['units_sold'] ~ ')</td>' ~
            '           <td>' ~ transaction['amount'] ~ '</td>' ~
            '           <td>' ~ transaction['latest_value_date'] ~ '</td>' ~
            '           <td>' ~ latestValue ~ '</td>' ~
            '           <td>' %}
                {% set dropdowns = [] %}
                {% set dropdowns['edit-' ~ transaction['id']] = [
                        'title'             : 'edit',
                        'size'              : 'xs',
                        'type'              : 'warning',
                        'additionalClass'   : 'editTransaction'
                    ]
                %}
                {% set dropdowns['remove-' ~ transaction['id']] = [
                        'title'             : 'remove',
                        'size'              : 'xs',
                        'type'              : 'warning',
                        'additionalClass'   : 'removeTransaction'
                    ]
                %}
            {% set transactionsHtml = transactionsHtml ~
                adminltetags.useTag('buttons',
                    [
                        'component'                     : component,
                        'componentName'                 : componentName,
                        'componentId'                   : componentId,
                        'parentComponentId'             : parent,
                        'sectionId'                     : sectionId,
                        'buttonType'                    : 'DropdownSplitButtons',
                        'dropdownSplitButtonsSplit'     : true,
                        'dropdownAlign'                 : 'right',
                        'splitMainButtonAdditionalClass': 'viewTransaction',
                        'splitMainButtonId'             : 'view-' ~ transaction['id'],
                        'splitMainButtonTitle'          : 'View',
                        'buttonFlat'                    : true,
                        'splitMainButtonType'           : 'info',
                        'dropdowns'                     : dropdowns
                    ]
                )
            ~ '</td>' ~
            '       </tr>' %}
            {% set transactions[transaction['id']] = transaction %}
        {% endfor %}
    {% endif %}
    <label>PORTFOLIO TRANSACTIONS</label>
    <div class="row" id="transactions-table">
        <div class="col">
            <table id="{{componentId}}-{{sectionId}}-transactions-table" class="table table-sm table-hover responsive nowrap mb-0" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th class="text-uppercase">ID</th>
                        <th class="text-uppercase">DATE</th>
                        <th class="text-uppercase">TYPE</th>
                        <th class="text-uppercase">Status</th>
                        <th class="text-uppercase">SCHEME</th>
                        <th class="text-uppercase">UNITS (Sold)</th>
                        <th class="text-uppercase">{{ currencySymbol }} AMOUNT</th>
                        <th class="text-uppercase">Latest Value Date</th>
                        <th class="text-uppercase">{{ currencySymbol }} Latest Value (Diff/CAGR)</th>
                        <th class="text-uppercase">ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    {{transactionsHtml}}
                </tbody>
            </table>
        </div>
    </div>
    <div>
        {{adminltetags.useTag('modal',
            [
                'component'                 : component,
                'componentName'             : componentName,
                'componentId'               : componentId,
                'sectionId'                 : sectionId,
                'modalId'                   : 'buy-modal',
                'modalBodyInclude'          : 'portfolios/transaction/buy',
                'modalSize'                 : 'xl',
                'modalType'                 : 'success',
                'modalHeader'               : true,
                'modalFooter'               : true,
                'modalHeaderCloseButton'    : true,
                'modalEscClose'             : true,
                'modalTitle'                : currencySymbol ~ ' BUY TRANSACTION',
                'modalFooterButtons'        :
                    [
                    'component'                     : component,
                    'componentName'                 : componentName,
                    'componentId'                   : componentId,
                    'parentComponentId'             : parent,
                    'sectionId'                     : sectionId,
                    'buttonType'                    : 'button',
                    'buttons'                       :
                            [
                                'buy-modal-button-save' : [
                                    'title'                   : 'buy',
                                    'type'                    : 'success',
                                    'position'                : 'right',
                                    'icon'                    : 'cog fa-spin',
                                    'iconHidden'              : true
                                ]
                            ]
                    ]
            ]
        )}}
    </div>
    <div>
        {{adminltetags.useTag('modal',
            [
                'component'                 : component,
                'componentName'             : componentName,
                'componentId'               : componentId,
                'sectionId'                 : sectionId,
                'modalId'                   : 'sell-modal',
                'modalBodyInclude'          : 'portfolios/transaction/sell',
                'modalSize'                 : 'xl',
                'modalType'                 : 'warning',
                'modalHeader'               : true,
                'modalFooter'               : true,
                'modalHeaderCloseButton'    : true,
                'modalEscClose'             : true,
                'modalTitle'                : currencySymbol ~ ' SELL TRANSACTION',
                'modalFooterButtons'        :
                    [
                    'component'                     : component,
                    'componentName'                 : componentName,
                    'componentId'                   : componentId,
                    'parentComponentId'             : parent,
                    'sectionId'                     : sectionId,
                    'buttonType'                    : 'button',
                    'buttons'                       :
                            [
                                'sell-modal-button-save' : [
                                    'title'                   : 'sell',
                                    'type'                    : 'warning',
                                    'position'                : 'right',
                                    'icon'                    : 'cog fa-spin',
                                    'iconHidden'              : true
                                ]
                            ]
                    ]
            ]
        )}}
    </div>
{% endif %}
{% set portfolio = escaper.js(json_encode(portfolio, 16)) %}
{% set transactions = escaper.js(json_encode(transactions, 16)) %}
{% set canSellTransactions = escaper.js(json_encode(canSellTransactions, 16)) %}
<script>
/*global paginatedPNotify BazProgress BazContentFields BazHelpers BazContentLoader Pace BazCore dataCollection Swal */
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;

if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}

dataCollectionSection =
    $.extend(dataCollectionSection, {
        '{{componentId}}-{{sectionId}}-id'                          : { },
        '{{componentId}}-{{sectionId}}-name'                        : { },
        '{{componentId}}-{{sectionId}}-user_id'                     : {
            placeholder: "SELECT USER"
        },
        '{{componentId}}-{{sectionId}}-total_value'                 : { },
        '{{componentId}}-{{sectionId}}-invested_amount'             : { },
        '{{componentId}}-{{sectionId}}-profit_loss'                 : { },
        '{{componentId}}-{{sectionId}}-xirr'                        : { },
        '{{componentId}}-{{sectionId}}-description'                 : { },
        '{{componentId}}-{{sectionId}}-transaction_id'              : { },
        '{{componentId}}-{{sectionId}}-type'                        : {
            placeholder: "SELECT TRANSACTION TYPE"
        },
        '{{componentId}}-{{sectionId}}-amc_id'                      : {
            placeholder: "SELECT AMC",
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-amc_id').on('select2:select', function(e) {
                    $('#{{componentId}}-{{sectionId}}-scheme_id').empty().trigger('change');
                    $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', false);
                    dataCollectionSectionForm['funcs']['cleanup']();
                });
            }
        },
        '{{componentId}}-{{sectionId}}-sell_transaction_id'         : {
            placeholder: "SELECT SCHEME TO SELL",
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-sell_transaction_id').on('select2:select', function(e) {
                    var amfi_code = $(e.params.data.element).data()['amfi_code'];

                    var postData = { };
                    postData[$('#security-token').attr('name')] = $('#security-token').val();
                    postData['id'] = dataCollectionSectionForm['vars']['canSellTransactions'][amfi_code]['scheme']['id'];

                    $.post('{{links.url("mf/schemes/getSchemeNav")}}', postData, function(response) {
                        if (response.tokenKey && response.token) {
                            $("#security-token").attr("name", response.tokenKey);
                            $("#security-token").val(response.token);
                        }

                        if (response.responseData.scheme) {
                            dataCollectionSectionForm['funcs']['cleanup']();

                            dataCollectionSectionForm['vars']['scheme'] = response.responseData.scheme;

                            if (response.responseData.scheme.amfi_code) {
                                $('#{{componentId}}-{{sectionId}}-sell-amfi_code').val(response.responseData.scheme.amfi_code);
                                $('#{{componentId}}-{{sectionId}}-sell-available_amount').html(
                                    dataCollectionSectionForm['vars']['currencySymbol'] +
                                    dataCollectionSectionForm['vars']['canSellTransactions'][response.responseData.scheme.amfi_code]['available_amount']
                                );
                                $('#{{componentId}}-{{sectionId}}-sell-available_units').html(
                                    dataCollectionSectionForm['vars']['canSellTransactions'][response.responseData.scheme.amfi_code]['available_units']
                                );
                            }
                            if (response.responseData.scheme.isin) {
                                $('#{{componentId}}-{{sectionId}}-sell-isin').html(response.responseData.scheme.isin);
                            }
                            if (response.responseData.scheme.navs && response.responseData.scheme.navs.latest_nav) {
                                $('#{{componentId}}-{{sectionId}}-sell-latest_nav').html(
                                    dataCollectionSectionForm['vars']['currencySymbol'] + response.responseData.scheme.navs.latest_nav
                                );
                                $('#{{componentId}}-{{sectionId}}-sell-selected_nav').html(
                                    dataCollectionSectionForm['vars']['currencySymbol'] + response.responseData.scheme.navs.latest_nav
                                );
                            }
                            if (response.responseData.scheme.navs && response.responseData.scheme.navs.last_updated) {
                                $('#{{componentId}}-{{sectionId}}-sell-latest_nav_date').html(response.responseData.scheme.navs.last_updated);
                            }
                            if (response.responseData.scheme.navs &&
                                response.responseData.scheme.navs.navs &&
                                Object.keys(response.responseData.scheme.navs.navs).length > 0
                            ) {
                                $('#{{componentId}}-{{sectionId}}-sell-first_nav_date').html(Object.keys(response.responseData.scheme.navs.navs)[0]);
                                dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].config.minDate = Object.keys(response.responseData.scheme.navs.navs)[0];
                                dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].config.maxDate = response.responseData.scheme.navs.last_updated;
                                dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].setDate(response.responseData.scheme.navs.last_updated);
                                $('#{{componentId}}-{{sectionId}}-import').attr('disabled', false);
                            } else {
                                dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].config.minDate = '2000-01-01';
                                dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].setDate('today');
                                dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].config.maxDate = "today";
                                $('#{{componentId}}-{{sectionId}}-import').attr('disabled', true);
                            }
                            $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', false);
                            $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', false);
                            $('#{{componentId}}-{{sectionId}}-sell_all').attr('disabled', false);
                        }

                        if (response.responseCode === 1) {
                            paginatedPNotify('error', {
                                text : response.responseMessage
                            });

                            dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].config.minDate = '2000-01-01';
                            dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].setDate('today');
                            dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].config.maxDate = "today";
                            dataCollectionSectionForm['funcs']['cleanup']();
                            $('#{{componentId}}-{{sectionId}}-import').attr('disabled', false);
                        }
                    }, 'json');
                });
            }
        },
        '{{componentId}}-{{sectionId}}-scheme_id'                   : {
            placeholder: "SELECT SCHEME",
            "ajax"          : {
                url         : "{{links.url('mf/schemes/searchSchemesForAMC')}}",
                dataType    : "json",
                method      : "post",
                data: function(params) {
                    var query = { };
                    query[$('#security-token').attr('name')] = $('#security-token').val();
                    query['amc_id'] = $('#{{componentId}}-{{sectionId}}-amc_id').val();
                    query['search'] = params.term;

                    return query;
                },
                processResults: function(response) {
                    if (response.responseData.schemes) {
                        var schemesData = [];

                        for (var scheme in response.responseData.schemes) {
                            schemesData.push({
                                "id"    : response.responseData.schemes[scheme]["id"],
                                "text"  : response.responseData.schemes[scheme]["name"]
                            });
                        }

                        return {
                            results: schemesData
                        }
                    } else {
                        return {
                            results : []
                        }
                    }
                }
            },
            minimumInputLength : 3,
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-scheme_id').on('select2:select', function(e) {
                    var postData = { };
                    postData[$('#security-token').attr('name')] = $('#security-token').val();
                    postData['id'] = e.params.data.id;

                    $.post('{{links.url("mf/schemes/getSchemeNav")}}', postData, function(response) {
                        if (response.tokenKey && response.token) {
                            $("#security-token").attr("name", response.tokenKey);
                            $("#security-token").val(response.token);
                        }

                        if (response.responseData.scheme) {
                            dataCollectionSectionForm['funcs']['cleanup']();

                            dataCollectionSectionForm['vars']['scheme'] = response.responseData.scheme;

                            if (response.responseData.scheme.isin) {
                                $('#{{componentId}}-{{sectionId}}-buy-isin').html(response.responseData.scheme.isin);
                            }
                            if (response.responseData.scheme.navs && response.responseData.scheme.navs.latest_nav) {
                                $('#{{componentId}}-{{sectionId}}-buy-latest_nav').html(
                                    dataCollectionSectionForm['vars']['currencySymbol'] + response.responseData.scheme.navs.latest_nav
                                );
                            }
                            if (response.responseData.scheme.navs && response.responseData.scheme.navs.last_updated) {
                                $('#{{componentId}}-{{sectionId}}-buy-latest_nav_date').html(response.responseData.scheme.navs.last_updated);
                            }
                            if (response.responseData.scheme.navs &&
                                response.responseData.scheme.navs.navs &&
                                Object.keys(response.responseData.scheme.navs.navs).length > 0
                            ) {
                                $('#{{componentId}}-{{sectionId}}-buy-first_nav_date').html(Object.keys(response.responseData.scheme.navs.navs)[0]);
                                dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].config.minDate = Object.keys(response.responseData.scheme.navs.navs)[0];
                                dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].config.maxDate = response.responseData.scheme.navs.last_updated;
                                $('#{{componentId}}-{{sectionId}}-import').attr('disabled', false);
                            } else {
                                dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].config.minDate = '2000-01-01';
                                dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].setDate('today');
                                dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].config.maxDate = "today";
                                $('#{{componentId}}-{{sectionId}}-import').attr('disabled', true);
                            }
                        }

                        if (response.responseCode === 1) {
                            paginatedPNotify('error', {
                                text : response.responseMessage
                            });

                            dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].config.minDate = '2000-01-01';
                            dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].setDate('today');
                            dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].config.maxDate = "today";
                            dataCollectionSectionForm['funcs']['cleanup']();
                            $('#{{componentId}}-{{sectionId}}-import').attr('disabled', false);
                        }
                    }, 'json');
                });
            }
        },
        '{{componentId}}-{{sectionId}}-buy-date'                    : {
            dateFormat          : "Y-m-d",
            altFormat           : "Y-m-d",
            static              : true,
            maxDate             : "today",
            onChange: function(selectedDates, dateStr, instance) {
                if (dateStr !== '') {
                    $('#{{componentId}}-{{sectionId}}-buy-amount').attr('disabled', false);

                    if (dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-buy-date').val()] &&
                        dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-buy-date').val()]['nav']
                    ) {
                        $('#{{componentId}}-{{sectionId}}-buy-selected_nav')
                            .html(dataCollectionSectionForm['vars']['currencySymbol'] +
                                  dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-buy-date').val()]['nav']
                            );
                    } else {
                        $('#{{componentId}}-{{sectionId}}-buy-selected_nav').html('-');
                    }
                } else {
                    $('#{{componentId}}-{{sectionId}}-buy-amount').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-buy-selected_nav').html('-');
                }
            }
        },
        '{{componentId}}-{{sectionId}}-sell-date'                   : {
            dateFormat          : "Y-m-d",
            altFormat           : "Y-m-d",
            static              : true,
            maxDate             : "today",
            onChange: function(selectedDates, dateStr, instance) {
                if (dateStr !== '') {
                    $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', false);
                    $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', false);
                    $('#{{componentId}}-{{sectionId}}-sell_all').attr('disabled', false);
                    if (dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav']) {
                        $('#{{componentId}}-{{sectionId}}-sell-selected_nav')
                            .html(dataCollectionSectionForm['vars']['currencySymbol'] +
                                  dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav']
                            );
                        var units = dataCollectionSectionForm['vars']['canSellTransactions'][dataCollectionSectionForm['vars']['scheme']['amfi_code']]['available_units'];

                        $('#{{componentId}}-{{sectionId}}-sell-available_amount')
                            .html(dataCollectionSectionForm['vars']['currencySymbol'] +
                                  (dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav'] * units).toFixed(2)
                            );
                    }
                } else {
                    $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-sell_all').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-sell-selected_nav').html('-');
                }
            }
        },
        '{{componentId}}-{{sectionId}}-buy-selected_nav'            : { },
        '{{componentId}}-{{sectionId}}-sell-selected_nav'           : { },
        '{{componentId}}-{{sectionId}}-buy-amount'                  : { },
        '{{componentId}}-{{sectionId}}-sell-amount'                 : { },
        '{{componentId}}-{{sectionId}}-buy-calculated_units'        : { },
        '{{componentId}}-{{sectionId}}-sell-available_amount'       : { },
        '{{componentId}}-{{sectionId}}-sell-units'                  : { },
        '{{componentId}}-{{sectionId}}-sell_all'                    : {
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-sell_all').off();
                $('#{{componentId}}-{{sectionId}}-sell_all').change(function() {
                    if ($(this)[0].checked === true) {
                        $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', true);
                        $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', true);
                        $('#{{componentId}}-{{sectionId}}-sell-units').val(
                            dataCollectionSectionForm['vars']['canSellTransactions'][dataCollectionSectionForm['vars']['scheme']['amfi_code']]['available_units']
                        );
                        var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav'];
                        var amount = ($('#{{componentId}}-{{sectionId}}-sell-units').val() * nav).toFixed(2);
                        $('#{{componentId}}-{{sectionId}}-sell-amount').val(amount);
                    } else {
                        $('#{{componentId}}-{{sectionId}}-sell-amount').attr('disabled', false);
                        $('#{{componentId}}-{{sectionId}}-sell-units').attr('disabled', false);
                        $('#{{componentId}}-{{sectionId}}-sell-units').val('');
                        $('#{{componentId}}-{{sectionId}}-sell-amount').val('');
                    }
                });
            }
        },
        '{{componentId}}-{{sectionId}}-sell-available_units'        : { },
        '{{componentId}}-{{sectionId}}-buy-amc_transaction_id'      : { },
        '{{componentId}}-{{sectionId}}-sell-amc_transaction_id'     : { },
        '{{componentId}}-{{sectionId}}-buy-amfi_code'               : { },
        '{{componentId}}-{{sectionId}}-sell-amfi_code'              : { },
        '{{componentId}}-{{sectionId}}-buy-isin'                    : { },
        '{{componentId}}-{{sectionId}}-sell-isin'                   : { },
        '{{componentId}}-{{sectionId}}-buy-latest_nav'              : { },
        '{{componentId}}-{{sectionId}}-sell-latest_nav'             : { },
        '{{componentId}}-{{sectionId}}-buy-latest_nav_date'         : { },
        '{{componentId}}-{{sectionId}}-sell-latest_nav_date'        : { },
        '{{componentId}}-{{sectionId}}-buy-first_nav_date'          : { },
        '{{componentId}}-{{sectionId}}-sell-first_nav_date'         : { },
        '{{componentId}}-{{sectionId}}-buy-details'                 : { },
        '{{componentId}}-{{sectionId}}-sell-details'                : { },
        '{{componentId}}-{{sectionId}}-form' : {
            rules: {
                '{{componentId}}-{{sectionId}}-name'            : 'required',
                '{{componentId}}-{{sectionId}}-user_id'         : 'required',
            },
            messages: {
                '{{componentId}}-{{sectionId}}-name'            : 'Please enter name',
                '{{componentId}}-{{sectionId}}-user_id'         : 'Please select user',
            }
        }
    });

dataCollectionSectionForm['vars'] = { };
dataCollectionSectionForm['vars']['portfolio'] = JSON.parse('{{portfolio}}');
dataCollectionSectionForm['vars']['transactions'] = JSON.parse('{{transactions}}');
dataCollectionSectionForm['vars']['canSellTransactions'] = JSON.parse('{{canSellTransactions}}');
dataCollectionSectionForm['vars']['currencySymbol'] = '{{currencySymbol}}';
dataCollectionSectionForm['vars']['sellInput'] = 'amount';
dataCollectionSectionForm['vars']['scheme'] = { };
dataCollectionSectionForm['funcs'] = { };
dataCollectionSectionForm['funcs']['cleanup'] = function() {
    $('#{{componentId}}-{{sectionId}}-import').attr('disabled', true);
    $('#{{componentId}}-{{sectionId}}-buy-isin').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-latest_nav').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-latest_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-first_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-amount').val('');
    $('#{{componentId}}-{{sectionId}}-buy-calculated_units').html('-');
    $('#{{componentId}}-{{sectionId}}-buy-amc_transaction_id').val('');
    dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].config.minDate = '2000-01-01';
    dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].config.maxDate = 'today';
    dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].clear();
    $('#{{componentId}}-{{sectionId}}-sell-isin').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-latest_nav').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-latest_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-first_nav_date').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-amount').val('');
    $('#{{componentId}}-{{sectionId}}-sell-units').val('');
    $('#{{componentId}}-{{sectionId}}-sell-available_amount').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-available_units').html('-');
    $('#{{componentId}}-{{sectionId}}-sell-amc_transaction_id').val('');
    $('#{{componentId}}-{{sectionId}}-sell_all')[0].checked = false;
    dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].config.minDate = '2000-01-01';
    dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].config.maxDate = 'today';
    dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].clear();
    dataCollectionSectionForm['vars']['scheme'] = { };
}

dataCollectionSectionForm['funcs']['init'] = function() {
    var swalSound = window['dataCollection'].env.sounds.swalSound;

    setTimeout(function(){
        if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-transactions-table')) {
            $('#{{componentId}}-{{sectionId}}-transactions-table').DataTable({
                columns: [
                    {orderable: false, visible: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false},
                    {orderable: false}
                ],
                order: false,
                lengthMenu: [
                    [50, 100, -1],
                    [50, 100, 'All']
                ]
            });
        }
    }, 1000);

    $('#{{componentId}}-{{sectionId}}-recalculate').off();
    $('#{{componentId}}-{{sectionId}}-recalculate').click(function(e) {
        e.preventDefault();

        // $(this).attr('disabled', true);
        $(this).children('i').attr('hidden', false);

        var postData = { };
        postData[$('#security-token').attr('name')] = $('#security-token').val();
        postData['portfolio_id'] = $('#{{componentId}}-{{sectionId}}-id').val();

        $.post('{{links.url("mf/portfolios/recalculatePortfolioTransactions")}}', postData, function(response) {
            $('#{{componentId}}-{{sectionId}}-recalculate').attr('disabled', false);
            $('#{{componentId}}-{{sectionId}}-recalculate').children('i').attr('hidden', true);

            if (response.tokenKey && response.token) {
                $("#security-token").attr("name", response.tokenKey);
                $("#security-token").val(response.token);
            }

            if (response.responseCode === 0) {
                paginatedPNotify('success', {
                    text : response.responseMessage
                });

                dataCollectionSectionForm['funcs']['browse']();
            } else if (response.responseCode === 1) {
                paginatedPNotify('error', {
                    text : response.responseMessage
                });
            }
        }, 'json');
    });

    $('#{{componentId}}-{{sectionId}}-buy,' +
      '#{{componentId}}-{{sectionId}}-sell'
    ).off();
    $('#{{componentId}}-{{sectionId}}-buy,' +
      '#{{componentId}}-{{sectionId}}-sell'
    ).click(function(e) {
        e.preventDefault();

        if ($(this)[0].id === '{{componentId}}-{{sectionId}}-buy') {
            $('#{{componentId}}-{{sectionId}}-buy-modal').modal('show');

            $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').off();
            $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').click(function(e) {
                e.preventDefault();

                processTransaction('buy');
            });
        } else if ($(this)[0].id === '{{componentId}}-{{sectionId}}-sell') {
            $('#{{componentId}}-{{sectionId}}-sell-modal').modal('show');

            $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').off();
            $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').click(function(e) {
                e.preventDefault();

                processTransaction('sell');
            });
        }
    });

    $('#{{componentId}}-{{sectionId}}-import').off();
    $('#{{componentId}}-{{sectionId}}-import').click(function(e) {
        e.preventDefault();

        var thisButton = $(this);
        // $(thisButton).addClass('disabled');
        $(thisButton).children('i').attr('hidden', false);

        var postData = { };
        postData[$('#security-token').attr('name')] = $('#security-token').val();
        postData['get_all_navs'] = true;
        postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-scheme_id').val();

        $.post('{{links.url("mf/extractdata/getAllNavData")}}', postData, function(response) {
            $(thisButton).removeClass('disabled');
            $(thisButton).children('i').attr('hidden', true);

            if (response.responseCode == 0) {
                paginatedPNotify('success', 'Import success. Please reselect the scheme.');
            } else {
                paginatedPNotify('error', response.responseMessage);
            }

            $('#{{componentId}}-{{sectionId}}-scheme_id').empty().trigger('change');

            dataCollectionSectionForm['funcs']['cleanup']();

            if (response.tokenKey && response.token) {
                $("#security-token").attr("name", response.tokenKey);
                $("#security-token").val(response.token);
            }
        }, 'json');
    });

    function processTransaction(task = '', update = false, remove = false) {
        var postData = { };

        postData[$('#security-token').attr('name')] = $('#security-token').val();
        if (remove) {
            postData['id'] = $('#{{componentId}}-{{sectionId}}-transaction_id').val();
        } else {
            if (update) {
                postData['id'] = $('#{{componentId}}-{{sectionId}}-transaction_id').val();
            }
            postData['user_id'] = $('#{{componentId}}-{{sectionId}}-user_id').val();
            postData['portfolio_id'] = $('#{{componentId}}-{{sectionId}}-id').val();
            postData['amc_id'] = $('#{{componentId}}-{{sectionId}}-' + task + '-amc_id').val();
            postData['scheme_id'] = $('#{{componentId}}-{{sectionId}}-scheme_id').val();
            postData['amfi_code'] = $('#{{componentId}}-{{sectionId}}-' + task + '-amfi_code').val();
            postData['date'] = $('#{{componentId}}-{{sectionId}}-' + task + '-date').val();
            if (task === 'sell') {
                if (dataCollectionSectionForm['vars']['sellInput'] === 'amount') {
                    postData['amount'] = $('#{{componentId}}-{{sectionId}}-' + task + '-amount').val();
                } else if (dataCollectionSectionForm['vars']['sellInput'] === 'units') {
                    postData['units'] = $('#{{componentId}}-{{sectionId}}-' + task + '-units').val();
                }
                postData['sell_all'] = $('#{{componentId}}-{{sectionId}}-sell_all')[0].checked;
            } else {
                postData['amount'] = $('#{{componentId}}-{{sectionId}}-' + task + '-amount').val();
            }
            postData['amc_transaction_id'] = $('#{{componentId}}-{{sectionId}}-' + task + '-amc_transaction_id').val();
            postData['type'] = task;
            if (task === 'buy') {
                postData['status'] = 'open';
            }
            postData['details'] = $('#{{componentId}}-{{sectionId}}-' + task + '-details').val();
        }

        if (($('#{{componentId}}-{{sectionId}}-' + task + '-amount') && $('#{{componentId}}-{{sectionId}}-' + task + '-amount').hasClass('is-invalid')) ||
            ($('#{{componentId}}-{{sectionId}}-' + task + '-units') && $('#{{componentId}}-{{sectionId}}-' + task + '-units').hasClass('is-invalid'))
        ) {
            paginatedPNotify('error', {text : 'Fix amount/units errors.'});

            return false;
        }

        if (postData['date'] === '' && !remove) {
            $('#{{componentId}}-{{sectionId}}-' + task + '-date').siblings('input').addClass('is-invalid');
            $('#{{componentId}}-{{sectionId}}-' + task + '-date').siblings('input').focus(function() {
                $(this).removeClass('is-invalid');
            });
        } else if (postData['amount'] === '' && !remove) {
            $('#{{componentId}}-{{sectionId}}-' + task + '-amount').addClass('is-invalid');
            $('#{{componentId}}-{{sectionId}}-' + task + '-amount').focus(function() {
                $(this).removeClass('is-invalid');
            });
        } else {
            // $('#{{componentId}}-{{sectionId}}-modal-button-save').attr('disabled', true);
            // $('#{{componentId}}-{{sectionId}}-modal-button-save').children('i').attr('hidden', false);

            var url;
            if (remove) {
                url = '{{links.url("mf/portfolios/removeTransaction")}}';
            } else {
                url = '{{links.url("mf/portfolios/addTransaction")}}';
                if (update) {
                    url = '{{links.url("mf/portfolios/updateTransaction")}}';
                }
            }

            $.post(url, postData, function(response) {
                if (response.tokenKey && response.token) {
                    $('#security-token').attr('name', response.tokenKey);
                    $('#security-token').val(response.token);
                }

                if (response.responseCode == 0) {
                    paginatedPNotify('success', {text : response.responseMessage});

                    if (!remove) {
                        $('#{{componentId}}-{{sectionId}}-transaction-modal').modal('hide');
                        $('.modal-backdrop').remove();
                        $('#body').removeClass('modal-open');
                    }

                    dataCollectionSectionForm['funcs']['browse']();
                } else {
                    paginatedPNotify('error', {text : response.responseMessage});
                }

                $('#{{componentId}}-{{sectionId}}-modal-button-save').attr('disabled', false);
                $('#{{componentId}}-{{sectionId}}-modal-button-save').children('i').attr('hidden', true);
            }, 'json');
        }
    }

    $('.viewTransaction').off();
    $('.viewTransaction').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var id = idArr[idArr.length - 1];

            if (dataCollectionSectionForm['vars']['transactions'][id]) {
                $('#{{componentId}}-{{sectionId}}-transaction_id').val(dataCollectionSectionForm['vars']['transactions'][id]['id']);
                if (dataCollectionSectionForm['vars']['transactions'][id]['type'] === 'buy') {
                    $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').attr('hidden', true);
                    $('#{{componentId}}-{{sectionId}}-buy-modal').modal('show');
                } else if (dataCollectionSectionForm['vars']['transactions'][id]['type'] === 'sell') {
                    $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').attr('hidden', true);
                    $('#{{componentId}}-{{sectionId}}-sell-modal').modal('show');
                }

                $('#{{componentId}}-{{sectionId}}-details').val(dataCollectionSectionForm['vars']['transactions'][id]['details']);
            }
        });
    });

    $('.editTransaction').off();
    $('.editTransaction').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var idArr = $(this)[0].id.split('-');
            var id = idArr[idArr.length - 1];

            if (dataCollectionSectionForm['vars']['transactions'][id]) {
                $('#{{componentId}}-{{sectionId}}-transaction_id').val(dataCollectionSectionForm['vars']['transactions'][id]['id']);
                if (dataCollectionSectionForm['vars']['transactions'][id]['type'] === 'buy') {
                    $('#{{componentId}}-{{sectionId}}-buy-date').val(dataCollectionSectionForm['vars']['transactions'][id]['date']);
                    dataCollectionSection["{{componentId}}-{{sectionId}}-buy-date"]['flatpickr'].setDate(dataCollectionSectionForm['vars']['transactions'][id]['date'])
                    $('#{{componentId}}-{{sectionId}}-buy-amount').val(dataCollectionSectionForm['vars']['transactions'][id]['amount']);

                    $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').attr('hidden', false);
                    $('#{{componentId}}-{{sectionId}}-buy-modal').modal('show');

                    $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').off();
                    $('#{{componentId}}-{{sectionId}}-buy-modal-button-save').click(function(e) {
                        e.preventDefault();

                        processTransaction('buy', true);
                    });
                } else if (dataCollectionSectionForm['vars']['transactions'][id]['type'] === 'sell') {
                    $('#{{componentId}}-{{sectionId}}-sell-date').val(dataCollectionSectionForm['vars']['transactions'][id]['date']);
                    dataCollectionSection["{{componentId}}-{{sectionId}}-sell-date"]['flatpickr'].setDate(dataCollectionSectionForm['vars']['transactions'][id]['date'])
                    $('#{{componentId}}-{{sectionId}}-sell-amount').val(dataCollectionSectionForm['vars']['transactions'][id]['amount']);

                    $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').attr('hidden', false);
                    $('#{{componentId}}-{{sectionId}}-sell-modal').modal('show');

                    $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').off();
                    $('#{{componentId}}-{{sectionId}}-sell-modal-button-save').click(function(e) {
                        e.preventDefault();

                        processTransaction('sell', true);
                    });
                }

                $('#{{componentId}}-{{sectionId}}-details').val(dataCollectionSectionForm['vars']['transactions'][id]['details']);
            }

        });
    });

    $('.removeTransaction').off();
    $('.removeTransaction').each(function(rowId, row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            Swal.fire({
                title                       : '<span class="text-danger"> Remove transaction?</span>',
                icon                        : 'question',
                background                  : 'rgba(0,0,0,.8)',
                backdrop                    : 'rgba(0,0,0,.6)',
                buttonsStyling              : false,
                confirmButtonText           : 'Remove',
                customClass                 : {
                    'confirmButton'             : 'btn btn-danger text-uppercase',
                    'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
                },
                showCancelButton            : true,
                keydownListenerCapture      : true,
                allowOutsideClick           : true,
                allowEscapeKey              : true,
                didOpen                     : function() {
                    swalSound.play();
                }
            }).then((result) => {
                if (result.value) {
                    var idArr = $(this)[0].id.split('-');
                    var id = idArr[idArr.length - 1];

                    if (dataCollectionSectionForm['vars']['transactions'][id]) {
                        $('#{{componentId}}-{{sectionId}}-transaction_id').val(dataCollectionSectionForm['vars']['transactions'][id]['id']);
                    }

                    processTransaction('', false, true);
                }
            });
        });
    });

    $('#{{componentId}}-{{sectionId}}-buy-modal, #{{componentId}}-{{sectionId}}-sell-modal').on('hide.bs.modal', function (e) {
        $('#{{componentId}}-{{sectionId}}-scheme_id').empty().trigger('change');
        $('#{{componentId}}-{{sectionId}}-scheme_id').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-amc_id').val(0).trigger('change');
        $('#{{componentId}}-{{sectionId}}-sell_transaction_id').val(0).trigger('change');
        dataCollectionSectionForm['funcs']['cleanup']();
    });

    $('#{{componentId}}-{{sectionId}}-buy-amount').keyup(function() {
        if ($('#{{componentId}}-{{sectionId}}-buy-amount').val() !== '') {
            var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-buy-date').val()]['nav'];
            var units = ($('#{{componentId}}-{{sectionId}}-buy-amount').val() / nav).toFixed(3);
            $('#{{componentId}}-{{sectionId}}-buy-calculated_units').html(units);
        } else {
            $('#{{componentId}}-{{sectionId}}-buy-calculated_units').html('-');
        }
    });
    $('#{{componentId}}-{{sectionId}}-sell-amount').keyup(function() {
        if ($('#{{componentId}}-{{sectionId}}-sell-amount').val() !== '') {
            var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav'];
            var units = ($('#{{componentId}}-{{sectionId}}-sell-amount').val() / nav).toFixed(3);
            $('#{{componentId}}-{{sectionId}}-sell-units').val(units);

            if (units > dataCollectionSectionForm['vars']['canSellTransactions'][dataCollectionSectionForm['vars']['scheme']['amfi_code']]['available_units']) {
                $('#{{componentId}}-{{sectionId}}-sell-units').addClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').addClass('is-invalid');
            } else {
                $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
            }
        } else {
            $('#{{componentId}}-{{sectionId}}-sell-units').val('');
        }
        dataCollectionSectionForm['vars']['sellInput'] = 'amount';
    });
    $('#{{componentId}}-{{sectionId}}-sell-units').keyup(function() {
        if ($('#{{componentId}}-{{sectionId}}-sell-units').val() !== '') {
            var nav = dataCollectionSectionForm['vars']['scheme']['navs']['navs'][$('#{{componentId}}-{{sectionId}}-sell-date').val()]['nav'];
            var amount = ($('#{{componentId}}-{{sectionId}}-sell-units').val() * nav).toFixed(2);
            $('#{{componentId}}-{{sectionId}}-sell-amount').val(amount);

            if (parseFloat(amount) >
                (nav * dataCollectionSectionForm['vars']['canSellTransactions'][dataCollectionSectionForm['vars']['scheme']['amfi_code']]['available_units']).toFixed(2)
            ) {
                $('#{{componentId}}-{{sectionId}}-sell-units').addClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').addClass('is-invalid');
            } else {
                $('#{{componentId}}-{{sectionId}}-sell-units').removeClass('is-invalid');
                $('#{{componentId}}-{{sectionId}}-sell-amount').removeClass('is-invalid');
            }
        } else {
            $('#{{componentId}}-{{sectionId}}-sell-amount').val('');
        }
        dataCollectionSectionForm['vars']['sellInput'] = 'units';
    });
}

dataCollectionSectionForm['funcs']['browse'] = function() {
    BazContentLoader.loadAjax($('#{{componentId}}-{{sectionId}}-portfolios-link'), {
        ajaxBefore                      : function () {
                                            Pace.restart();
                                            $("#baz-content").empty();
                                            $("#loader").attr('hidden', false);
                                        },
        ajaxFinished                    : function () {
                                            BazCore.updateBreadcrumb();
                                            $("#loader").attr('hidden', true);
                                        },
        ajaxError                       : function () {
                                            $("#loader").attr('hidden', true);
                                            BazCore.updateBreadcrumb();
                                        }
    });
}

$(document).ready(function() {
    dataCollectionSectionForm['funcs']['init']();
});
</script>